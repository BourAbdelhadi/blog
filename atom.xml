<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>ly你个c</title>
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://drakeleung.github.io/blog/"/>
  <updated>2016-09-23T10:27:48.000Z</updated>
  <id>http://drakeleung.github.io/blog/</id>
  
  <author>
    <name>ly你个c</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>让我们一起来学习 RxJS</title>
    <link href="http://drakeleung.github.io/blog/2016/09/21/Let-Us-Learn-RxJS/"/>
    <id>http://drakeleung.github.io/blog/2016/09/21/Let-Us-Learn-RxJS/</id>
    <published>2016-09-20T16:02:04.000Z</published>
    <updated>2016-09-23T10:27:48.000Z</updated>
    
    <content type="html"><![CDATA[<p>这是一篇 RxJS 初学者教程。</p>
<h2 id="what-is-rxjs"><a class="header-anchor" href="#what-is-rxjs">#</a>What Is RxJS</h2>
<p>通过<strong>阅读<a href="http://reactivex.io/rxjs/manual/overview.html" target="_blank" rel="external">官方文档</a></strong>，不难得出：RxJS 可以很好<strong>解决异步和事件组合的问题</strong>。</p>
<p>这个时候我就有疑问了，异步问题不是用 Promise ( async/await ) 就好了吗？<br>
至于事件，配合框架 ( React, Vue, Angular2 等 ) 的话不也很容易解决吗？<img class="emoji" draggable="false" alt="😮" src="https://twemoji.maxcdn.com/2/72x72/1f62e.png"></p>
<p>不管怎样, 让我们先看个 Hello World 吧。(我要看 <a href="http://jsbin.com/suguho/edit?js,output" target="_blank" rel="external">DEMO</a> )</p>
<h3 id="rx-s-hello-world"><a class="header-anchor" href="#rx-s-hello-world">#</a>Rx’s Hello World</h3>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// auto-complete</span></div><div class="line"><span class="keyword">const</span> Observable = Rx.Observable</div><div class="line"><span class="keyword">const</span> input = <span class="built_in">document</span>.querySelector(<span class="string">'input'</span>)</div><div class="line"></div><div class="line"><span class="keyword">const</span> search$ = Observable.fromEvent(input, <span class="string">'input'</span>)</div><div class="line">  .map(e =&gt; e.target.value)</div><div class="line">  .filter(value =&gt; value.length &gt;= <span class="number">1</span>)</div><div class="line">  .throttleTime(<span class="number">100</span>)</div><div class="line">  .distinctUntilChanged()</div><div class="line">  .switchMap(term =&gt; Observable.fromPromise(wikiIt(term)))</div><div class="line">  .subscribe(</div><div class="line">    x =&gt; renderSearchResult(x),</div><div class="line">    err =&gt; <span class="built_in">console</span>.error(err)</div><div class="line">  )</div></pre></td></tr></table></figure>
<p>上面的代码做了以下事情：</p>
<ul>
<li>监听 <code>input</code> 元素的 <code>input</code> 事件</li>
<li>一旦发生，把事件对象 <code>e</code> 映射成 <code>input</code> 元素的值</li>
<li>接着过滤掉值长度小于 <code>1</code> 的</li>
<li>并且还设置了一个 <code>throttle</code> (节流器)，两次输入间隔不超过 <code>100</code> 毫秒为有效输入</li>
<li>如果该值和过去最新的值相等的话，忽略他</li>
<li>最后，拿到值便调用 Wikipedia 的一个 API</li>
<li>最后的最后，需要 <code>subscribe</code> 才能拿到 API 返回的数据</li>
</ul>
<p>是不是看起来就觉得很 cool ，好想学！<img class="emoji" draggable="false" alt="😚" src="https://twemoji.maxcdn.com/2/72x72/1f61a.png"><br>
短短几行代码就完成了一个 auto-complete 组件。</p>
<h2 id="how-it-works"><a class="header-anchor" href="#how-it-works">#</a>How It Works</h2>
<p>那上面的代码是什么意思？<br>
RxJS 到底是如何工作的？如何解决异步组合问题的？</p>
<h3 id="observable"><a class="header-anchor" href="#observable">#</a>Observable</h3>
<p>Rx 提供了一种叫 <strong>Observable</strong> 的数据类型，兼容 ECMAScript 的 <a href="https://github.com/zenparsing/es-observable" target="_blank" rel="external">Observable Spec Proposal</a> 草案标准。他是 Rx 最核心的数据类型，结合了 <a href="https://en.wikipedia.org/wiki/Observer_pattern" target="_blank" rel="external">Observer Pattern</a>，<a href="https://en.wikipedia.org/wiki/Iterator_pattern" target="_blank" rel="external">Iterator Pattern</a> 。</p>
<p>那到底什么是 Observable ？</p>
<blockquote>
<p>Observable 其实就是一个<strong>异步的数组</strong>。<em>( ===&gt; <a href="https://medium.com/@andrestaltz/2-minute-introduction-to-rx-24c8ca793877#.1q1q2mwgq" target="_blank" rel="external">2 minute introduction to rx</a> )</em></p>
</blockquote>
<p>不妨想像一下，<img class="emoji" draggable="false" alt="⭐" src="https://twemoji.maxcdn.com/2/72x72/2b50.png"> <strong>数组 + 时间轴 == Observable</strong> <img class="emoji" draggable="false" alt="⭐" src="https://twemoji.maxcdn.com/2/72x72/2b50.png"> 。</p>
<p>数组元素的值是未来某个时间点 <em>emit</em> (产生)的，但是我们并不关心这个时间点，因为利用了「观察者模式」<em>subscribe</em> (订阅)了这个数组，只要他 <em>emit</em> 了值，就会自动 <em>push</em> 给我们。</p>
<p>我们再用图来表示一下的话：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">--a---b-c--d-----e--|--&gt;</div></pre></td></tr></table></figure>
<p>这种图叫做 <a href="http://reactivex.io/rxjs/manual/overview.html#marble-diagrams" target="_blank" rel="external">marble diagram</a> 。<br>
我们可以把 ASCII 的 marble 图转成 SVG 的：<a href="https://jsbin.com/vumepol/1/edit?js,output" target="_blank" rel="external">ASCII -&gt; SVG</a> 。</p>
<p><code>-</code> 表示时间轴，<code>a</code> ~ <code>e</code> 表示 emit 的值，<code>|</code> 则表示这个 stream 已经结束了。<br>
比方说，<code>click</code> 事件用上图来表示：<code>a</code> 表示第 1 次点击，<code>b</code> 表示第 2 次点击，如此类推。</p>
<p>如果你觉得 Observable 这个名字不够形象不够 cool 的话，你可把他叫做 <a href="https://gist.github.com/staltz/868e7e9bc2a7b8c1f754#reactive-programming-is-programming-with-asynchronous-data-streams" target="_blank" rel="external">stream</a> ，因为他的 marble 图就像 steam 一样。所以啊，下面我都会把 <em>Observable</em> 称作 <em>stream</em> 。<img class="emoji" draggable="false" alt="✌️" src="https://twemoji.maxcdn.com/2/72x72/270c.png"></p>
<h3 id="operators"><a class="header-anchor" href="#operators">#</a>Operators</h3>
<p>那么，我们怎么对 stream 进行操作呢？怎么把多个 stream 组合在一起呢？</p>
<p>我们前面不是说了「 Observable 其实就是<em>异步数组</em>」吗？在 JavaScript 里的数组不是有很多内置的方法吗？比如 <code>map</code>, <code>filter</code>, <code>reduce</code> 等等。类似地，Observable 也有自己的方法，也就是所谓的 <a href="http://reactivex.io/rxjs/manual/overview.html#operators" target="_blank" rel="external">operator</a> 。比如上面 <a href="#rx-s-hello-world">Rx’s Hello World</a> 例子中的 <code>map</code>, <code>filter</code>, <code>throttleTime</code>, <code>distinctUntilChanged</code> 等等很多很有用的 operator 。</p>
<p>面对 RxJS 那么多 operator ，我们要怎么学习呢？很简单：<img class="emoji" draggable="false" alt="😀" src="https://twemoji.maxcdn.com/2/72x72/1f600.png"></p>
<blockquote>
<p><a href="http://reactivex.io/rxjs/manual/overview.html#categories-of-operators" target="_blank" rel="external">分类别</a> + <a href="http://reactivex.io/rxjs/manual/overview.html#marble-diagrams" target="_blank" rel="external">画 marble 图</a> + <a href="https://www.learnrxjs.io/operators/" target="_blank" rel="external">看例子</a> + <a href="http://reactivex.io/rxjs/manual/overview.html#choose-an-operator" target="_blank" rel="external">选</a></p>
</blockquote>
<p>现在，就让我们画出上面 Hello World 例子的 marble 图。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> search$ = Observable.fromEvent(input, <span class="string">'input'</span>)</div><div class="line">  .map(e =&gt; e.target.value)</div><div class="line">  .filter(value =&gt; value.length &gt;= <span class="number">1</span>)</div><div class="line">  .throttleTime(<span class="number">100</span>)</div><div class="line">  .distinctUntilChanged()</div><div class="line">  .switchMap(term =&gt; Observable.fromPromise(wikiIt(term)))</div><div class="line">  .subscribe(</div><div class="line">    x =&gt; renderSearchResult(x),</div><div class="line">    err =&gt; <span class="built_in">console</span>.error(err)</div><div class="line">  )</div></pre></td></tr></table></figure>
<p>假设输入了 5 次，每次输入的值一次为：<code>a</code>, <code>ab</code>, <code>c</code>, <code>d</code>, <code>c</code> ，并且第 3 次输入的 <code>c</code> 和第 4 次的 <code>d</code> 的时间间隔少于 <code>100ms</code> ：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">---i--i---i-i-----i---|--&gt; (input)</div><div class="line">        map</div><div class="line"></div><div class="line">---a--a---c-d-----c---|--&gt;</div><div class="line">      b</div><div class="line">        filter</div><div class="line"></div><div class="line">---a--a---c-d-----c---|--&gt;</div><div class="line">      b</div><div class="line">      throttleTime</div><div class="line"></div><div class="line">---a--a---c-------c---|--&gt;</div><div class="line">      b</div><div class="line">  distinctUntilChanged</div><div class="line"></div><div class="line">---a--a---c----------|--&gt;</div><div class="line">      b</div><div class="line">    switchMap</div><div class="line"></div><div class="line">---x--y---z----------|--&gt;</div></pre></td></tr></table></figure>
<p>如果我告诉你学习 <strong>RxJS 的捷径是「学会看和画 marble 图」</strong>，你信还是不信？<img class="emoji" draggable="false" alt="😱" src="https://twemoji.maxcdn.com/2/72x72/1f631.png"></p>
<h2 id="learn-by-doing"><a class="header-anchor" href="#learn-by-doing">#</a>Learn By Doing</h2>
<p>现在，就让我们结合上面的知识，来实现一个简单的 canvas 画板。</p>
<p>根据 canvas 的 <a href="http://devdocs.io/dom/canvasrenderingcontext2d/moveto" target="_blank" rel="external">API</a> ，我们需要知道两个点的坐标，这样才能画出一条线。</p>
<h3 id="step-1"><a class="header-anchor" href="#step-1">#</a>Step 1</h3>
<p><em>(我要看 <a href="https://jsfiddle.net/DrakeLeung/a7h4wwcy/" target="_blank" rel="external">DEMO</a> )</em></p>
<p>那么，现在我们需要做的是<strong>创建</strong>一个关于鼠标移动的 stream 。于是，我们<strong>去文档找对应的 operator 类别</strong>，也就是 <a href="http://jsbin.com/gakosun/edit?js,console,output" target="_blank" rel="external">Creation Operators</a> ，然后得到  <a href="http://reactivex.io/rxjs/class/es6/Observable.js~Observable.html#static-method-fromEvent" target="_blank" rel="external">fromEvent</a> 。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> canvas = <span class="built_in">document</span>.querySelector(<span class="string">'canvas'</span>)</div><div class="line"></div><div class="line"><span class="keyword">const</span> move$ = Rx.Observable.fromEvent(canvas, <span class="string">'mousemove'</span>)</div></pre></td></tr></table></figure>
<p>对应的 marble 图：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">--m1---m1-m2--m3----m4---|--&gt;  (mousemove)</div></pre></td></tr></table></figure>
<p>接着，我们需要拿到每次鼠标移动时的坐标。也就是说：需要<strong>变换</strong> stream 。<br>
对应类别的 operator 文档：<a href="http://reactivex.io/rxjs/manual/overview.html#transformation-operators" target="_blank" rel="external">Transformation Operators</a> ===&gt; <a href="http://reactivex.io/rxjs/class/es6/Observable.js~Observable.html#instance-method-map" target="_blank" rel="external">map</a> 。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> move$ = Rx.Observable.fromEvent(canvas, <span class="string">'mousemove'</span>)</div><div class="line">  .map(e =&gt; (&#123; x: e.offsetX, y: e.offsetX &#125;))</div></pre></td></tr></table></figure>
<p>此时的 marble 图：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">--m1---m2-m3--m4----m5---|--&gt;  (mousemove)</div><div class="line">        map</div><div class="line">--x1---x2-x3--x4----x5---|--&gt;  (点坐标)</div></pre></td></tr></table></figure>
<p>然后，怎么拿到两个点的坐标呢？我们需要再<strong>变换</strong>一下 stream 。<br>
对应类别的 operator 文档：<a href="http://reactivex.io/rxjs/manual/overview.html#transformation-operators" target="_blank" rel="external">Transformation Operators</a> ===&gt; <a href="http://reactivex.io/rxjs/class/es6/Observable.js~Observable.html#instance-method-bufferCount" target="_blank" rel="external">bufferCount</a> 。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> move$ = Rx.Observable.fromEvent(canvas, <span class="string">'mousemove'</span>)</div><div class="line">  .map(e =&gt; (&#123; x: e.offsetX, y: e.offsetY &#125;))</div><div class="line">  .bufferCount(<span class="number">2</span>)</div></pre></td></tr></table></figure>
<p>marble 图：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">--m1---m2-m3--m4----m5---|--&gt;  (mousemove)</div><div class="line">        map</div><div class="line"></div><div class="line">--x1---x2-x3--x4----x5---|--&gt;  (点坐标)</div><div class="line">      bufferCount(2)</div><div class="line"></div><div class="line">-------x1-----x3----x5---|---&gt; (两点坐标)</div><div class="line">       x2     x4</div></pre></td></tr></table></figure>
<p>然后你会发现，此时画出来的<a href="https://jsfiddle.net/DrakeLeung/a7h4wwcy/" target="_blank" rel="external">线段是不连续的</a>。为什么？我也不知道！！<br>
那就让我们看看别人是怎么写的吧：<a href="https://github.com/Reactive-Extensions/RxJS/blob/master/examples/canvaspaint/canvaspaint.js" target="_blank" rel="external">canvas paint</a> 。</p>
<h3 id="step-2"><a class="header-anchor" href="#step-2">#</a>Step 2</h3>
<p><em>(我要看 <a href="https://jsfiddle.net/DrakeLeung/vj368qy7/1/" target="_blank" rel="external">DEMO</a> )</em></p>
<p>换了一种思路，并没有<strong>变换</strong> stream ，而是把两个 stream <strong>组合</strong>在一起。<br>
查看文档  <a href="http://reactivex.io/rxjs/manual/overview.html#combination-operators" target="_blank" rel="external">Combination Operators</a> ===&gt; <a href="http://reactivex.io/rxjs/class/es6/Observable.js~Observable.html#static-method-zip" target="_blank" rel="external">zip</a> 。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> move$ = Rx.Observable.fromEvent(canvas, <span class="string">'mousemove'</span>)</div><div class="line">  .map(e =&gt; (&#123; x: e.offsetX, y: e.offsetY &#125;))</div><div class="line"></div><div class="line"><span class="keyword">const</span> diff$ = move$</div><div class="line">  .zip(move$.skip(<span class="number">1</span>), (first, sec) =&gt; ([ first, sec ]))</div></pre></td></tr></table></figure>
<p>此时的 marble 图：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">--x1---x2-x3--x4----x5---|--&gt;  (move$)</div><div class="line">        skip(1)</div><div class="line">-------x2-x3--x4----x5---|--&gt;  </div><div class="line"></div><div class="line"></div><div class="line">--x1---x2-x3--x4----x5---|--&gt;  (move$)</div><div class="line">-------x2-x3--x4----x5---|--&gt;  </div><div class="line">        zip</div><div class="line"></div><div class="line">-------x1-x2--x3----x4---|--&gt;  (diff$)</div><div class="line">       x2 x3  x4    x5</div></pre></td></tr></table></figure>
<p>这样一来，<code>diff$</code> emit 的值就依次为 <code>(x1, x2)</code>, <code>(x2, x3)</code>，<code>(x3, x4)</code> ……<br>
现在，鼠标移动的时候，就可以<a href="https://jsfiddle.net/DrakeLeung/vj368qy7/1/" target="_blank" rel="external">画出美丽的线条</a>。</p>
<h3 id="step-3"><a class="header-anchor" href="#step-3">#</a>Step 3</h3>
<p><em>(我要看 <a href="https://jsfiddle.net/DrakeLeung/vj368qy7/2/" target="_blank" rel="external">DEMO</a> )</em></p>
<p>就在此时我恍然大悟，终于知道前面用 <code>bufferCount</code> 为什么不行了。我们不妨来比较一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">-------x1-----x3----x5---|---&gt; (bufferCount)</div><div class="line">       x2     x4</div><div class="line"></div><div class="line">-------x1-x2--x3----x4---|--&gt;  (diff$)</div><div class="line">       x2 x3  x4    x5</div></pre></td></tr></table></figure>
<p><code>bufferCount</code> emit 的值依次为：<code>(x1, x2)</code>， <code>(x3, x4)</code> …… <code>x2</code> 和 <code>x3</code> 之间是有间隔的。这就是为什么线段会不连续的原因。</p>
<p>然后看 <a href="http://reactivex.io/rxjs/class/es6/Observable.js~Observable.html#instance-method-bufferCount" target="_blank" rel="external">bufferCount</a> 文档的话，你会发现<strong>可以使用 <code>bufferCount(2, 1)</code> 实现同样的效果</strong>。这样的话，我们就不需要使用 <code>zip</code> 来组合两个 stream 了。Cool ~ <img class="emoji" draggable="false" alt="😎" src="https://twemoji.maxcdn.com/2/72x72/1f60e.png"></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> move$ = Rx.Observable.fromEvent(canvas, <span class="string">'mousemove'</span>)</div><div class="line">  .map(e =&gt; (&#123; x: e.offsetX, y: e.offsetX &#125;))</div><div class="line">  .bufferCount(<span class="number">2</span>, <span class="number">1</span>)</div></pre></td></tr></table></figure>
<p>此时的 marble 图：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">--m1---m2-m3--m4----m5---|--&gt;  (mousemove)</div><div class="line">        map</div><div class="line"></div><div class="line">--x1---x2-x3--x4----x5---|--&gt;  (点坐标)</div><div class="line">      bufferCount(2, 1)</div><div class="line"></div><div class="line">-------x1-x2--x3----x4---|---&gt; (两点坐标)</div><div class="line">       x2 x3  x4    x5</div></pre></td></tr></table></figure>
<h2 id="step-4"><a class="header-anchor" href="#step-4">#</a>Step 4</h2>
<p><em>(我要看 <a href="https://jsfiddle.net/DrakeLeung/vj368qy7/3/" target="_blank" rel="external">DEMO</a> )</em></p>
<p>接下来，我们想实现「只有鼠标按下时，才能画画，否则不能」。<br>
首先我们需要<strong>创建</strong>两个关于鼠标动作的 stream 。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> down$ = Rx.Observable.fromEvent(canvas, <span class="string">'mousedown'</span>)</div><div class="line"><span class="keyword">const</span> up$ = Rx.Observable.fromEvent(canvas, <span class="string">'mouseup'</span>)</div></pre></td></tr></table></figure>
<p>当鼠标按下的时候，我们需要把他<strong>变换</strong>成鼠标移动的 stream ，直到鼠标放开。<br>
查看文档  <a href="http://reactivex.io/rxjs/manual/overview.html#transformation-operators" target="_blank" rel="external">Transformation Operators</a> ===&gt; <a href="http://reactivex.io/rxjs/class/es6/Observable.js~Observable.html#instance-method-switchMapTo" target="_blank" rel="external">switchMapTo</a> 。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">down$.switchMapTo(move$)</div></pre></td></tr></table></figure>
<p>此时的 marble 图：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">--d---d-d-----d---d--|--&gt;  (mousedown)</div><div class="line">      switchMapTo</div><div class="line"></div><div class="line">--m---m-m-----m---m--|--&gt;</div></pre></td></tr></table></figure>
<p>此时，鼠标放开了我们还能继续画画，这显然不是我们想要的。这个时候我们很容易会使用 <a href="http://reactivex.io/rxjs/class/es6/Observable.js~Observable.html#instance-method-takeUntil" target="_blank" rel="external">takeUntil</a> 这个 operator ，但是这是不对的，因为他会把 <em>stream</em> complete 掉。</p>
<p>还是让我们看看别人是怎么写的吧：<a href="https://github.com/Reactive-Extensions/RxJS/blob/master/examples/canvaspaint/canvaspaint.js" target="_blank" rel="external">canvas paint</a> 。</p>
<h3 id="step-5"><a class="header-anchor" href="#step-5">#</a>Step 5</h3>
<p><em>(我要看 <a href="https://jsfiddle.net/DrakeLeung/vj368qy7/4/" target="_blank" rel="external">DEMO</a> )</em></p>
<p>思路是这个样子的：</p>
<p>把 <code>up$</code> 和 <code>down$</code> <strong>组合</strong>成一个新的 stream ，但为了分辨他们，我们需要先把他们<strong>变换</strong>成新的 stream 。查看文档 <a href="http://reactivex.io/rxjs/manual/overview.html#combination-operators" target="_blank" rel="external">Combination Operators</a> ===&gt; <a href="http://reactivex.io/rxjs/class/es6/Observable.js~Observable.html#instance-method-merge" target="_blank" rel="external">merge</a> 。<br>
<a href="http://reactivex.io/rxjs/manual/overview.html#transformation-operators" target="_blank" rel="external">Transformation Operators</a> ===&gt; <a href="http://reactivex.io/rxjs/class/es6/Observable.js~Observable.html#instance-method-map" target="_blank" rel="external">map</a> 。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> down$ = Rx.Observable.fromEvent(canvas, <span class="string">'mousedown'</span>)</div><div class="line">  .map(() =&gt; <span class="string">'down'</span>)</div><div class="line"><span class="keyword">const</span> up$ = Rx.Observable.fromEvent(canvas, <span class="string">'mouseup'</span>)</div><div class="line">  .map(() =&gt; <span class="string">'up'</span>)</div><div class="line"></div><div class="line"><span class="keyword">const</span> upAndDown$ = up$.merge(down$)</div></pre></td></tr></table></figure>
<p>再来看看他们的 marble 图：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">--d--d-d----d--d---|--&gt;  (down$)</div><div class="line">----u---u-u------u-|--&gt;  (up$)</div><div class="line">      merge</div><div class="line"></div><div class="line">--d-ud-du-u-d--d-u-|--&gt;  (upAndDown$)</div></pre></td></tr></table></figure>
<p>此时，我们再<strong>变换</strong> <code>upAndDown$</code> 。如果是 <code>down</code> 的话，则变换成 <code>move$</code> ，否则变换成一个空的 stream 。</p>
<p>查看文档 <a href="http://reactivex.io/rxjs/manual/overview.html#categories-of-operators" target="_blank" rel="external">Creation Operators</a> ===&gt; <a href="http://reactivex.io/rxjs/class/es6/Observable.js~Observable.html#static-method-empty" target="_blank" rel="external">empty</a> 。<br>
<a href="http://reactivex.io/rxjs/manual/overview.html#transformation-operators" target="_blank" rel="external">Transformation Operators</a> ===&gt; <a href="http://reactivex.io/rxjs/class/es6/Observable.js~Observable.html#instance-method-switchMap" target="_blank" rel="external">switchMap</a> 。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">upAndDown$</div><div class="line">  .switchMap(action =&gt;</div><div class="line">    action === <span class="string">'down'</span> ? move$ : Rx.Observable.empty()</div><div class="line">  )</div></pre></td></tr></table></figure>
<p>你要的 marble 图：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">--d-ud-du-u-d--d-u-|--&gt;  (upAndDown$)</div><div class="line">    switchMap</div><div class="line"></div><div class="line">--m-em-me-e-m--m-e-|--&gt;</div></pre></td></tr></table></figure>
<p>其实这个 canvas 画板不用 RxJS 实现也不会很难。但是当我们把他扩展成一个「你画我猜」之后，用 RxJS 处理异步就会变得简单起来。比如，添加新的工具栏 ( 调色板，撤销…… ) ，即时通信 ( 同步画板，聊天 ) …… <img class="emoji" draggable="false" alt="😂" src="https://twemoji.maxcdn.com/2/72x72/1f602.png"></p>
<p>另外，如果你想边学习 RxJS 边实现一些小东西的话：</p>
<ul>
<li><a href="https://github.com/staltz/rxjs-training" target="_blank" rel="external">staltz - rxjs training</a></li>
<li><a href="https://gist.github.com/staltz/868e7e9bc2a7b8c1f754" target="_blank" rel="external">GitHub - Who to Follow</a></li>
<li><a href="https://github.com/Reactive-Extensions/RxJS/tree/master/examples" target="_blank" rel="external">RxJS 4.x Example</a></li>
<li><a href="https://github.com/JayKan/RxJS-Playground" target="_blank" rel="external">RxJs Playground</a></li>
<li><a href="https://github.com/channikhabra/yarr" target="_blank" rel="external">Yet Another RSS Reader</a></li>
<li><a href="https://medium.com/front-end-hacking/rx-ifying-a-chat-room-built-with-reactjs-and-socket-io-459156b7d7ab#.bw55b1xqj" target="_blank" rel="external">rx-ifying a chat room built with reactjs and socket io</a></li>
<li><a href="https://github.com/hdjirdeh/angular2-hn" target="_blank" rel="external">angular2-hacknews</a></li>
</ul>
<h2 id="production"><a class="header-anchor" href="#production">#</a>Production</h2>
<p>怎么把 RxJS 应用到实际生产的 web 应用当中呢？<br>
怎么结合到当前流行的框架当中呢？</p>
<h3 id="vue"><a class="header-anchor" href="#vue">#</a>Vue</h3>
<p>你可以直接在各种 <a href="http://vuejs.org/api/#Options-Lifecycle-Hooks" target="_blank" rel="external">Lifecycle Hooks</a> 中使用 RxJS 。</p>
<p>比如 <code>created</code> 的时候初始化一个 Observable ，<code>beforeDestroy</code> 时就取消订阅 Observable 。(查看<a href="http://jsbin.com/cafodu/edit?html,js,output" target="_blank" rel="external"> DEMO </a>)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> Vue(&#123;</div><div class="line">  el: <span class="string">'#app'</span>,</div><div class="line">  data: &#123;</div><div class="line">    time: <span class="string">''</span></div><div class="line">  &#125;,</div><div class="line">  </div><div class="line">  created () &#123;</div><div class="line">    <span class="keyword">this</span>.timer$ = Rx.Observable.interval(<span class="number">1000</span>)</div><div class="line">      .map(() =&gt; <span class="keyword">new</span> <span class="built_in">Date</span>())</div><div class="line">      .map(d =&gt; moment(d).format(<span class="string">'hh:mm:ss'</span>))</div><div class="line">      .subscribe(t =&gt; &#123;</div><div class="line">        <span class="keyword">this</span>.time = t</div><div class="line">      &#125;)</div><div class="line">  &#125;,</div><div class="line">  </div><div class="line">  beforeDestroy () &#123;</div><div class="line">    <span class="keyword">this</span>.timer$.unsubscribe()</div><div class="line">  &#125;</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>其实已经有对应的插件 <a href="https://github.com/vuejs/vue-rx" target="_blank" rel="external">vue-rx</a> 帮我们干了上面的 dirty work 。他会分别在 <code>init</code> 和 <code>beforeDestroy</code> 的时候自动地订阅和取消订阅 Observable ：<a href="https://github.com/vuejs/vue-rx/blob/master/vue-rx.js#L22-L51" target="_blank" rel="external">Vue.js + RxJS binding mixin in 20 lines</a> 。</p>
<p>因此，我们可以直接把一个 Observable 写到 <code>data</code> 中：<a href="https://github.com/vuejs/vue-rx/blob/master/example/example.html#L26-L65" target="_blank" rel="external">vue-rx/example.html</a> 。</p>
<h3 id="react"><a class="header-anchor" href="#react">#</a>React</h3>
<p>类似地，React 也可以在他组件的 <a href="https://facebook.github.io/react/docs/component-specs.html#lifecycle-methods" target="_blank" rel="external">lifecycle hooks</a> 里调用 RxJS：<a href="https://github.com/belfz/fully-reactive-react-example" target="_blank" rel="external">fully-reactive-react</a> 。<br>
也可以使用 <a href="https://github.com/christianalfoni/rxjs-react-component" target="_blank" rel="external">rxjs-react-component</a> 把 Observable 绑定到 <code>state</code> 。<br>
如果你结合 Redux 的话，可以使用这个 <a href="https://github.com/redux-observable/redux-observable" target="_blank" rel="external">redux-oservable</a> 。</p>
<h3 id="angular2"><a class="header-anchor" href="#angular2">#</a>Angular2</h3>
<p>RxJS 已经是 Angular2 的标配，不多说。<br>
更多可查看对应的文档 <a href="https://angular.io/docs/ts/latest/guide/server-communication.html#!#rxjs" target="_blank" rel="external">Angular2 - Server Communication</a> 。</p>
<p>更多关于 RxJS 的集成：<a href="https://github.com/Reactive-Extensions/RxJS/blob/master/examples/community.md" target="_blank" rel="external">RxJS community</a> 。</p>
<h2 id="you-might-not-need-rxjs"><a class="header-anchor" href="#you-might-not-need-rxjs">#</a>You Might Not Need RxJS</h2>
<p>根据 <a href="https://github.com/Reactive-Extensions/RxJS/blob/master/doc/designguidelines/readme.md#21-use-rxjs-for-orchestrating-asynchronous-and-event-based-computations" target="_blank" rel="external">When to Use RxJS</a> ，我们可以知道 RxJS 的适用场景是：</p>
<ul>
<li>多个复杂的异步或者事件组合在一起</li>
<li>处理多个数据序列（有一定顺序）</li>
</ul>
<p>我觉得，如果你没被异步问题困扰的话，那就不要使用 RxJS 吧，因为 Promise 已经能够解决简单的异步问题了。至于 Promise 和 Observable 的区别是什么？<a href="https://www.google.com.hk/search?q=promise+vs+observable" target="_blank" rel="external">Promise VS Observable</a> 。</p>
<p>讲真，<strong>RxJS 在实际生产中适用的业务场景有哪些</strong>？哪些场景是需要多个异步组合在一起的？游戏吗？即时通信？还有一些特殊的业务。是我的写的业务太少了吗？还是我平时写业务的时候，为写而写，没有把他们抽象起来。<img class="emoji" draggable="false" alt="😳" src="https://twemoji.maxcdn.com/2/72x72/1f633.png"></p>
<p>另外，我倒是对 Teambition 关于 RxJS 的思路有点感兴趣：<em><a href="https://github.com/xufei/blog/issues/36#issuecomment-246662343" target="_blank" rel="external">xufei - 数据的关联计算 -&gt; Brooooooklyn 评论</a></em> &amp; <a href="https://github.com/xufei/blog/issues/37" target="_blank" rel="external">xufei - 对当前单页应用的技术栈思考</a>。</p>
<h2 id="summary"><a class="header-anchor" href="#summary">#</a>Summary</h2>
<ul>
<li><img class="emoji" draggable="false" alt="🐳" src="https://twemoji.maxcdn.com/2/72x72/1f433.png"> RxJS 是用来解决异步和事件组合问题</li>
<li><img class="emoji" draggable="false" alt="🏊" src="https://twemoji.maxcdn.com/2/72x72/1f3ca.png"> Observable == <a href="https://medium.com/@andrestaltz/2-minute-introduction-to-rx-24c8ca793877#.1q1q2mwgq" target="_blank" rel="external">异步数组</a> == 数组 + 时间轴 == stream</li>
<li><img class="emoji" draggable="false" alt="♥️" src="https://twemoji.maxcdn.com/2/72x72/2665.png"> Operators ==  <a href="http://reactivex.io/rxjs/manual/overview.html#categories-of-operators" target="_blank" rel="external">分类别</a> + <a href="http://reactivex.io/rxjs/manual/overview.html#marble-diagrams" target="_blank" rel="external">画 marble 图</a> + <a href="https://www.learnrxjs.io/operators/" target="_blank" rel="external">看例子</a> + <a href="http://reactivex.io/rxjs/manual/overview.html#choose-an-operator" target="_blank" rel="external">选</a></li>
<li><img class="emoji" draggable="false" alt="👍" src="https://twemoji.maxcdn.com/2/72x72/1f44d.png"> <strong>更多更详细的更准确的请看<a href="http://reactivex.io/rxjs/" target="_blank" rel="external">文档</a>！</strong></li>
</ul>
<p>让我们一起来学习 RxJS 吧。</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;这是一篇 RxJS 初学者教程。&lt;/p&gt;
&lt;h2 id=&quot;what-is-rxjs&quot;&gt;&lt;a class=&quot;header-anchor&quot; href=&quot;#what-is-rxjs&quot;&gt;#&lt;/a&gt;What Is RxJS&lt;/h2&gt;
&lt;p&gt;通过&lt;strong&gt;阅读&lt;a href=&quot;h
    
    </summary>
    
    
      <category term="RxJS" scheme="http://drakeleung.github.io/blog/tags/RxJS/"/>
    
  </entry>
  
  <entry>
    <title>Node.js 之单元测试</title>
    <link href="http://drakeleung.github.io/blog/2016/09/08/unit-test-4-your-nodejs-app/"/>
    <id>http://drakeleung.github.io/blog/2016/09/08/unit-test-4-your-nodejs-app/</id>
    <published>2016-09-08T13:44:07.000Z</published>
    <updated>2016-09-17T18:01:58.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="setup-node-js-app"><a class="header-anchor" href="#setup-node-js-app">#</a>Setup Node.js App</h2>
<p>( <strong>如果已经建好了 Node.js 应用，可直接跳到 <a href="#start-unit-test">下一个部分 - Start Unit Test</a></strong> )</p>
<p>下面，我们将使用 <a href="https://github.com/koajs/koa" target="_blank" rel="external">koa</a>, <a href="http://mongoosejs.com" target="_blank" rel="external">mongoose</a> , <a href="https://github.com/lorenwest/node-config/" target="_blank" rel="external">config</a> 初始化我们的项目。<br>
完整代码可查看 <img class="emoji" draggable="false" alt="👉" src="https://twemoji.maxcdn.com/2/72x72/1f449.png"> <a href="">这里</a>。</p>
<p>首先是我们的入口文件: <code>src/app.js</code> 。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// src/app.js</span></div><div class="line"><span class="keyword">const</span> app = <span class="built_in">require</span>(<span class="string">'koa'</span>)()</div><div class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>)</div><div class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">'config'</span>)</div><div class="line"></div><div class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">'./router'</span>)</div><div class="line"></div><div class="line"><span class="keyword">const</span> &#123; mongo &#125; = config</div><div class="line"><span class="keyword">const</span> url = <span class="string">`mongodb://<span class="subst">$&#123;mongo.host&#125;</span>:<span class="subst">$&#123;mongo.port&#125;</span>/<span class="subst">$&#123;mongo.db&#125;</span>`</span></div><div class="line">mongoose.Promise = global.Promise</div><div class="line">mongoose.connect(url)</div><div class="line"></div><div class="line">app.use(router.routes())</div><div class="line"></div><div class="line">app.on(<span class="string">'error'</span>, err =&gt; <span class="built_in">console</span>.error(<span class="string">'onError'</span>, err))</div><div class="line">app.listen(config.port, () =&gt; <span class="built_in">console</span>.log(<span class="string">`listening port <span class="subst">$&#123;config.port&#125;</span>`</span>))</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = app</div></pre></td></tr></table></figure>
<p>接着是我们的路由文件：<code>src/router.js</code> 。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// src/router.js</span></div><div class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">'koa-router'</span>)()</div><div class="line"></div><div class="line"><span class="keyword">const</span> heroCtrl = <span class="built_in">require</span>(<span class="string">'./apis/hero/hero.ctrl'</span>)</div><div class="line"></div><div class="line">router.get(<span class="string">'/api/hero'</span>, heroCtrl.getHeroes)</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = router</div></pre></td></tr></table></figure>
<p>然后呢是我们的接口文件：<code>src/api/hero/hero.model.js</code>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// src/api/hero/hero.model.js</span></div><div class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>)</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = mongoose.model(<span class="string">'hero'</span>, &#123;</div><div class="line">  name: <span class="built_in">String</span>,</div><div class="line">  skills: [<span class="built_in">String</span>],</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>以及其对应的 controller: <code>src/api/hero/hero.ctrl.js</code> 。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// src/api/hero/hero.ctrl.js</span></div><div class="line"><span class="keyword">const</span> heroModel = <span class="built_in">require</span>(<span class="string">'./hero.model'</span>)</div><div class="line"></div><div class="line"><span class="keyword">const</span> getHeroes = <span class="function"><span class="keyword">function</span> *(<span class="params">next</span>) </span>&#123;</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    <span class="keyword">const</span> hero = <span class="keyword">yield</span> heroModel.find(&#123;&#125;)</div><div class="line">    <span class="keyword">this</span>.body = hero</div><div class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</div><div class="line">    <span class="keyword">this</span>.throw(<span class="number">404</span>, e)</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line">  getHeroes,</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>为了在不同的开发环境下使用不同的配置文件，我们使用了 <a href="https://github.com/lorenwest/node-config/" target="_blank" rel="external">config</a> 这个包。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// config/default.json</span></div><div class="line">&#123;</div><div class="line">  <span class="string">"name"</span>: <span class="string">"hero-dev"</span>,</div><div class="line">  <span class="string">"port"</span>: <span class="number">3000</span>,</div><div class="line">  <span class="string">"mongo"</span>: &#123;</div><div class="line">    <span class="string">"host"</span>: <span class="string">"127.0.0.1"</span>,</div><div class="line">    <span class="string">"db"</span>: <span class="string">"hero-dev"</span>,</div><div class="line">    <span class="string">"port"</span>: <span class="number">27017</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后，我们整个 <code>package.json</code> 文件如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="string">"name"</span>: <span class="string">"unit-test-for-nodejs-app"</span>,</div><div class="line">  <span class="string">"version"</span>: <span class="string">"0.0.1"</span>,</div><div class="line">  <span class="string">"description"</span>: <span class="string">"unit test for nodejs app"</span>,</div><div class="line">  <span class="string">"main"</span>: <span class="string">"app.js"</span>,</div><div class="line">  <span class="string">"scripts"</span>: &#123;</div><div class="line">    <span class="string">"dev"</span>: <span class="string">"nodemon app.js"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="string">"keywords"</span>: [</div><div class="line">    <span class="string">"unit-test"</span>,</div><div class="line">    <span class="string">"nodejs"</span></div><div class="line">  ],</div><div class="line">  <span class="string">"author"</span>: <span class="string">"Drake Leung"</span>,</div><div class="line">  <span class="string">"license"</span>: <span class="string">"MIT"</span>,</div><div class="line">  <span class="string">"dependencies"</span>: &#123;</div><div class="line">    <span class="string">"config"</span>: <span class="string">"^1.21.0"</span>,</div><div class="line">    <span class="string">"koa"</span>: <span class="string">"^1.2.4"</span>,</div><div class="line">    <span class="string">"koa-router"</span>: <span class="string">"^5.4.0"</span>,</div><div class="line">    <span class="string">"mongodb"</span>: <span class="string">"^2.2.9"</span>,</div><div class="line">    <span class="string">"mongoose"</span>: <span class="string">"^4.6.0"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>终端执行 <code>npm run dev</code> 便可以启动我们的应用。<br>
然后访问接口：<code>localhost:3000/api/hero</code>，会返回 <code>[]</code> ，因为数据库里还没有数据。</p>
<h2 id="start-unit-test"><a class="header-anchor" href="#start-unit-test">#</a>Start Unit Test</h2>
<p>在开始写测试之前，我们也许会想到几个问题：</p>
<ul>
<li>如何模拟访问一个接口。</li>
<li>接口返回的数据哪里来。</li>
<li>接口访问有权限控制怎么办。</li>
</ul>
<p>下面，我们将用到 <a href="https://github.com/mochajs/mocha" target="_blank" rel="external">mocha</a>, <a href="https://github.com/chaijs/chai" target="_blank" rel="external">chai</a> 来写我们的单元测试。<br>
( 在这里，我们只讨论如何写测试，而不讨论各种测试框架的优劣。)</p>
<p>首先，安装依赖：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm i -D mocha chai</div></pre></td></tr></table></figure>
<p>接着，新建一个文件夹 <code>test</code> 。<br>
新建一个文件 <code>index.js</code> 。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// test/index.js</span></div><div class="line"><span class="keyword">const</span> chai = <span class="built_in">require</span>(<span class="string">'chai'</span>)</div><div class="line"><span class="keyword">const</span> expect = chai.expect</div><div class="line"></div><div class="line">describe(<span class="string">'root app'</span>, () =&gt; &#123;</div><div class="line">  it(<span class="string">'should be ok'</span>, () =&gt; &#123;</div><div class="line">    expect(<span class="number">42</span>).to.be.exist</div><div class="line">  &#125;)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>然后给我们的 <code>package.json</code> 添加一个 <code>script</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="string">"script"</span>: &#123;</div><div class="line">    <span class="string">"test"</span>: <span class="string">"mocha"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后我们执行 <code>npm test</code> ，就可以看到测试结果啦。</p>
<p>接下来，我们需要做的是，解决掉上面讲到的问题。</p>
<blockquote>
<p>如何模拟访问一个接口，比如：<code>/api/hero</code>。</p>
</blockquote>
<p>这个时候，我们需要用到 <a href="https://github.com/visionmedia/supertest" target="_blank" rel="external">supertest</a> ：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm i -S supertest</div></pre></td></tr></table></figure>
<p>现在，就让我们先新建一个文件：<code>test/apis/hero/hero.spec.js</code> 。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> expect = <span class="built_in">require</span>(<span class="string">'chai'</span>).expect</div><div class="line"><span class="keyword">const</span> supertest = <span class="built_in">require</span>(<span class="string">'supertest'</span>)</div><div class="line"></div><div class="line"><span class="keyword">const</span> heroModel = <span class="built_in">require</span>(<span class="string">'../../../src/apis/hero/hero.model'</span>)</div><div class="line"><span class="keyword">const</span> app = <span class="built_in">require</span>(<span class="string">'../../../src/app'</span>)</div><div class="line"></div><div class="line"><span class="keyword">const</span> req = supertest(app.listen())</div><div class="line"></div><div class="line">describe(<span class="string">'hero model'</span>, () =&gt; &#123;</div><div class="line">  describe(<span class="string">'GET /api/hero'</span>, () =&gt; &#123;</div><div class="line">    it(<span class="string">'should return all heros'</span>, done =&gt; &#123;</div><div class="line">      req.get(<span class="string">'/api/hero'</span>)</div><div class="line">        .expect(<span class="number">200</span>)</div><div class="line">        .expect(&#123; body &#125; =&gt; &#123;</div><div class="line">          expect(body).to.be([<span class="number">1</span>, <span class="number">2</span>])</div><div class="line">        &#125;, done)</div><div class="line">    &#125;)</div><div class="line">  &#125;)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>接着修改 <code>package.json</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="string">"scripts"</span>: &#123;</div><div class="line">    <span class="string">"test"</span>: <span class="string">"mocha test/**/*.spec.js"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>那么接下来的是问题：</p>
<blockquote>
<p>接口返回的数据哪里来？</p>
</blockquote>
<p>另外，还有一个可能的问题是：</p>
<blockquote>
<p>我们的接口首先会通过「权限相关」的中间件，怎么绕过他们？</p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;setup-node-js-app&quot;&gt;&lt;a class=&quot;header-anchor&quot; href=&quot;#setup-node-js-app&quot;&gt;#&lt;/a&gt;Setup Node.js App&lt;/h2&gt;
&lt;p&gt;( &lt;strong&gt;如果已经建好了 Node.js 应用，可直
    
    </summary>
    
    
      <category term="nodejs" scheme="http://drakeleung.github.io/blog/tags/nodejs/"/>
    
      <category term="testing" scheme="http://drakeleung.github.io/blog/tags/testing/"/>
    
      <category term="koa" scheme="http://drakeleung.github.io/blog/tags/koa/"/>
    
      <category term="mocha" scheme="http://drakeleung.github.io/blog/tags/mocha/"/>
    
      <category term="supertest" scheme="http://drakeleung.github.io/blog/tags/supertest/"/>
    
  </entry>
  
  <entry>
    <title>fetch api 用起来！</title>
    <link href="http://drakeleung.github.io/blog/2016/08/15/fetch-api-now/"/>
    <id>http://drakeleung.github.io/blog/2016/08/15/fetch-api-now/</id>
    <published>2016-08-14T16:16:49.000Z</published>
    <updated>2016-09-08T11:11:14.000Z</updated>
    
    <content type="html"><![CDATA[<p>今天把 vue-resource 砍掉，换成了 <a href="http://devdocs.io/dom/globalfetch/fetch" target="_blank" rel="external">fetch</a> 。<br>
然而，代码体积在 build 之后只是少了 2K =。=</p>
<p>为了兼容旧浏览器，我们将使用这个的 polyfill : <a href="https://github.com/github/fetch" target="_blank" rel="external">whatwg-fetch</a> ；如果还想兼容 node 的话：<a href="https://github.com/matthew-andrews/isomorphic-fetch" target="_blank" rel="external">isomorphic-fetch</a> 。安装请看对应的文档。</p>
<h2 id="fetch-api"><a class="header-anchor" href="#fetch-api">#</a>fetch api</h2>
<p>最简单的 <code>fetch</code> 接口是下面这样子的：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * fetch</div><div class="line"> *</div><div class="line"> * @param &#123;string&#125; url </div><div class="line"> * @param &#123;object&#125; config</div><div class="line"> * @return &#123;promise&#125;</div><div class="line">*/</div><div class="line">fetch('/api/heros/, &#123;</div><div class="line">  method: 'GET',</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>更详情的请看文档啦：<a href="http://devdocs.io/dom/globalfetch/fetch" target="_blank" rel="external">globalfetch.fetch</a> 。</p>
<h2 id="常用例子"><a class="header-anchor" href="#常用例子">#</a>常用例子</h2>
<p>看这个：<a href="https://github.com/github/fetch#usage" target="_blank" rel="external">fetch - usage</a> 。</p>
<h2 id="可能遇到的坑"><a class="header-anchor" href="#可能遇到的坑">#</a>可能遇到的坑</h2>
<ul>
<li>不发送 cookie</li>
<li>不 catch 404 或者 500 等 HTTP 错误状态码。</li>
</ul>
<p>解决办法可以查看 <a href="https://github.com/github/fetch#caveats" target="_blank" rel="external">fetch - caveats</a> 。</p>
<h2 id="拦截器"><a class="header-anchor" href="#拦截器">#</a>拦截器</h2>
<p>如果我们想在每个请求之前或者之后进行某些操作的话，就需要用到拦截器啦。<br>
下面我们用到的是拦截器是 <a href="https://github.com/werk85/fetch-intercept" target="_blank" rel="external">fetch-intercept</a> 。可以去看看源码，只有 80 行不到，超级优美的代码。</p>
<p>如果我们想每个请求都发送 cookie 的话，就必须要设置 <a href="https://github.com/github/fetch#sending-cookies" target="_blank" rel="external">credentials</a> 。但是我不想每个请求都设置一遍，这时我们就可以用到拦截器啦。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> fetchIntercept</div><div class="line"></div><div class="line">fetchIntercept.register(&#123;</div><div class="line">  request(url, config = &#123;&#125;) &#123;</div><div class="line">    <span class="keyword">const</span> myConf = &#123;</div><div class="line">      credentials: <span class="string">'include'</span>, <span class="comment">// send cookie</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> [</div><div class="line">      url,</div><div class="line">      defaults(config, myConf), <span class="comment">// merge 2 objects</span></div><div class="line">    ]</div><div class="line">  &#125;,</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>同样地，我们可以简化请求的 URL 。比如说，</p>
<ul>
<li><code>/rootHost/api/heros/</code></li>
<li><code>/rootHost/api/coolBoys/</code></li>
</ul>
<p>这个时候我们就可以把 <code>/rootHost/api/</code> 提取出来。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">fetchIntercept.register(&#123;</div><div class="line">  request(url, config = &#123;&#125;) &#123;</div><div class="line">    <span class="keyword">return</span> [</div><div class="line">     <span class="string">`<span class="subst">$&#123;apiHost()&#125;</span>/api/<span class="subst">$&#123;url&#125;</span>,</span></div><div class="line">     config,</div><div class="line">    ]</div><div class="line">  &#125;,</div><div class="line">&#125;)</div><div class="line"></div><div class="line">fetch('heros/')</div><div class="line">fetch('coolBoys/')</div></pre></td></tr></table></figure>
<p>类似地，我们也可以用在 GET 请求时带的 query string 。</p>
<p>另外，因为 fetch 不会 catch 404 等错误，所以需要我们手动设置。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">fetchIntercept.register(&#123;</div><div class="line">  response(res) &#123;</div><div class="line">    <span class="keyword">if</span> (res.status &gt;= <span class="number">200</span> &amp;&amp; res.status &lt; <span class="number">300</span>) <span class="keyword">return</span> res</div><div class="line">    <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(res.statusText)</div><div class="line">  &#125;,</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>可以看到使用了拦截器之后，我们的代码就变得优美多了 <img class="emoji" draggable="false" alt="😃" src="https://twemoji.maxcdn.com/2/72x72/1f603.png"></p>
<h2 id="see-also"><a class="header-anchor" href="#see-also">#</a>See Also</h2>
<ul>
<li><a href="https://github.com/github/fetch" target="_blank" rel="external">whatwg-fetch</a></li>
<li><a href="https://github.com/matthew-andrews/isomorphic-fetch" target="_blank" rel="external">isomorphic-fetch</a></li>
<li><a href="https://github.com/werk85/fetch-intercept" target="_blank" rel="external">fetch-intercept</a></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;今天把 vue-resource 砍掉，换成了 &lt;a href=&quot;http://devdocs.io/dom/globalfetch/fetch&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;fetch&lt;/a&gt; 。&lt;br&gt;
然而，代码体积在 build 之
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>有趣的 Nginx</title>
    <link href="http://drakeleung.github.io/blog/2016/08/11/Oh-My-Nginx/"/>
    <id>http://drakeleung.github.io/blog/2016/08/11/Oh-My-Nginx/</id>
    <published>2016-08-10T16:53:50.000Z</published>
    <updated>2016-09-08T05:01:57.000Z</updated>
    
    <content type="html"><![CDATA[<p>由于在开发项目的时候用到了 <code>nginx</code> ，觉得挺不错的，所以了解了一下。</p>
<p>一个项目的开发环境一般都会分为4个阶段。</p>
<ul>
<li>test(local): 本地</li>
<li>alpha</li>
<li>beta</li>
<li>production</li>
</ul>
<p>每个环境下，前端的域名是不同的，并且调用后台接口的 <code>url</code> 也是不同的。假设我们的项目名字叫做 <code>toon</code>，并且 root domain 是 <code>lyyourc.com</code>，那么就有：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 前端4个环境下的域名</span></div><div class="line">-  <span class="built_in">test</span>: toon.test.lyyourc.net</div><div class="line">- alpha: toon.alpha.lyyourc.net</div><div class="line">-  beta: toon.alpha.lyyourc.net</div><div class="line">-  prod: toon.lyyourc.com</div><div class="line"></div><div class="line"><span class="comment"># 后台接口</span></div><div class="line">-  alpha: toon-api.alpha.lyyourc.net</div><div class="line">-   beta: toon-api..beta.lyyourc.net</div><div class="line">-   prod: toon-api.lyyourc.com</div></pre></td></tr></table></figure>
<p>那么，在这种情况下，我们应该如何：</p>
<blockquote>
<p>不同环境下，前端使用不同的域名，访问对应的后台接口呢？</p>
</blockquote>
<p>首先，我们要解决<strong>前端怎么使用域名来访问我们的 web 应用</strong>。</p>
<p>最简单的办法当然是<strong>改 hosts</strong> 。应该还有其他办法，比如 <a href="https://github.com/typicode/hotel" target="_blank" rel="external">hotel - get local domain in seconds</a> 。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># my project - toon</span></div><div class="line">127.0.0.1 toon.test.lyyourc.net</div></pre></td></tr></table></figure>
<p>接下来，我们需要用到 nginx 作为一个 <strong>proxy server</strong> ，把接收到请求转发到对应的后台接口。</p>
<p>如果你还没接触过 nginx 的话，现在就是一个好机会啦。打开 <a href="http://nginx.org/en/docs/" target="_blank" rel="external">nginx 的官网</a>，安装，看 <a href="http://nginx.org/en/docs/beginners_guide.html" target="_blank" rel="external">Beginner’s Guide</a> 。</p>
<p>下面，修改我们的 <code>nginx.conf</code>(OSX: <code>/usr/local/etc/nginx/</code>)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">worker_processes  7;</div><div class="line">events &#123; worker_connections 256; &#125;</div><div class="line"></div><div class="line">http &#123;</div><div class="line">  server &#123;</div><div class="line">    <span class="comment"># 监听 80 端口</span></div><div class="line">    listen 80; </div><div class="line">    </div><div class="line">    <span class="comment"># 域名符合：toon.*.lyyourc.net 等</span></div><div class="line">    server_name ~^toon\.(.*\.)?(lyyourc)\.net$;</div><div class="line"></div><div class="line">    location / &#123;</div><div class="line">      root <span class="string">"/Users/drake/Projects/demo/fun/nginx"</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment"># 只要含有 `/api/` 请求，都转发</span></div><div class="line">    location /api/ &#123;</div><div class="line">      proxy_pass http://toon-api.alpha.lyyourc.net;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后运行：<code>sudo nginx -s reload</code>，重新读取 nginx 的配置文件。如果失败的话，会有相关的提示信息。比如下面少写了 <code>event</code> 这个指令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nginx: [emerg] no <span class="string">"events"</span> section <span class="keyword">in</span> configuration</div></pre></td></tr></table></figure>
<p>在上面的 <code>nginx.conf</code> 中，我们定义了：</p>
<blockquote>
<p>只要请求是来自 80 端口，域名符合，URL中包含了 <code>/api/</code> 的，我们都转发到 <code>http://toon-api.alpha.lyyourc.net</code> ，如果为 <code>/</code> 的话，直接读取 <code>/Users/drake/Projects/demo/fun/nginx</code> 目录下的 <code>index.html</code> 。</p>
</blockquote>
<p>然后，我们前端需要做的是：<strong>根据当前的域名，请求对应的后台接口。</strong></p>
<ul>
<li>写一个配置文件</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// host.js</span></div><div class="line"><span class="keyword">export</span> <span class="keyword">const</span> apiHost = () =&gt; &#123;</div><div class="line">  <span class="keyword">const</span> items = <span class="built_in">window</span>.location.hostname.split(<span class="string">'.'</span>)</div><div class="line">  <span class="keyword">const</span> env = items[<span class="number">1</span>]</div><div class="line"></div><div class="line">  <span class="keyword">switch</span> (env) &#123;</div><div class="line">    <span class="keyword">case</span> <span class="string">'test'</span>: <span class="comment">// 本地开发环境 =&gt; nginx</span></div><div class="line">      <span class="keyword">return</span> <span class="string">''</span></div><div class="line"></div><div class="line">    <span class="keyword">case</span> <span class="string">'alpha'</span>:</div><div class="line">      <span class="keyword">return</span> <span class="string">'//toon-api.alpha.lyyourc.net'</span></div><div class="line"></div><div class="line">    <span class="keyword">case</span> <span class="string">'beta'</span>:</div><div class="line">      <span class="keyword">return</span> <span class="string">'//toon-api.beta.lyyourc.net'</span></div><div class="line"></div><div class="line">    <span class="keyword">default</span>:</div><div class="line">      <span class="keyword">return</span> <span class="string">'//toon-api.lyyourc.com'</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>每次请求的时候都带上这个 host :</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> &#123; apiHost &#125; <span class="keyword">from</span> <span class="string">'host.js'</span></div><div class="line"></div><div class="line">fetch(<span class="string">`<span class="subst">$&#123;apiHot()&#125;</span>/api/heros/`</span>)</div><div class="line">  .then(res =&gt; res.json())</div></pre></td></tr></table></figure>
<p>这时就有：</p>
<ul>
<li>前端域名为 <code>toon.test.lyyourc.net</code> 的时候</li>
<li><code>apiHost</code> 返回空字符串 <code>''</code></li>
<li>访问后台接口的 URL 为 <code>toon.test.lyyourc.net/api/xx</code></li>
<li>在 <code>/etc/hosts</code> 匹配了这个 URL ，转到 <code>127.0.0.1</code></li>
<li>Nginx 接收，转发到 <code>http://toon-api.alpha.lyyourc.net</code></li>
</ul>
<p>为什么不直接在 <code>host.js</code> 里面返回 <code>http://toon-api.alpha.lyyourc.net</code> 呢？原因有2个我认为：1个是浏览器的同源策略而产生的<strong>跨域问题</strong>，另1个是当我们想要测试任何环境下的后台接口，我们只需要改 <code>nginx.conf</code> 里面的 <code>proxy_pass</code> 就好了。</p>
<p>综上，<strong>不知道是否还有更好的解决办法呢？</strong></p>
<p>其实 nginx 还可以做很多事情啦。比如一个服务器上轻松地跑多个 App ，还有反代 google ，配置 HTTPS 等等。</p>
<p>Oh~ My Nginx!!</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;由于在开发项目的时候用到了 &lt;code&gt;nginx&lt;/code&gt; ，觉得挺不错的，所以了解了一下。&lt;/p&gt;
&lt;p&gt;一个项目的开发环境一般都会分为4个阶段。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;test(local): 本地&lt;/li&gt;
&lt;li&gt;alpha&lt;/li&gt;
&lt;li&gt;beta&lt;/
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>A Mathematical Expressions Parser</title>
    <link href="http://drakeleung.github.io/blog/2016/07/14/a-mathematical-expressions-parser/"/>
    <id>http://drakeleung.github.io/blog/2016/07/14/a-mathematical-expressions-parser/</id>
    <published>2016-07-14T12:56:20.000Z</published>
    <updated>2016-09-08T05:01:57.000Z</updated>
    
    <content type="html"><![CDATA[<p>更多信息可查看 <a href="http://drakeleung.github.io/demo/slides/calc">SLIDE</a> 。</p>
<h2 id="问题"><a class="header-anchor" href="#问题">#</a>问题</h2>
<p>我们的问题是这样子的：</p>
<blockquote>
<p>写一个 <code>calculate</code> 函数，他的参数是一个四则运算表达式字符串，返回结果则是该参数的求值。</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">calculate(<span class="string">'1+2*3'</span>) <span class="comment">// 7</span></div><div class="line">calculate(<span class="string">'1*(2+3)*4)'</span>) <span class="comment">// 20</span></div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"> * 规则：</div><div class="line"> * 1. 禁止 eval 及其类似物</div><div class="line"> * 2. 禁止第三方库</div><div class="line"> */</div></pre></td></tr></table></figure>
<h2 id="最简单的思路"><a class="header-anchor" href="#最简单的思路">#</a>最简单的思路</h2>
<p>假设字符串就是简单的 <code>1+2</code>，那么最简单的想法当然是：</p>
<blockquote>
<p>遍历该字符串，然后根据不同的操作符，计算其结果，重复之。</p>
</blockquote>
<p>然而，当字符串为 <code>1+2*3</code> 时，得到的结果是 <code>9</code> 而不是 <code>7</code> 。这是因为我们并没有考虑到<strong>操作符的优先级</strong>。并且，如果加上括号（<code>()</code>）的话，那么优先级就变得更加复杂。</p>
<p>所以啊，我们就想：</p>
<blockquote>
<p>能不能没有优先级，按顺序就好啦，这样就简单多了。</p>
</blockquote>
<h2 id="逆波兰"><a class="header-anchor" href="#逆波兰">#</a>逆波兰</h2>
<p>只要努力 google 一下，我们就可以找到解决方法：</p>
<blockquote>
<p>使用「逆波兰表达式」。</p>
</blockquote>
<p>像我们平时使用的 <code>1 + 1</code> 就叫 <em>中缀表达式</em> 。而 <em>逆波兰</em>（<em>后缀表达式</em> ）则形如 <code>1 1 +</code>。</p>
<p>现在，我们的问题就变成了:</p>
<blockquote>
<p>怎样把「中缀表达式」转换成「逆波兰表达式」？</p>
</blockquote>
<h2 id="tokenizer"><a class="header-anchor" href="#tokenizer">#</a>Tokenizer</h2>
<p>第一步，我们需要做的是：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">// 假设我们的字符串形如：`1+2*3-4`</div><div class="line">// 那么就要把他转换成这样的一个数组：</div><div class="line"></div><div class="line">[</div><div class="line">  &#123; <span class="built_in">type</span>: <span class="string">'number'</span>, value: 1 &#125;,</div><div class="line">  &#123; <span class="built_in">type</span>: <span class="string">'operator'</span>, value: <span class="string">'+'</span> &#125;,</div><div class="line">  &#123; <span class="built_in">type</span>: <span class="string">'number'</span>, value: 2 &#125;,</div><div class="line">  ....</div><div class="line">]</div></pre></td></tr></table></figure>
<p><em>查看代码请点击 <a href="https://github.com/DrakeLeung/calc/blob/master/src/tokenizer.js" target="_blank" rel="external">tokenizer</a> 。</em></p>
<h2 id="torpn"><a class="header-anchor" href="#torpn">#</a>toRPN</h2>
<p>第二步，我们要把得到的 tokens 转换成 <em>逆波兰</em> 形式。这个时候需要用到 <a href="">shunting-yard</a> 算法。</p>
<p><em>查看代码请点击 <a href="https://github.com/DrakeLeung/calc/blob/master/src/toRPN.js" target="_blank" rel="external">toRPN</a> 。</em></p>
<h2 id="calculator"><a class="header-anchor" href="#calculator">#</a>Calculator</h2>
<p>第三步，也是我们最后一步。</p>
<p>我们需要把创建一个 <strong>操作数栈</strong> ，如果是操作数的话，push 到栈里去；如果是操作符的话，把栈里的前两个操作数 pop 出来，计算他们和该操作符的结果。然后把结果 push 到栈里。重复之，直到遍历完所有的 tokens 。</p>
<p><em>查看代码请点击 <a href="https://github.com/DrakeLeung/calc/blob/master/src/index.js" target="_blank" rel="external">calculator</a> 。</em></p>
<h2 id="抽象语法树"><a class="header-anchor" href="#抽象语法树">#</a>抽象语法树</h2>
<p>其实，我们还能做些更有趣的事情。比如，构建一棵 AST 。做法其实和第三步差不多。</p>
<ol>
<li>创建一个 <strong>操作数栈</strong></li>
<li>遍历 tokens</li>
<li>如果 token 为操作数，则 push 到栈里。</li>
<li>如果 token 为操作符，则把 栈里的两个操作数 pop 出来，与该操作符形成 AST 的一个节点，接着把该节点 push 到栈里去</li>
<li>重复之，直到遍历完 tokens</li>
</ol>
<p>有了 AST 之后，如果我们对其分别进行前序，中序，后序遍历的话，就可以得到 <strong>前缀表达式</strong> ，<strong>中缀表达式</strong> ，以及 <strong>后缀表达式</strong> 。</p>
<p><em>查看代码请点击 <a href="https://github.com/DrakeLeung/calc/blob/master/src/parser.js" target="_blank" rel="external">parser</a> 。</em></p>
<h2 id="项目源码"><a class="header-anchor" href="#项目源码">#</a>项目源码</h2>
<p>所有代码可查看：<a href="https://github.com/DrakeLeung/calc" target="_blank" rel="external">https://github.com/DrakeLeung/calc</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;更多信息可查看 &lt;a href=&quot;http://drakeleung.github.io/demo/slides/calc&quot;&gt;SLIDE&lt;/a&gt; 。&lt;/p&gt;
&lt;h2 id=&quot;问题&quot;&gt;&lt;a class=&quot;header-anchor&quot; href=&quot;#问题&quot;&gt;#&lt;/a&gt;问题&lt;/h
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>实现一个 flickr like 布局</title>
    <link href="http://drakeleung.github.io/blog/2016/04/29/justified-layout/"/>
    <id>http://drakeleung.github.io/blog/2016/04/29/justified-layout/</id>
    <published>2016-04-29T15:27:28.000Z</published>
    <updated>2016-09-08T05:01:57.000Z</updated>
    
    <content type="html"><![CDATA[<p>Flickr 团队最近开源了他们图片布局的项目 - <a href="https://github.com/flickr/justified-layout/blob/master/README.md" target="_blank" rel="external">Flickr’s Justified Layout</a> 。那么，通过阅读其源代码后，我实现了一个简单版 - <a href="https://github.com/DrakeLeung/demo/blob/gh-pages/toys%2Fjjjustify%2FREADME.md" target="_blank" rel="external">jjjustify</a>。点击这里可以查看在线 <a href="http://frontend-addiction.github.io/Baidu-IFE/stage03/task43/flickr/index.html" target="_blank" rel="external">demo</a> 。</p>
<h2 id="核心算法"><a class="header-anchor" href="#核心算法">#</a>核心算法</h2>
<p>整个应用的核心是：<strong>如何确定一行中的图片数量并且保持横纵比</strong> 。</p>
<p>首先，我们需要知道一个知识：</p>
<blockquote>
<p>假设我们一行的高度为 300 ，宽度为 1200 。那么在这一行中的所有图片的横纵比之和就小于等于这一行的横纵比，也就是 4:1 。</p>
</blockquote>
<p>我们这里不用数学来证明。但是不妨想象，当一行中的图片都收缩或者拉伸之后，是可以占满整行的，这时，就相当于这一行。所以，当前行所有图片的横纵比之和要<strong>小于等于</strong>初始设定的整行的横纵比。</p>

<p>但是，为了增加灵活性，我们可以<strong>设定一个容忍度</strong>。他的取值范围是 <code>[0, 1]</code> 。如果当前行所有图片的横纵比之和介于（初始设定的整行的横纵比 * (1 ± 容忍度）的话，我们都能接受（容忍），在当前行插入该图片。</p>
<p>举个例子：初始设定的整行的横纵比（<code>targetRowAspectRatio</code>）为 4 ，我们的容忍度（<code>tolerance</code>）为 <code>0.25</code> 。所以，只要图片们的横纵比之和介于 <code>targetRowAspectRatio * (1 - tolerance)</code> 和 <code>targetRowAspectRatio * (1 + tolerance)</code> 就让他们在当前行。</p>

<p>如果大于容忍后的横纵比的话，<strong>为了更加精确，我们可以比较绝对值</strong>。看看插入图片后的横纵比之和 - targetRowAspectRatio 的绝对值小，还是插入图片前的横纵比之和 - targetRowAspectRatio 的绝对值小。哪个小就采用哪种方案。</p>
<p>插入新图片前的绝对值为 <code>3.5</code> :</p>

<p>插入后的绝对值为 <code>0.5</code> ，小于 <code>3.5</code> ，所以我们选择在当前行插入该图片。</p>

<p>如果小于容忍后的横纵比的话，假设还没插完图片，就继续插。如果已经插完了图片，这里我们可以选择是否铺满一行，还是就让他这样。这个时候我们的高度就是原始设定的高度。</p>
<p>详细代码实现请参考 <a href="https://github.com/DrakeLeung/demo/blob/gh-pages/toys%2Fjjjustify%2Frrrow.js" target="_blank" rel="external">rrrow.js</a> 的 <code>addItem()</code> 方法。</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Flickr 团队最近开源了他们图片布局的项目 - &lt;a href=&quot;https://github.com/flickr/justified-layout/blob/master/README.md&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Flick
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>bubble sorting visually</title>
    <link href="http://drakeleung.github.io/blog/2016/03/27/bubble-sorting-visually/"/>
    <id>http://drakeleung.github.io/blog/2016/03/27/bubble-sorting-visually/</id>
    <published>2016-03-27T15:01:37.000Z</published>
    <updated>2016-09-08T05:01:57.000Z</updated>
    
    <content type="html"><![CDATA[<p>TL;DR: <a href="http://plnkr.co/edit/je2wWv?p=preview" target="_blank" rel="external">在线例子和相关代码请查看这里。</a></p>
<p>本文章的目的来源于知乎的一个问题：<a href="https://www.zhihu.com/question/41642706" target="_blank" rel="external">我用js写了一个冒泡排序法，怎么用html和css把排序过程展现出来？</a></p>
<p>下面讲一下要解决的几个问题和 tips。</p>
<h2 id="如何实现-交换-的动画"><a class="header-anchor" href="#如何实现-交换-的动画">#</a>如何实现「交换」的动画</h2>
<p>我觉得这个是整个应用的难点。</p>
<p>看了 <a href="http://visualgo.net/sorting.html" target="_blank" rel="external">visual.net</a>，他的实现是利用 CSS3 的 <code>transform</code> 函数里面的 <code>translate</code>。这似乎是不错的想法，但是我发现要用 JS 获取 <code>translate</code> 对应的值的话，<a href="http://stackoverflow.com/questions/21912684/how-to-get-value-of-translatex-and-translatey" target="_blank" rel="external">有点麻烦</a>。</p>
<p>接着，我又看了一个答案的<a href="http://meowtec.github.io/demo/sort-v/" target="_blank" rel="external">实现</a>。他的方法是利用 CSS 中的 <code>left</code>。而 <code>left</code> 的值是相对于设定了 <code>position: relative</code> 的 <em>parent</em>。</p>
<p>我不是很懂上面的方法。但是我想到了另一个方法：<strong><code>left</code> 是相对于他本身</strong>。也就是设置他本身为 <code>position: relative</code> 而不是他的 <em>parent</em>。</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="selector-class">.bar</span> &#123;</div><div class="line">  <span class="attribute">position</span>: relative;</div><div class="line">  <span class="attribute">left</span>: <span class="number">0</span>;  <span class="comment">/* must set, or not transition when value in falsy */</span></div><div class="line">  <span class="comment">/*transition: left 1s;*/</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我之所以设置 <code>left</code> 为 <code>0</code>，是因为我们要用 CSS3 的 <code>transition</code> 实现渐变的效果。</p>
<p>然后，每次交换的时候，我们只需要把他当前的 <code>left</code> 加/减 柱形图的宽度。没错，这就是这种方法的「缺点」之一，我们需要用 JS 写死柱形图的宽度。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">swap () &#123;</div><div class="line">  <span class="comment">// ...</span></div><div class="line"></div><div class="line">  <span class="keyword">const</span> getLeft = item =&gt;</div><div class="line">    <span class="built_in">parseInt</span>(item.style.left.slice(<span class="number">0</span>, <span class="number">-2</span>)) || <span class="number">0</span> <span class="comment">// rm 'px'</span></div><div class="line"></div><div class="line">  item1.style.left = <span class="string">`<span class="subst">$&#123;this.barWidth + getLeft(item1)&#125;</span>px`</span></div><div class="line">  item2.style.left = <span class="string">`<span class="subst">$&#123;-this.barWidth + getLeft(item2)&#125;</span>px`</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在交换的时候，我们要先找到对应的 DOM 元素，也就是上面代码中的 <code>item</code> 和 <code>item2</code>。</p>
<p>怎么找？（假设我们排序的是一堆数字）<br>
一开始我想到了两种方法。</p>
<p>第一种是，根据数字，找到具有对用数字的 DOM 元素，就像这样：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">swap (value1, value2) &#123;</div><div class="line">  <span class="keyword">const</span> item1 = <span class="keyword">this</span>.el.querySelector(<span class="string">`[data-value='<span class="subst">$&#123;value1&#125;</span>']`</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>但这种方法是行不通的。为什么？<br>
因为当有多个数字相同的时候，我们找到的 DOM 元素不一定是我们想要交换的。因为 <code>querySelector</code> 返回的总是第一个匹配的元素。</p>
<p>那我们在 <code>item1</code> 后面才开始找 <code>item2</code> 行不行？使用 CSS3 的 <code>~</code> 选择器。比如这样：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">swap (value1, value2) &#123;</div><div class="line">  <span class="keyword">const</span> item1 = <span class="keyword">this</span>.el.querySelector(<span class="string">`[data-value='<span class="subst">$&#123;value1&#125;</span>']`</span>)</div><div class="line">  <span class="keyword">const</span> item2 = <span class="keyword">this</span>.el.querySelector(<span class="string">`[data-value='<span class="subst">$&#123;value2&#125;</span>'] ~ data-value='<span class="subst">$&#123;value2&#125;</span>']`</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这种方法有时可以，有时是不可以的。为什么？<br>
因为我们的 DOM 结构根本就没有变化，只是用 CSS 的 <code>left</code> 在视觉上改变了位置而已。</p>
<p>因此，我们的第二种方法当然就是在交换的时候，不仅改变 <code>left</code> 的值，而且交换 DOM 的位置。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">swapDOM</span>(<span class="params">element1, element2</span>) </span>&#123;</div><div class="line">  element1.parentNode.insertBefore(element2, element1);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>但是，这种方法还是行不通的。因为 <code>insertBefore</code> 会把 <code>element2</code> 从 DOM 中删掉。这样的话，就没有了「交换」的渐变效果。</p>
<p>果然，我们还是不能 DOM 元素。那么只能返回第一种方法。</p>
<p>这个时候我突然想到了 React 中循环的时候需要写上 <code>key</code> 属性。然后。。。然后只要把 <code>key</code> 和 数字绑定在一起，查找数字对应的 DOM 元素只需要使用 <code>key</code> 就行。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// data = [64, 39, 78, 36]</span></div><div class="line"><span class="keyword">this</span>.items = data.map((d, i) =&gt; (&#123;key: <span class="string">`key-<span class="subst">$&#123;i&#125;</span>`</span>, value: d&#125;))</div><div class="line"></div><div class="line">swap (key1, key2) &#123;</div><div class="line">  <span class="keyword">const</span> item1 = <span class="keyword">this</span>.el.querySelector(<span class="string">`[data-key='<span class="subst">$&#123;key1&#125;</span>']`</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>终于搞定了「交换」动画了，不知道有没有更好的实现方法呢？</p>
<h2 id="为什么我的-交换-动画一瞬间就跑完了"><a class="header-anchor" href="#为什么我的-交换-动画一瞬间就跑完了">#</a>为什么我的「交换」动画一瞬间就跑完了</h2>
<p>假设我们的排序算法是这样的：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">sort () &#123;</div><div class="line">  <span class="keyword">const</span> items = <span class="keyword">this</span>.items</div><div class="line"></div><div class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; items.length; i++) &#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> j = <span class="number">0</span>; j &lt; items.length - i - <span class="number">1</span>; j++) &#123;</div><div class="line">      <span class="keyword">const</span> item1 = items[j]</div><div class="line">      <span class="keyword">const</span> item2 = items[j + <span class="number">1</span>]</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (less(item2.value, item1.value)) &#123;</div><div class="line">        swap(j, j + <span class="number">1</span>, items)</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.items</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注意到，我们的 <code>swap</code> 函数是在 <code>for</code> 循环里面调用的，这是没错的。</p>
<p>然而我们的「交换」动画就跑完了，根本没有渐变的效果，我们想要的是等到前一个交换动画完成后，下一个才发生。为什么会这样？因为我们的两个 <code>for</code> 是瞬间就可以跑完的= =</p>
<p>怎么解决这个问题呢？<code>setInterval</code>？好像会把排序算法的逻辑扰乱。<br>
突然，我想到了 jQuery 好像有个动画队列的东西。</p>
<p>也就是说，<strong>我们可以把所有的动画先放在一个队列里面。然后再一个一个地出队，一个一个地调用。</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> () &#123;</div><div class="line">  <span class="keyword">for</span> () &#123;</div><div class="line">    <span class="keyword">if</span> (less(item2.value, item1.value)) &#123;</div><div class="line">      <span class="keyword">this</span>.queue.push(() =&gt; <span class="keyword">this</span>.swap(item1.key, item2.key))</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">play () &#123;</div><div class="line">  <span class="keyword">const</span> intervalId = setInterval(() =&gt; &#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.queue.length === <span class="number">0</span>) &#123;</div><div class="line">      clearInterval(intervalId)</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="keyword">const</span> swap = <span class="keyword">this</span>.queue.shift()</div><div class="line">      swap()</div><div class="line">    &#125;</div><div class="line">  &#125;, <span class="number">2</span> * <span class="number">1000</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>看了知乎上的答案，这个问题还有其他实现的方法。<strong>总的来说，就是如何解决异步编程问题。</strong></p>
<h2 id="tips"><a class="header-anchor" href="#tips">#</a>Tips</h2>
<p>可以利用 CSS 的 伪元素<code>::before</code> 以及 <code>attr</code> 函数，来实现柱形图上显示对应的数字。</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="selector-class">.bar</span><span class="selector-pseudo">::before</span> &#123;</div><div class="line">  <span class="attribute">content</span>: <span class="built_in">attr</span>(data-value);</div><div class="line">  <span class="attribute">position</span>: absolute;</div><div class="line">  <span class="attribute">top</span>: -<span class="number">16px</span>;</div><div class="line">  <span class="attribute">color</span>: <span class="number">#233</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="continue"><a class="header-anchor" href="#continue">#</a>Continue</h2>
<p>我们的代码还可以继续优化，比如接口如何设计，使得可以扩展于其他的排序算法。还有用户体验,比如，排序前中后状态的颜色都设为不同，等等。</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;TL;DR: &lt;a href=&quot;http://plnkr.co/edit/je2wWv?p=preview&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;在线例子和相关代码请查看这里。&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;本文章的目的来源于知乎的一个问题：&lt;a href
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>「译」Learning React Without Using React Part2</title>
    <link href="http://drakeleung.github.io/blog/2016/03/22/Learning-React-Without-Using-React-Part-2/"/>
    <id>http://drakeleung.github.io/blog/2016/03/22/Learning-React-Without-Using-React-Part-2/</id>
    <published>2016-03-22T08:12:22.000Z</published>
    <updated>2016-09-08T05:01:57.000Z</updated>
    
    <content type="html"><![CDATA[<p><em><a href="https://medium.com/javascript-inside/learning-react-without-using-react-part-2-703621a89432#.guh60nwi7" target="_blank" rel="external">原文链接</a></em></p>
<p>请阅读 <a href="http://drakeleung.github.io/blog/2016/03/20/Learning-React-Without-Using-React-Part-1/">Part 1</a> 如果你还没有的话。</p>
<p>让我们继续 Part1 没讲到的东西。<br>
我们这两篇文章主要是专注于如何重构我们的 todo list。现在，我们的实现包含了可以渲染整个应用的函数（组合），还有管理我们状态（state）的 <em>store</em>。然而，我们还有很多方法去优化我们的应用。<a href="http://plnkr.co/edit/fjQbQwZpQlhd5wXoc9J8?p=preview" target="_blank" rel="external">完整代码请查看这里</a>。</p>
<p>首先，我们还没有正确地处理事件。现在，我们的组件根本就没有绑定任何事件。在 React 里面，数据流是从上往下，而事件流则是从下往上（In React data flows down while events move up）。也就是说，当事件触发的时候，我们应该沿着组件链，从下往上找其对应的回调函数。比如，我们的 <code>ItemRow</code> 函数应该调用一个从 <code>props</code> 传递下来的函数。</p>
<p>那么，我们怎么实现呢？下面是一个小尝试：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">ItemRow</span> (<span class="params">props</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> className = props.completed ? <span class="string">'item completed'</span> : <span class="string">'item'</span></div><div class="line"></div><div class="line">  <span class="keyword">return</span> $(<span class="string">'&lt;li&gt;'</span>)</div><div class="line">    .on(<span class="string">'click'</span>, props.onUpdate.bind(<span class="literal">null</span>, props.id))</div><div class="line">    .addClass(className)</div><div class="line">    .attr(<span class="string">'id'</span>, props.id)</div><div class="line">    .html(props.text)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在上面，我们给 <code>list</code> 元素绑定了一个事件。当点击他们的时候，<code>onUpdate</code> 函数就会被调用。</p>
<p>现在，我们不妨定义一个函数，他可以在创建元素的时候同时为其绑定事件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">createElement</span> (<span class="params">tag, attrs, children</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> elem = $(<span class="string">'&lt;'</span>, + tag + <span class="string">'&gt;'</span>)</div><div class="line"></div><div class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> attrs) &#123;</div><div class="line">    <span class="keyword">var</span> val = attrs[key]</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (key.indexOf(<span class="string">'on'</span>) === <span class="number">0</span>) &#123;</div><div class="line">      <span class="keyword">var</span> event = key.substr(<span class="number">2</span>).toLowerCase()</div><div class="line">      elem.on(event, val)</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      elem.attr(key, val)</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> elem.html(children)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样一来，我们的 <code>ItemRow</code> 函数可以写成这样：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">function ItemRow (props) &#123;</div><div class="line">  var className = props.completed ? 'item completed' : 'item'</div><div class="line"></div><div class="line">  return createElement('li', &#123;</div><div class="line">    id: props.id,</div><div class="line">    class: props.className,</div><div class="line">    onClick: props.onUpdate.bind(null, props.id)</div><div class="line">  &#125;, props.text)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>需要注意的是 React 中的 <code>createElement</code> 函数是创建了一个 JavaScript 对象来表示 DOM 元素。还有一点，让我们来看看 React 中的 JSX 语法到底是怎样子的。</p>
<p>下面就是一个 JSX 例子：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">return</span> ( <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">'el'</span> <span class="attr">className</span>=<span class="string">'entry'</span>&gt;</span> Hello <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>)</div></pre></td></tr></table></figure>
<p>接着会转换成：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> SomeElement = React.createElement(<span class="string">'div'</span>, &#123;</div><div class="line">  id: <span class="string">'el'</span>,</div><div class="line">  className: <span class="string">'entry'</span></div><div class="line">&#125;, <span class="string">'Hello'</span>)</div></pre></td></tr></table></figure>
<p>然后调用 <code>SomeElement</code> 函数会返回一个像下面差不多的 JavaScript 对象：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="comment">// ...</span></div><div class="line">  type: <span class="string">'div'</span>,</div><div class="line">  key: <span class="literal">null</span>,</div><div class="line">  ref: <span class="literal">null</span>,</div><div class="line">  props: &#123;</div><div class="line">    children: <span class="string">'Hello'</span>,</div><div class="line">    className: <span class="string">'entry'</span>,</div><div class="line">    id: <span class="string">'el'</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>想要了解更多的话，请阅读 <a href="https://medium.com/@dan_abramov/react-components-elements-and-instances-90800811f8ca#.x2b1qra2o" target="_blank" rel="external">React Components, Elements, and Instances</a></p>
<p>回到我们的例子中，<code>onUpdate</code> 函数是从哪里来的？</p>
<p>现在来看看我们的 <code>render</code> 函数。他定义了一个 <code>updateState</code> 函数，然后通过 <code>props</code> 把这个函数传给 <code>ItemList</code> 组件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">props, node</span>) </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">updateState</span> (<span class="params">toggleId</span>) </span>&#123;</div><div class="line">    state.items.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">el</span>) </span>&#123;</div><div class="line">      <span class="keyword">if</span> (el.id === toggleId) &#123;</div><div class="line">        el.completed = !el.completed</div><div class="line">      &#125;</div><div class="line">    &#125;)</div><div class="line">    store.setState(state)</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  node.empty().append([ItemList(&#123;</div><div class="line">    items: props.items,</div><div class="line">    onUpdate: updateState</div><div class="line">  &#125;)])</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后，<code>ItemList</code> 函数会把 <code>onUpdate</code> 传到每个 <code>ItemRow</code> 。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">functions extending(base, item) &#123;</div><div class="line">  <span class="keyword">return</span> $.extend(&#123;&#125;, item, base)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">ItemsList</span> (<span class="params">props</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> createElement(<span class="string">'ul'</span>, &#123;&#125;, props.items</div><div class="line">    .map(extending.bind(<span class="literal">null</span>, &#123;onUpdate: props.onUpdate&#125;))</div><div class="line">  )</div><div class="line">    .map(ItemRow)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过以上我们实现了：数据流是从下往下的，而事件流是从下往上。这就意味着我们可以把定义在全局的监听器移除掉（用来监听点击 item 的时候，改变他的状态）。我们把这个函数移到了 <code>render</code> 函数里面，也就是前面所讲的 <code>updateState</code>。</p>
<p>** 我们还可以重构。 **</p>
<p>现在我们把 <code>input</code> 和 <code>button</code> 从 HTML 标签变成函数。因此，我们整个 HTML 文件就只剩下一个 <code>div</code> 。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span><span class="tag">&lt;/<span class="name">app</span>&gt;</span></div></pre></td></tr></table></figure>
<p>我们的 <code>input</code> 元素很容易创建，就这样：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> input = createElement(<span class="string">'input'</span>, &#123;id: <span class="string">'input'</span>&#125;)</div></pre></td></tr></table></figure>
<p>同样地，我们也可以把监听搜索框按钮点击的全局函数放在我们的 <code>SearchBar</code> 函数里面。<code>SearchBar</code> 函数会返回一个 <code>input</code> 和一个 <code>button</code> 元素，他会通过 <code>props</code> 传进来的回调函数来处理点击事件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">functions SearchBar(props) &#123;</div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">onButtonClick</span> (<span class="params">e</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> val = $(<span class="string">'#input'</span>).val()</div><div class="line">    $(<span class="string">'#input'</span>).val(<span class="string">''</span>)</div><div class="line">    props.update(val)</div><div class="line">    e.preventDefault()</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">var</span> input = createElement(<span class="string">'input'</span>, &#123;id: <span class="string">'input'</span>&#125;)</div><div class="line">  <span class="keyword">var</span> button = createElement(<span class="string">'button'</span>, &#123;</div><div class="line">    id: <span class="string">'add'</span>,</div><div class="line">    onClick: onButtonClick.bind(<span class="literal">null</span>)</div><div class="line">  &#125;, <span class="string">'Add'</span>)</div><div class="line"></div><div class="line">  <span class="keyword">return</span> createElement(<span class="string">'div'</span>, &#123;&#125;, &#123;input, button&#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们的 <code>render</code> 函数调用 <code>SearchBar</code> 的同时传递正确的 <code>props</code> 参数。在我们更新 <code>update</code> 函数之前，让我们想想 <em>re-render</em> 应该在哪里调用才是正确的。首先，忽略我们的 <code>store</code>，把注意力集中在如何在一个 high level component 中处理 <em>state</em>。</p>
<p>目前为止，所有的函数都是 <em>stateless</em> 的。接下来我们会创建一个函数，他会处理 <em>state</em> ，以及在适当的时候更新子组件（children）。</p>
<p><strong>Container Component</strong></p>
<p>让我们来创建一个 high level container 吧。与此同时，为了更好理解，你可以阅读 <a href="https://medium.com/@dan_abramov/smart-and-dumb-components-7ca2f9a7c7d0#.iy4tfncwt" target="_blank" rel="external">Presentational and Container Component</a>。</p>
<p>首先，我们给这个 container component 取名为 <code>App</code>。他所做的事情就是调用 <code>SearchBar</code> 和 <code>ItemList</code> 函数。现在，我们继续重构 <code>render</code> 函数。其实就是把代码移到 <code>App</code> 里面去而已。</p>
<p>我们不妨先来看看 <code>render</code> 现在是怎样子的：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">component, node</span>) </span>&#123;</div><div class="line">  node.empty().append(component)</div><div class="line">&#125;</div><div class="line"></div><div class="line">render(App(state), $(<span class="string">'#app'</span>))</div></pre></td></tr></table></figure>
<p>我们的 <code>render</code> 函数只是简单地把整个应用渲染到指定的节点中。但是，React 的实现会比这个复杂一点，而我们仅仅把一棵 element tree 添加到指定的根节点中而已。但是抽象起来理解的话，这个已经足够了。</p>
<p>现在，我们的 <code>App</code> 函数其实就是我们旧的 <code>render</code> 函数，除了 DOM 操作被删掉。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span> (<span class="params">props</span>) </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">updateSearchBar</span> (<span class="params">value</span>) </span>&#123;</div><div class="line">    state.items.push(&#123;</div><div class="line">      id: state.id++,</div><div class="line">      text: value,</div><div class="line">      completed: <span class="literal">false</span></div><div class="line">    &#125;)</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">updateState</span> (<span class="params">toggleId</span>) </span>&#123;</div><div class="line">    state.items.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">el</span>) </span>&#123;</div><div class="line">      <span class="keyword">if</span> (el.id === toggleId) &#123;</div><div class="line">        el.completed = !el.completed</div><div class="line">      &#125;</div><div class="line">    &#125;)</div><div class="line">    store.setState(state)</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> [</div><div class="line">    SearchBar(&#123;update: updateSearchBar&#125;),</div><div class="line">    ItemsList(&#123;items: props.items, onUpdate: updateState&#125;)</div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们还需要改进一样东西：我们访问的 <code>store</code> 是全局的，并且重新渲染的话需要调用 <code>setState</code> 函数。</p>
<p>我们现在来重构 <code>App</code> 函数，使得他的子组件重新渲染的是不需要调用 <code>store</code> 。那么应该要怎么实现呢？</p>
<p>首先我们要忽略 <code>store</code>，并且想想怎么调用 <code>setState</code> 函数，从而使得组件和他的子组件重新渲染。</p>
<p>我们需要跟踪这个 high level component 当前的状态，并且只要 <code>setState</code> 一调用，就立马重新渲染。下面是一个简单的实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span> (<span class="params">props</span>) </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getInitialState</span> (<span class="params">props</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">      items: [],</div><div class="line">      id: <span class="number">0</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">var</span> _state = getInitialState(),</div><div class="line">    _node = <span class="literal">null</span></div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">setState</span> (<span class="params">state</span>) </span>&#123;</div><div class="line">    _state = state</div><div class="line">    render()</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// ..</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们通过调用 <code>getInitialState</code> 来初始化我们的 <code>state</code> ，然后每当使用 <code>setState</code> 来更新状态的时候，我们会调用 <code>render</code> 函数。</p>
<p>而 <code>render</code> 函数要么创建一个 node，要么简单地更新 node，只要 <code>state</code> 发生改变。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">// naive implement of render</div><div class="line"></div><div class="line">function render () &#123;</div><div class="line">  var children = [</div><div class="line">    SearchBar(&#123;update: updateSearchState&#125;),</div><div class="line">    ItemList(&#123;</div><div class="line">      items: _state.items,</div><div class="line">      onUpdate: updateState</div><div class="line">    &#125;)</div><div class="line">  ]</div><div class="line"></div><div class="line">  if (!_node) &#123;</div><div class="line">    return _node = createElement('div', &#123;class: 'top'&#125;, children)</div><div class="line">  &#125; else &#123;</div><div class="line">    return _node.html(children)</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>很显然，这对性能来说是不好的。需要知道的是，React 中的 <code>setState</code> 不会渲染整个应用，而是组件和他的子组件。</p>
<p>下面是 <code>render</code> 函数的最新代码，我们调用 <code>App</code> 时不需要带任何参数，只是需要简单地调用 <code>getInitialState</code>返回初始的状态。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">component, node</span>) </span>&#123;</div><div class="line">  node.empty().append(component);</div><div class="line">&#125;</div><div class="line">render(App(), $(<span class="string">'#app'</span>));</div></pre></td></tr></table></figure>
<p><a href="http://plnkr.co/edit/ISi8AiVuYSfFIfMy9z6t?p=preview" target="_blank" rel="external">查看的所有的代码请点击这里</a></p>
<p><strong>继续改进</strong></p>
<p>如果有一个函数，他会返回一个对象。这个对象包含了 <code>setState</code> 函数，还能够区分传进来 <code>props</code> 和 组件本身自己的 <code>state</code>。</p>
<p>差不多就像下面这样：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">var App = createClass(&#123;</div><div class="line">  updateSearchState: function (string) &#123; /*...*/ &#125;,</div><div class="line"></div><div class="line">  updateState: function (obj) &#123; /*... */ &#125;,</div><div class="line"></div><div class="line">  render: function () &#123;</div><div class="line">    var children = [</div><div class="line">      SearchBar(&#123;</div><div class="line">        updateSearchState: this.updateSearchState</div><div class="line">      &#125;),</div><div class="line">      ItemsList(&#123;</div><div class="line">        items: this.state.items,</div><div class="line">        onUpdate: this.updateState</div><div class="line">      &#125;)</div><div class="line">    ]</div><div class="line"></div><div class="line">    return createElement('div', &#123;class: 'top'&#125;, children)</div><div class="line">  &#125;</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>很幸运的是，在 React 中，你可以通过调用 <code>React.createClass</code> 来创建组件。他提供了很多选择，比如 ES6 Class ，stateless function 等，<a href="https://facebook.github.io/react/docs/reusable-components.html" target="_blank" rel="external">更多请查看文档</a>。</p>
<p>综上，我们讲解了数据流如何从上往下，而事件从下往上。我们也看到了如何处理一个组件的状态。关于 React 的东西，还有很多要学习。下面的链接也许可以帮助到你。</p>
<p><strong>扩展阅读</strong></p>
<ul>
<li><a href="https://facebook.github.io/react/docs/thinking-in-react.html" target="_blank" rel="external">Thnking in React</a></li>
<li><a href="https://facebook.github.io/react/docs/getting-started.html" target="_blank" rel="external">Getting Start React</a></li>
<li><a href="https://medium.com/javascript-scene/jsx-looks-like-an-abomination-1c1ec351a918#.59q26eqe0" target="_blank" rel="external">JSX</a></li>
<li><a href="https://github.com/petehunt/react-howto" target="_blank" rel="external">React How to</a></li>
<li><a href="http://jlongster.com/Removing-User-Interface-Complexity,-or-Why-React-is-Awesome" target="_blank" rel="external">Removing User Interface Complexity, or Why React is Awesome</a></li>
<li><a href="https://medium.com/@dan_abramov/smart-and-dumb-components-7ca2f9a7c7d0#.kcyewm6ab" target="_blank" rel="external">Presentational and Container Component</a></li>
<li><a href="https://medium.com/@dan_abramov/react-components-elements-and-instances-90800811f8ca#.xis6z3p1z" target="_blank" rel="external">React Component, Elements, and Instances</a></li>
</ul>
<p><strong>结尾语</strong></p>
<p>本来打算在这篇文章讲解如何创建一个 <em>advanced state container</em> ，实现 <em>undo/redo</em> 以及更多 feature ，但是我认为已经超出了这篇文章的范围。</p>
<p>如果大家有兴趣的话，我也许会写 Part 2.1。</p>
<p><em><a href="https://medium.com/javascript-inside/learning-react-without-using-react-part-2-703621a89432#.guh60nwi7" target="_blank" rel="external">原文链接</a></em></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;em&gt;&lt;a href=&quot;https://medium.com/javascript-inside/learning-react-without-using-react-part-2-703621a89432#.guh60nwi7&quot; target=&quot;_blank&quot; rel=
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>「译」Learning React Without Using React Part 1</title>
    <link href="http://drakeleung.github.io/blog/2016/03/20/Learning-React-Without-Using-React-Part-1/"/>
    <id>http://drakeleung.github.io/blog/2016/03/20/Learning-React-Without-Using-React-Part-1/</id>
    <published>2016-03-20T05:05:34.000Z</published>
    <updated>2016-09-08T05:01:57.000Z</updated>
    
    <content type="html"><![CDATA[<p><em>原文链接：<a href="https://medium.com/javascript-inside/learn-the-concepts-part-1-418952d968cb#.femmquo5d" target="_blank" rel="external">Learning React Without Using React Part 1</a></em></p>
<p>当我们谈起 React 的时候总是有很多疑惑。下面简单地介绍了 React 以及他的一些底层原理。</p>
<p>当你完成 Part1 和 Part2 之后，你会学到什么呢？你也许就会知道你为什么需要 React 以及 Redux 类似的 state container （状态管理器）。</p>
<p>然而，<strong>你并不需要学习</strong>: JSX，ES6/ES*，Webpack，Hot Reloading，也不需要理解 Virtual DOM，甚至不需要 React 本身。</p>
<p>那么，我们首先要做的是：</p>
<p>阅读 <a href="https://github.com/tastejs/todomvc/blob/gh-pages/examples/jquery/js/app.js" target="_blank" rel="external">Jquery 实现的 TodoMVC</a> 的代码。</p>
<p>也许你会注意到有一个叫 <code>render</code> 的方法，他会在某个事件触发或者数据更新的时候被调用。现在，我们从头来实现一个例子：当 <code>input</code> 的值改变时，调用 <code>render</code> 函数，并且更新 DOM 元素。（<a href="http://plnkr.co/edit/fjQbQwZpQlhd5wXoc9J8?p=preview" target="_blank" rel="external">点击这里可查看完整的代码</a>）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> state = &#123;value: <span class="literal">null</span>&#125;</div><div class="line"></div><div class="line">$(<span class="string">'#input'</span>).on(<span class="string">'keyup'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">  state.value = $(<span class="keyword">this</span>).val().trim()</div><div class="line">  render()</div><div class="line">&#125;)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params"></span>) </span>&#123;</div><div class="line">  $(<span class="string">'#output'</span>).html(state.value)</div><div class="line">&#125;</div><div class="line"></div><div class="line">render()</div></pre></td></tr></table></figure>
<p>我们使用一个全局变量 <code>state</code> 来同步所有的东西。也就是说，当 <em>input</em> 的值改变时会更新两样东西：</p>
<ol>
<li>更新整个应用的 <code>state</code></li>
<li>更新 DOM（根据应用当前的 <code>state</code> 来调用 <code>render</code> 函数）</li>
</ol>
<p>先记住这些，我们等一下就会返回来。</p>
<p>现在，我们有了一个新想法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">output</span>(<span class="params">text</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="string">'&lt;div&gt;'</span> + text + <span class="string">'&lt;/div&gt;'</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>显然，调用 <code>output(foo)</code> 就会返回 <code>'&lt;div&gt;foo&lt;/div&gt;'</code>。</p>
<p>那么接下来：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">h2</span> (<span class="params">text</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="string">'&lt;h2&gt;'</span> + text + <span class="string">'&lt;/h2&gt;'</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">div</span> (<span class="params">text</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="string">'&lt;div&gt;'</span> + text + <span class="string">'&lt;/div&gt;'</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">header</span> (<span class="params">text</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> div(h2(text))</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(header(<span class="string">'foo'</span>) === <span class="string">'&lt;div&gt;&lt;h2&gt;foo&lt;/h2&gt;&lt;/div&gt;'</span>) <span class="comment">// true</span></div></pre></td></tr></table></figure>
<p>上面的函数都是基于一个 <em>text(input)</em> 然后返回一个 <em>string(text)</em> 。调用 <code>header</code> 的时候传入相同的参数（<em>input</em>），都会得到相同的字符串（<em>output</em>）。如果你在想思考 React 中的 <strong>stateless functions</strong> 的话，那么这个其实就是一个简化版。只是 Stateless functions 会返回一个 React Element 而不是一个简单的 string ，但是思路是一样的。</p>
<p>既然这样，我们就把这个想法应用到我们之前的例子中。我们添加了一个 <code>button</code>，用来添加 todo item 。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> state = &#123;items: [], id: <span class="number">0</span>&#125;</div><div class="line"></div><div class="line">$(<span class="string">'#add'</span>).on(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> value = $(<span class="string">'#input'</span>).val().trim()</div><div class="line">  $(<span class="string">'#input'</span>).val(<span class="string">''</span>)</div><div class="line"></div><div class="line">  state.items.push(&#123;</div><div class="line">    id: state.id++,</div><div class="line">    text: value,</div><div class="line">    completed: <span class="literal">false</span></div><div class="line">  &#125;)</div><div class="line"></div><div class="line">  render()</div><div class="line">&#125;)</div><div class="line"></div><div class="line">$(<span class="string">'#list'</span>).on(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> toggleId = <span class="built_in">parseInt</span>($(<span class="keyword">this</span>).attr(<span class="string">'id'</span>))</div><div class="line"></div><div class="line">  state.items.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">el</span>) </span>&#123;</div><div class="line">    el.id === toggleId &amp;&amp; (el.completed = !el.completed)</div><div class="line">  &#125;)</div><div class="line"></div><div class="line">  render()</div><div class="line">&#125;)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> items = state.items.map(<span class="function"><span class="keyword">function</span> (<span class="params">item</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> completed = item.completed ? <span class="string">'completed'</span> : <span class="string">''</span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="string">'&lt;li class="item + '</span> + completed + <span class="string">'" id="'</span> + item.id + <span class="string">'"&gt;('</span> +</div><div class="line">      item.id + <span class="string">') '</span> + item.text + <span class="string">'&lt;/li&gt;'</span></div><div class="line">  &#125;).join(<span class="string">''</span>)</div><div class="line"></div><div class="line">  <span class="keyword">var</span> html = <span class="string">'&lt;ul&gt;'</span> + items = <span class="string">'&lt;/ul&gt;'</span></div><div class="line"></div><div class="line">  $(<span class="string">'#list'</span>).html(html)</div><div class="line">&#125;</div><div class="line"></div><div class="line">render()</div></pre></td></tr></table></figure>
<p>效果图如下。我们的应用现在可以显示所有的 todo，也可以改变每个 todo 的状态（进行中或者完成）。</p>
<p><img src="https://cdn-images-1.medium.com/max/800/1*ouOYh6bI3q_8y1XLCoVD-A.png" alt="simple todo lsit"></p>
<p>在上面，我们定义了两个 <code>click</code> 事件，当他们触发时就会更新我们的 <code>state</code> 以及调用 <code>render</code> 函数。而 <code>render</code> 函数会创建一个 todo list 。 <code>state</code> 作为中间媒介，简化了事件和 DOM 元素之间的交互，而不是** 通过事件来直接操作 DOM ** （不需要定义每个 DOM 元素和每个事件以及他们之间的关系）。当某个 <em>action</em>（如 click 事件） 触发之后，<code>state</code> 就会更新，接着调用 <code>render</code> 函数，最后我们的应用就会更新。这样一来，就简化了好多复杂的交互。</p>
<p>上面的例子是很好的，我们不妨再来重构他。</p>
<p>可以看到，<code>render</code> 函数有一点乱。我们不妨创建一个函数，他接收一个参数（input），然后基于这个参数返回一个字符串（output）。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">ItemRow</span> (<span class="params">props</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> className = props.completed ? <span class="string">' item completed'</span> : <span class="string">'item'</span></div><div class="line">  <span class="keyword">return</span> <span class="string">'&lt;li className="'</span> + className +<span class="string">' "&gt;'</span> + props.text + <span class="string">'&lt;/li&gt;'</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">ItemsList</span> (<span class="params">props</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="string">'&lt;ul&gt;'</span> + props.items.map(ItemRow).join(<span class="string">''</span>) + <span class="string">'&lt;/ul&gt;'</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>看，现在我们的 <code>render</code> 函数优美多了：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params"></span>) </span>&#123;</div><div class="line">  $(<span class="string">'#list'</span>).html(ItemsList(&#123;</div><div class="line">    items: state.items</div><div class="line">  &#125;))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果 <code>render</code> 函数并不知道 <code>state</code> 是什么，而是期望一个 <em>input</em> 作为参数呢？好吧，现在我们可以重构一下 <code>render</code> 函数，他期望接收一个 <code>props</code> 对象（这其实就是 React Component 所期望的。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">props</span>) </span>&#123;</div><div class="line">  $(<span class="string">'#list'</span>).html(ItemsList(&#123;</div><div class="line">    items: props.items</div><div class="line">  &#125;))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在，<code>render</code> 函数并不依赖外部的状态（state），这使得我们在调用 <code>render</code> 时可以随便传入一个 <em>input</em> ，也就意味着我们的应用重新渲染时，相同的 <em>input</em> 会有相同的 <em>output</em> 。需要注意的是，DOM 操作其实是一个 side effect，但是现在我们暂时忽略他。</p>
<p>把 <code>state</code> 从 <code>render</code> 函数中分离出来，可以使得我们很容易实现 <code>Undo/Redo</code>。这也意味着每当 * 当前的 state * 改变时，我们能够创建一个 history ，保存这个当前的 state 。</p>
<p>另外一个优化就是传一个 root node 作为参数，而不是写死在 <code>render</code> 函数里面：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">props, node</span>) </span>&#123;</div><div class="line">  node.html(ItemsList(&#123;</div><div class="line">    items: props.items</div><div class="line">  &#125;))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>因此，我们可以这样调用 <code>render</code> 函数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">render(state, $(<span class="string">'#list'</span>))</div></pre></td></tr></table></figure>
<p>我们会很容易想到：当 <code>state</code> 改变的时候，能不能自动地更新应用？也就是，不用手动地调用 <code>render</code> 函数。</p>
<p>现在，我们来创建一个 <em>store</em> ，他的作用是当 <code>state</code> 改变之后，就立马调用 <code>render</code> 函数。下面的实现虽然简单，但也是一个 advanced state container 的雏形。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">createStore</span> (<span class="params">initialState</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> _state = initialState || &#123;&#125;,</div><div class="line">    _listeners = []</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">updateListeners</span> (<span class="params">state</span>) </span>&#123;</div><div class="line">    _listeners.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">listener</span>) </span>&#123;</div><div class="line">      listener.cb(state)</div><div class="line">    &#125;)</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    setState: <span class="function"><span class="keyword">function</span> (<span class="params">state</span>) </span>&#123;</div><div class="line">      _state = state</div><div class="line">      updateListeners(state)</div><div class="line">    &#125;,</div><div class="line"></div><div class="line">    getState: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">      <span class="keyword">return</span> _state</div><div class="line">    &#125;,</div><div class="line"></div><div class="line">    onUpdate: <span class="function"><span class="keyword">function</span> (<span class="params">name, cb</span>) </span>&#123;</div><div class="line">      _listeners.push(&#123;name: name, cb: cb&#125;)</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在，我们更新 <code>state</code> 只需要简单地调用 <code>setState</code> 方法。只要 <code>state</code> 一改变，我们的 <code>render</code> 函数就会被调用：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> store = createStore(store)</div><div class="line"></div><div class="line">store.onUpdate(<span class="string">'rootRender'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">state</span>) </span>&#123;</div><div class="line">  render(state, $(<span class="string">'#list'</span>))</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p><a href="http://plnkr.co/edit/fjQbQwZpQlhd5wXoc9J8?p=preview" target="_blank" rel="external">点击这里可查看完整的代码</a></p>
<p>** 现在我们学会了什么？ ** 我们知道了简单的单向数据流（one-way data flow）的原则。我们给 <code>render</code> 函数传了一个 <code>state</code> 参数，然后 <code>state</code> 就会像流水一样，流到 <code>render</code> 函数的每个层次中。比如，<code>ItemRow</code> 函数需要 <code>ItemsList</code> 给他传进正确的参数。</p>
<p>我们已经创建了多个组件（component），并且我们把这些组件组合（compose）在一起。回想一下前面的 <code>header</code> 例子，我们把 <code>div</code> 和 <code>h2</code> 函数组合成了一个 <code>header</code> 函数。并且，这些函数都是 <em>pure function</em> ，这使得所有更新都是可预测的。</p>
<p>并且，我们使用了 <em>store</em> 来管理我们的 <code>state</code>。</p>
<p>而，React 会用更好更优美的方法来实现上面这些东西。组件（组合），使用 Virtual DOM 优化渲染，单向数据流等等。</p>
<blockquote>
<p>…we can focus on examining React’s true strengths: composition, unidirectional data flow, freedom from DSLs, explicit mutation and static mental model.</p>
</blockquote>
<p>From <a href="https://medium.com/@dan_abramov/youre-missing-the-point-of-react-a20e34a51e1a" target="_blank" rel="external">Dan Abramov - you’re missing the point of react</a></p>
<p>我们可以优化的东西还有很多，比如继续优化 state container，重构我们的 listeners，实现 undo/redo，以及更多更好的 feature。<strong>这些东西我们都会在 Part 2 呈现</strong>。</p>
<p><em>原文链接：<a href="https://medium.com/javascript-inside/learn-the-concepts-part-1-418952d968cb#.femmquo5d" target="_blank" rel="external">Learning React Without Using React Part 1</a></em></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;em&gt;原文链接：&lt;a href=&quot;https://medium.com/javascript-inside/learn-the-concepts-part-1-418952d968cb#.femmquo5d&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Medium 是如何加载图片的？</title>
    <link href="http://drakeleung.github.io/blog/2016/03/01/How-Medium-Load-Images/"/>
    <id>http://drakeleung.github.io/blog/2016/03/01/How-Medium-Load-Images/</id>
    <published>2016-03-01T09:11:29.000Z</published>
    <updated>2016-09-08T05:01:57.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="what"><a class="header-anchor" href="#what">#</a>What</h2>
<p>首先，我们来看看 Medium 加载图片的效果是怎样子的：</p>
<div class="video-container"><iframe src="//player.vimeo.com/video/157258221" frameborder="0" allowfullscreen></iframe></div>
<p>我的<a href="http://drakeleung.github.io/blog/">博客首页</a>也实现了这种效果。下面我们就分析如何实现。</p>
<h2 id="how"><a class="header-anchor" href="#how">#</a>How</h2>
<p>我们随便打开 Medium 中有图片的<a href="https://medium.com/tag/javascript" target="_blank" rel="external">页面</a>，然后 <em>审查元素</em>，就可以得到：</p>

<p>简化之后得到：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">section</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"placeholder"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"prossiveMedia"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">class</span>=<span class="string">"img-samll"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">canvas</span>&gt;</span><span class="tag">&lt;/<span class="name">canvas</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">class</span>=<span class="string">"img-large"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">section</span>&gt;</span></div></pre></td></tr></table></figure>
<p>实现的过程大致如下：</p>
<ol>
<li>使用一个 <code>placeholder</code> 来防止图片 <em>collapse</em>。</li>
<li>先加载一个很小的图片</li>
<li>当这个小图片加载完毕之后，把他画在 <code>&lt;canvas&gt;</code> 里面，然后把图片弄模糊。</li>
<li>当大图片加载完毕之后，显示他。</li>
</ol>
<h2 id="do-it"><a class="header-anchor" href="#do-it">#</a>Do it</h2>
<p>首先，HTML 结构如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">"banner"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"placeholder"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">img</span></span></div><div class="line">    <span class="attr">class</span>=<span class="string">"img-small"</span></div><div class="line">    <span class="attr">src</span>=<span class="string">"https://cdn-images-1.medium.com/freeze/max/27/1*sg-uLNm73whmdOgKlrQdZA.jpeg?q=20"</span></div><div class="line">    <span class="attr">data-large</span>=<span class="string">"https://cdn-images-1.medium.com/max/1800/1*sg-uLNm73whmdOgKlrQdZA.jpeg"</span></div><div class="line">   &gt;</div><div class="line"><span class="tag">&lt;/<span class="name">section</span>&gt;</span></div></pre></td></tr></table></figure>
<p><code>.placeholder</code> 是用来撑起 <code>.banner</code> 的高度。因为如果我们想要让两张图片重叠的话，会用到 <code>position: absolute</code>，定位元素会脱离文档流，那么 <code>.banner</code> 的高度就会为 <code>0</code>。</p>
<p><code>.img-small</code> 首先加载的是小图片。大图片的 URL 放在了 <code>data-large</code> 属性里面。</p>
<p>接下来是，CSS部分：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="selector-class">.banner</span> &#123;</div><div class="line">  <span class="attribute">position</span>: relative;</div><div class="line">  <span class="attribute">overflow</span>: hidden;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="selector-class">.placeholder</span> &#123;</div><div class="line">  <span class="attribute">padding-bottom</span>: <span class="number">66.6%</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="selector-tag">img</span> &#123;</div><div class="line">  <span class="attribute">position</span>: absolute;</div><div class="line">  <span class="attribute">top</span>: <span class="number">0</span>;</div><div class="line">  <span class="attribute">left</span>: <span class="number">0</span>;</div><div class="line">  <span class="attribute">width</span>: <span class="number">100%</span>;</div><div class="line">  <span class="attribute">opacity</span>: <span class="number">0</span>;</div><div class="line">  <span class="attribute">transition</span>: opacity <span class="number">1s</span> linear;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="selector-tag">img</span><span class="selector-class">.loaded</span> &#123;</div><div class="line">  <span class="attribute">opacity</span>: <span class="number">1</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="selector-class">.img-small</span> &#123;</div><div class="line">  <span class="attribute">filter</span>: <span class="built_in">blur</span>(50px);</div><div class="line">  <span class="attribute">-webkit-filter</span>: <span class="built_in">blur</span>(50px);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>.banner</code> 设置了 <code>relative</code>，所以他成为了他 children (<code>.placeholder</code>, <code>img</code>) 的 <em>containning block</em> 了。</p>
<p>注意到，<code>.placeholder</code> 设置了 <code>padding-bottom: 66.6%</code>。<code>66.6%</code> 是相对于他的 <em>containning block</em> 的宽度，也就是 <code>.banner</code> 的宽度。<br>
这个值应该和 <code>img</code> 的高度一样，这样一来，<code>.banner</code> 的高度就是 <code>img</code> 的高度了。</p>
<p>利用 <code>transition</code> 让透明度变化有个渐变效果。</p>
<p>实现模糊效果是使用了 <code>filter: blur()</code>，而没有使用 <code>&lt;canvas&gt;</code>。</p>
<p>然后，JavaScript 代码部分比较简单：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> app = (() =&gt; &#123;</div><div class="line">  <span class="keyword">const</span> imgSmall = <span class="built_in">document</span>.querySelector(<span class="string">'.img-small'</span>)</div><div class="line"></div><div class="line">  <span class="keyword">const</span> loadImage = () =&gt; &#123;</div><div class="line">    <span class="keyword">const</span> img = <span class="keyword">new</span> Image()</div><div class="line"></div><div class="line">    img.src = imgSmall.src</div><div class="line">    img.addEventListener(<span class="string">'load'</span>, (e) =&gt; &#123;</div><div class="line">      imgSmall.classList.add(<span class="string">'loaded'</span>)</div><div class="line">    &#125;, <span class="literal">false</span>)</div><div class="line"></div><div class="line">    <span class="keyword">const</span> imgLarge = <span class="keyword">new</span> Image()</div><div class="line"></div><div class="line">    imgLarge.src = imgSmall.dataset.large</div><div class="line">    imgLarge.addEventListener(<span class="string">'load'</span>, (e) =&gt; &#123;</div><div class="line">      imgLarge.classList.add(<span class="string">'loaded'</span>)</div><div class="line">    &#125;, <span class="literal">false</span>)</div><div class="line"></div><div class="line">    imgSmall.parentNode.appendChild(imgLarge)</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    loadImage</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;)()</div><div class="line"></div><div class="line">app.loadImage()</div></pre></td></tr></table></figure>
<p>需要注意的是，我们不能直接监听 <code>.img-small</code> 的 <code>load</code> 事件，要 <code>new Image</code>，然后赋予其 <code>src</code>，然后我们就可以监听他的 <code>load</code> 事件了。</p>
<p>最后，为了凸显效果，我们要禁止缓存和设置较差的网络环境。具体做法如图：</p>

<p>实际效果如下：</p>
<iframe scrolling="no" width="100%" height="300" src="http://jsfiddle.net/5sLzjk99/embedded/js,resources,html,css,result/light" frameborder="0" allowfullscreen></iframe>
<h2 id="resources"><a class="header-anchor" href="#resources">#</a>Resources</h2>
<ul>
<li><a href="https://jmperezperez.com/medium-image-progressive-loading-placeholder/" target="_blank" rel="external">How Medium does progressive image loading</a></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;what&quot;&gt;&lt;a class=&quot;header-anchor&quot; href=&quot;#what&quot;&gt;#&lt;/a&gt;What&lt;/h2&gt;
&lt;p&gt;首先，我们来看看 Medium 加载图片的效果是怎样子的：&lt;/p&gt;
&lt;div class=&quot;video-container&quot;&gt;&lt;iframe
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>为你的JavaScript代码写测试</title>
    <link href="http://drakeleung.github.io/blog/2016/02/17/Write-Test-For-Your-JavaScript/"/>
    <id>http://drakeleung.github.io/blog/2016/02/17/Write-Test-For-Your-JavaScript/</id>
    <published>2016-02-17T11:32:51.000Z</published>
    <updated>2016-09-08T05:01:57.000Z</updated>
    
    <content type="html"><![CDATA[<p>下面会讲解如何使用 karama, jasmine 以及 webpack，来为我们的 ES6 代码编写测试。<br>
（最后我写了一个可用的例子，请查看 <a href="https://github.com/DrakeLeung/ES2015-Starter-Kit/tree/master" target="_blank" rel="external">ES2015-Starter-Kit</a> ）</p>
<h2 id="艰难的抉择"><a class="header-anchor" href="#艰难的抉择">#</a>艰难的抉择</h2>
<blockquote>
<p>首先，我们要写测试，用什么写？自己写一个函数，还是使用某个测试框架？</p>
</blockquote>
<p>看起来，后者可观一点。</p>
<blockquote>
<p>然后，有哪些测试框架可以选择？选哪个？</p>
</blockquote>
<p>于是，我们 google 之，找到 stackoverflow 的一个问题 <a href="http://stackoverflow.com/questions/300855/javascript-unit-test-tools-for-tdd" target="_blank" rel="external">JavaScript unit test tools for TDD</a>。</p>
<p>看了问题回答，很纠结，太多了不知道选择哪个！最后，我决定选择 <a href="https://karma-runner.github.io/0.13/index.html" target="_blank" rel="external">Karma</a>, <a href="https://github.com/jasmine/jasmine" target="_blank" rel="external">Jasmine</a> 和 <a href="http://mochajs.org/" target="_blank" rel="external">Mocha</a> 这三者之一，根据 Star 数量以及维护团队。</p>

<blockquote>
<p>那么，<em>Karma</em>, <em>Jasmine</em> 以及 <em>Mocha</em> 这三者之间哪个好，有什么不同？</p>
</blockquote>
<p>于是，我们不妨 google，找到了 <a href="http://stackoverflow.com/questions/24391462/what-are-the-differences-between-mocha-chai-karma-jasmine-should-js-etc-te" target="_blank" rel="external">What are the differences between mocha, chai, karma, jasmine, should.js, etc. testing frameworks?</a> 这个问题。</p>
<p>从回答中我们可以知道：<em>Karma</em> 只是一个 test runner，他负责提供 environment。而 <em>Jasmine</em> 和 <em>Mocha</em> 是编写测试脚本的框架。也就是说，我们可以选择 <em>Karma + Jasmine</em>或者 <em>Karma + Mocha</em>。我们不妨先选择前者~</p>
<p>综上所述，<strong>我们要使用 <em>Karma + Jasmine</em> 组合来为我们的 JavaScript 代码写测试</strong>。</p>
<h2 id="战斗的号角"><a class="header-anchor" href="#战斗的号角">#</a>战斗的号角</h2>
<p>接下来，我们根据文档（<a href="https://karma-runner.github.io/0.13/intro/installation.html" target="_blank" rel="external">karma - Installation</a>, <a href="https://karma-runner.github.io/0.13/intro/configuration.html" target="_blank" rel="external">karma - Configuration</a> 和 <a href="http://jasmine.github.io/2.0/introduction.html" target="_blank" rel="external">Jasmine - introduction</a>），很容易就能搞起来。</p>
<p>在这里我想说的是：当编写多个测试脚本的时候，你也许可以使用 <code>beforeEach</code> 和 <code>afterEach</code>。他们分别会在每个测试（spec）的之前和之后执行一次。</p>
<h2 id="副本"><a class="header-anchor" href="#副本">#</a>副本</h2>
<p>最后还有一个问题是<em>如何结合 <a href="http://webpack.github.io/" target="_blank" rel="external">Webpack</a></em> 来为我们的ES6代码编写测试。</p>
<p>我不得不承认，这是一个很不错的问题。然而，我也通过google找到了答案。</p>
<p>详细教程请看 <em>VueJS</em> 的 <a href="https://vuejs.github.io/vue-loader/workflow/testing.html" target="_blank" rel="external">Testing</a> 文档。</p>
<h2 id="战斗的荣耀"><a class="header-anchor" href="#战斗的荣耀">#</a>战斗的荣耀</h2>
<p>你可以为你的仓库弄一个亮晶晶的 <a href="https://docs.travis-ci.com/user/status-images/" target="_blank" rel="external">travis ci status image</a>：</p>
<p><img src="https://travis-ci.org/travis-ci/travis-web.svg?branch=master" alt=""></p>
<p>详细设置请查看 <a href="https://docs.travis-ci.com/user/getting-started/" target="_blank" rel="external">travis docs</a>以及这篇教程 <a href="http://www.sitepoint.com/testing-javascript-jasmine-travis-karma/" target="_blank" rel="external">Testing JavaScript with Jasmine, Travis, and Karma</a>。</p>
<p>最后，如果还是不懂的话，可以查看我写的一个例子：<a href="https://github.com/DrakeLeung/ES2015-Starter-Kit/tree/master" target="_blank" rel="external">ES2015-Starter-Kit</a></p>
<h2 id="resources"><a class="header-anchor" href="#resources">#</a>Resources</h2>
<ul>
<li><a href="http://stackoverflow.com/questions/300855/javascript-unit-test-tools-for-tdd" target="_blank" rel="external">JavaScript unit test tools for TDD</a></li>
<li><a href="http://stackoverflow.com/questions/24391462/what-are-the-differences-between-mocha-chai-karma-jasmine-should-js-etc-te" target="_blank" rel="external">What are the differences between mocha, chai, karma, jasmine, should.js, etc. testing frameworks?</a></li>
<li><a href="https://vuejs.github.io/vue-loader/workflow/testing.html" target="_blank" rel="external">vuejs - Testing</a></li>
<li><a href="http://www.sitepoint.com/testing-javascript-jasmine-travis-karma/" target="_blank" rel="external">Testing JavaScript with Jasmine, Travis, and Karma</a></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;下面会讲解如何使用 karama, jasmine 以及 webpack，来为我们的 ES6 代码编写测试。&lt;br&gt;
（最后我写了一个可用的例子，请查看 &lt;a href=&quot;https://github.com/DrakeLeung/ES2015-Starter-Kit/tr
    
    </summary>
    
    
      <category term="JavaScript" scheme="http://drakeleung.github.io/blog/tags/JavaScript/"/>
    
      <category term="test" scheme="http://drakeleung.github.io/blog/tags/test/"/>
    
  </entry>
  
  <entry>
    <title>实现一个简单的 AMD 模块加载器</title>
    <link href="http://drakeleung.github.io/blog/2016/02/11/implement-a-simple-AMD-module-loader/"/>
    <id>http://drakeleung.github.io/blog/2016/02/11/implement-a-simple-AMD-module-loader/</id>
    <published>2016-02-11T15:32:53.000Z</published>
    <updated>2016-09-08T05:01:57.000Z</updated>
    
    <content type="html"><![CDATA[<p>(完整代码请看<a href="https://github.com/DrakeLeung/tiny-module-loader" target="_blank" rel="external">GitHub - tiny module loader</a>)</p>
<h2 id="what"><a class="header-anchor" href="#what">#</a>What</h2>
<p>不了解JavaScript模块化的请看<a href="http://drakeleung.github.io/blog/2016/02/07/JavaScript-Module-A-Beginner-Guide/">「译」JavaScript Modules Part1: A Beginner Guide</a>。</p>
<p>简单来说，AMD规范定义了模块加载的方式是异步的而不是同步。</p>
<p>接着，语法是这样子的：<code>define</code>函数去请求依赖。其中，第一个参数是依赖的模块数组，第二个参数是函数。当依赖都加载完毕之后，就会作为参数，传进这个函数里面。</p>
<h2 id="why"><a class="header-anchor" href="#why">#</a>Why</h2>
<p>为了探究 AMD 模块加载器的原理，我们不妨尝试着从零开始实现他。</p>
<p>我们只实现一个 <code>define</code> 函数。其他后面再慢慢完善。</p>
<h2 id="how"><a class="header-anchor" href="#how">#</a>How</h2>
<p>主要分成3部分：下载依赖，执行依赖并导出，读取依赖并执行回调(递归地)。</p>
<h3 id="下载依赖"><a class="header-anchor" href="#下载依赖">#</a>下载依赖</h3>
<p>接受一个依赖模块的URL，然后用Ajax请求。这时会返回包含文件内容的字符串。</p>
<p>这个很简单，只是用<em>Promise</em>简便一点而已。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// getModule.js</span></div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">const</span> fetchDeps = name =&gt;</div><div class="line">  <span class="keyword">new</span> <span class="built_in">Promise</span>((resolve, reject) =&gt; &#123;</div><div class="line">    <span class="keyword">let</span> req = <span class="keyword">new</span> XMLHttpRequest()</div><div class="line"></div><div class="line">    req.addEventListener(<span class="string">'load'</span>, () =&gt; &#123;</div><div class="line">      <span class="keyword">if</span> (req.status &lt; <span class="number">400</span>) resolve(req.responseText)</div><div class="line">      <span class="keyword">else</span> reject(req.status)</div><div class="line">    &#125;, <span class="literal">false</span>)</div><div class="line"></div><div class="line">    req.addEventListener(<span class="string">'error'</span>, () =&gt; &#123;</div><div class="line">      reject(req.status)</div><div class="line">    &#125;, <span class="literal">false</span>)</div><div class="line"></div><div class="line">    req.open(<span class="string">'GET'</span>, name, <span class="literal">true</span>)</div><div class="line">    req.send(<span class="literal">null</span>)</div><div class="line">  &#125;)</div></pre></td></tr></table></figure>
<h3 id="执行依赖"><a class="header-anchor" href="#执行依赖">#</a>执行依赖</h3>
<p>由于请求依赖返回的是一个字符串。但我们想要的是把这个字符串当作 JavaScript 代码来执行，解决方法有2种，分别是 <code>eval()</code> 和 <code>new Function()</code>。我们采取后者。</p>
<p>还有一种方法应该可以：动态创建 <code>&lt;script&gt;</code> 标签。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// getModule.js</span></div><div class="line"></div><div class="line"><span class="keyword">let</span> currentModule = <span class="literal">null</span></div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">const</span> getModule = code =&gt; &#123;</div><div class="line">  <span class="keyword">let</span> <span class="built_in">module</span> = &#123;</div><div class="line">    exports: <span class="literal">null</span>,</div><div class="line">    exported: <span class="literal">false</span>,</div><div class="line">    onExport: []</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  currentModule = <span class="built_in">module</span></div><div class="line">  <span class="keyword">new</span> <span class="built_in">Function</span> (<span class="string">''</span>, code)() <span class="comment">// work with eval(), as well</span></div><div class="line"></div><div class="line">  <span class="keyword">return</span> <span class="built_in">module</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">export</span> &#123;</div><div class="line">  currentModule,</div><div class="line">  getModule</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里有一个我觉得是最难的问题：由于 <code>new Function()</code> 执行的时候，是不返回东西的（其实我并不知道 <code>new Function</code> 的工作原理)。</p>
<p>所以，这个时候依赖虽然是请求回来并执行了，但是他依然还没有导出(<code>exports</code>)。所以，返回的 <code>module</code> 对象的 <code>exports</code> 是 <code>null</code>的。并且，我们还用了一个变量 <code>currentModule</code> 还存储当前的变量。</p>
<h3 id="导出依赖并执行回调函数"><a class="header-anchor" href="#导出依赖并执行回调函数">#</a>导出依赖并执行回调函数</h3>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// myDefine.js</span></div><div class="line"></div><div class="line"><span class="comment">// import &#123;</span></div><div class="line"><span class="comment">//   currentModule,</span></div><div class="line"><span class="comment">//   getModule</span></div><div class="line"><span class="comment">// &#125; from './getModule'</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// import &#123;fetchDeps&#125; from './fetchDeps'</span></div><div class="line"><span class="comment">// import &#123;whenDepsExported&#125; from './whenDepsExported'</span></div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">const</span> define = (deps, callback) =&gt; &#123;</div><div class="line">  <span class="keyword">let</span> myModule = currentModule <span class="comment">// #0</span></div><div class="line">  <span class="keyword">const</span> getDeps = deps.map(fetchDeps)</div><div class="line"></div><div class="line">  <span class="built_in">Promise</span>.all(getDeps)</div><div class="line">    .then(codes =&gt; &#123;</div><div class="line">      <span class="keyword">const</span> modules = codes.map(getModule)</div><div class="line"></div><div class="line">      <span class="comment">// #1</span></div><div class="line">      modules.forEach(m =&gt;</div><div class="line">        !m.exported &amp;&amp; m.onExport.push(() =&gt;</div><div class="line">          whenDepsExported(callback, modules, myModule)</div><div class="line">        )</div><div class="line">      )</div><div class="line"></div><div class="line">      whenDepsExported(callback, modules, myModule) <span class="comment">// #2</span></div><div class="line">    &#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>#0</code> 我们把 <code>currentModule</code> 赋给一个局部变量，这样使得每个 <code>define</code> 都有自己的「模块」。这个也是困惑了我好久的一步。我也似懂非懂，因为反正已经 work 起来了= =</p>
<p>这个时候问题就来了。因为我们需要递归地加载依赖，那么，肯定是加载最外面的依赖，然后才到里面。如果没有了 <code>#1</code>，那么就会执行 <code>#2</code>，这样就会导致和想我们想要的相反，即先执行最里面的依赖的回调，再执行外面的。</p>
<p>因此，我们把最里面的模块先放到一个数组里面，然后当他的依赖执行完之后，再去执行他的回调，这时他的回调的参数才有值。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// whenDepsExported.js</span></div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">const</span> whenDepsExported = (cb, deps, myModule) =&gt; &#123;</div><div class="line">  <span class="keyword">if</span> (!deps.every(dep =&gt; dep.exported)) <span class="keyword">return</span></div><div class="line"></div><div class="line">  <span class="comment">// params for 'callback of define'</span></div><div class="line">  <span class="keyword">let</span> args = deps.map(dep =&gt; dep.exports)</div><div class="line">  <span class="keyword">let</span> exports = cb.apply(<span class="literal">null</span>, args)</div><div class="line"></div><div class="line">  <span class="comment">// #0</span></div><div class="line">  <span class="keyword">if</span> (myModule) &#123;</div><div class="line">    myModule.exports = exports</div><div class="line">    myModule.exported = <span class="literal">true</span></div><div class="line">    myModule.onExport.forEach(f =&gt; f())</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> exports</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>#0</code> 中，我们导出了依赖，并且执行了 <code>onExport</code> 的回调函数。</p>
<h2 id="wrap-up"><a class="header-anchor" href="#wrap-up">#</a>Wrap up</h2>
<p>原理看起来不是很难，但自己实现一遍还是挺难的。</p>
<p>不过 AMD，CommonJS 这些规范倒是改善了 JavaScript 模块系统，使得 JavaScript 能够在规模较大的项目中更加容易开发，以及维护。</p>
<p>(完整代码请看<a href="https://github.com/DrakeLeung/tiny-module-loader" target="_blank" rel="external">GitHub - tiny module loader</a>)</p>
<h2 id="resources"><a class="header-anchor" href="#resources">#</a>Resources</h2>
<ul>
<li><a href="http://eloquentjavascript.net/10_modules.html" target="_blank" rel="external">eloquent javascript - modules</a></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;(完整代码请看&lt;a href=&quot;https://github.com/DrakeLeung/tiny-module-loader&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;GitHub - tiny module loader&lt;/a&gt;)&lt;/p&gt;
&lt;h2
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>「译」JavaScript Modules Part2: Module Bundling</title>
    <link href="http://drakeleung.github.io/blog/2016/02/08/JavaScript-Modules-Part-2/"/>
    <id>http://drakeleung.github.io/blog/2016/02/08/JavaScript-Modules-Part-2/</id>
    <published>2016-02-08T07:57:07.000Z</published>
    <updated>2016-09-08T05:01:57.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>(原文：<a href="https://medium.freecodecamp.com/javascript-modules-part-2-module-bundling-5020383cf306#.m5o3ar7dt" target="_blank" rel="external">JavaScript Modules Part 2: Module Bundling</a>)</strong></p>
<p>在Part 1，我讲解了什么是 <em>module</em> ，为什么要使用他们，以及合并 module 的各种方法。在Part 2，我会讲解什么是 <em>bundle modules</em> : 为什么要，不同方法的实现，以及 module 在今后web开发的情况。</p>
<h2 id="什么是-module-bundling"><a class="header-anchor" href="#什么是-module-bundling">#</a>什么是 module bundling?</h2>
<p>简单来说，<em>module bundling</em> 其实就是把一组 module (以及他们的依赖)，按照正确的顺序，打包(bundle)到一个单独的文件(或者一组文件)里面。但是对于web开发来说，细节才是魔鬼 <img class="emoji" draggable="false" alt="😃" src="https://twemoji.maxcdn.com/2/72x72/1f603.png"></p>
<h2 id="为什么把所有的-module-都打包在一起？"><a class="header-anchor" href="#为什么把所有的-module-都打包在一起？">#</a>为什么把所有的 module 都打包在一起？</h2>
<p>当你把程序分成多个 module 的时候，你很可能会把他们组织在不同的文件和文件夹中。偶尔你会有第三方 module ，比如<code>Underscore</code>或者<code>React</code>。</p>
<p>那么，当用户浏览你的页面时，这些文件都会通过 <code>&lt;script&gt;</code> 标签引入到你的 HTML 文件。每个文件就需要一个 <code>&lt;script&gt;</code> 标签，就意味着，浏览器需要单独地加载每个文件，一个…接着…一个。</p>
<p>…然而这对于页面的加载时间是很不友好的。</p>
<p>为了解决这个问题，我们 <em>bundle</em>，或者 <em>concatenate</em> 所有的文件到一个大文件里面(或者一组文件，根据情况)，这样就可以减少请求的数量。这个就是你听别的开发人员所说的「build step」或者「build process」。</p>
<p>另一个加速 bundling 操作的的方法是「minify」(压缩)代码。<em>minification</em> 就是从源代码中去除不必要的字符(比如，空格，注释，换行符等)。这样一来，不仅减少了代码的大小，而且不影响其本身的功能。</p>
<p>更少的数据就意味着浏览器处理的时间更少，因为减少了下载文件的时间。如果你曾经见过文件名有后缀<code>min</code>，比如<code>underscore.min.js</code>，其实就是相对于完整版的一个不具可读性，压缩过的版本。</p>
<p>像 <em>gulp</em> 或者 <em>Grunt</em> 这样的 Task runners，对开发者来说，是很容易进行<code>concatenations</code>和<code>minification</code>。这样一来，保证了代码对开发者的可读性的同时，也保证了对浏览器的优化。</p>
<h2 id="实现bundle-module的各种方法"><a class="header-anchor" href="#实现bundle-module的各种方法">#</a>实现bundle module的各种方法</h2>
<p>当你使用标准的 module pattern (前面讲解的)的其中一种来定义 module 的时候，<em>concatenating</em> 和 <em>minifying</em> 你的文件是极好的，你所需要做的就是把你的一堆JavaScript代码打包在一起。</p>
<p>但是，当你使用浏览器不能解析的非原生模块系统时，比如 CommonJS，AMD。你需要一种特殊的工具来把你的代码转换成浏览器可以解析的。这就是为什么 <em>Browserify</em>，<em>RequireJS</em>，<em>Webpack</em>，和其他「module bundlers」又或者「module loaders」会出现。</p>
<p>为了 bundling 或者 loading 你的代码，module bundlers 提供了好多额外的 feature。比如当你修改代码时自动重编译，还有提供调试时所需要的 source maps。</p>
<p>现在让我们来看看 module bundling 的几种方法:</p>
<h3 id="bundling-commonjs"><a class="header-anchor" href="#bundling-commonjs">#</a>Bundling CommonJS</h3>
<p>从 Part1 可知，CommonJS 是同步加载 module 的，这是很好的除了对浏览器不适用之外。我提到过有解决方法——其中一种就是使用 <em>Browserify</em> 。Browserify 可以给浏览器编译 CommonJS 的 module。</p>
<p>举个例子，我们有一个 <code>main.js</code> 文件，他 <em>import</em> 了一个可以计算数组平均值的 module:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> myDependency = <span class="built_in">require</span>(‘myDependency’);</div><div class="line"><span class="keyword">var</span> myGrades = [<span class="number">93</span>, <span class="number">95</span>, <span class="number">88</span>, <span class="number">0</span>, <span class="number">91</span>];</div><div class="line"><span class="keyword">var</span> myAverageGrade = myDependency.average(myGrades);</div></pre></td></tr></table></figure>
<p>在这个例子中，我们有一个依赖(<code>myDependency</code>)。使用下面的命令，<em>Browserify</em> 会递归地把<code>main.js</code>前面所有需要的module打包到一个单独的文件里(<code>bundle.js</code>)：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">browserify main.js -o bundle.js</div></pre></td></tr></table></figure>
<p><em>Browserify</em> 的实现方法：为了遍历你整个项目的依赖，他会把每个 <code>require</code> 解析成 <a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree" target="_blank" rel="external">AST</a>。当他计算出你项目的依赖关系时，他就会按照正确的顺序把他们都打包在一个单独的文件里面。因此，你只需要把一个单独的，带上<code>bundle.js</code>的<code>&lt;script&gt;</code>标签放在你的 HTML 文件里面。这样一来，只要一个 HTTP 请求，就可以加载所有的modules。豪爽~</p>
<p>相似地，如果你有多个文件且有多个依赖，你只需要简单地告诉 <em>Browserify</em> 你的 <code>entry file</code>，然后坐下，<em>Browserify</em> 就会开始施魔法。</p>
<p>最后：准备好你打包好的文件，然后使用像 <em>Minify-JS</em> 这样的工具来压缩的你的代码。</p>
<h3 id="bundling-amd"><a class="header-anchor" href="#bundling-amd">#</a>Bundling AMD</h3>
<p>如果你使用AMD，也许你会使用一个像<code>RequireJS</code>或者<code>Curl</code>这样的AMD加载器。一个module loader(vs. a bundler)会动态地加载module，当你程序需要的时候。</p>
<p>提醒一下，AMD与CommonJS不同的地方之一是，前者是动态加载模块的。也就是说，有了AMD，你实际上不需要<em>build step</em>(打包你所有的module到一个单独文件)，因为你是动态加载module——也就是只有当你需要module的时候才去下载文件，而不是当用户第一次浏览的时候，就把所有的module都下载。</p>
<p>但在实际生产中，用户每次行为就需要请求下载对应的module是没有意义的。因此很多web开发者为了额外的性能，都会使用工具去打包和压缩他们的AMD modules，比如<em>RequireJS optimizer</em>，<em>r.js</em>。</p>
<p>总的来说，AMD和CommonJS关于bundling的区别是：前者可以不需要build step。除非，你想<em>push the code live</em>，这时你可以使用像<code>r.js</code>这样的优化器。</p>
<p>更多关于CommonJS和AMD的讨论，请查看这篇文章<a href="http://tomdale.net/2012/01/amd-is-not-the-answer/" target="_blank" rel="external">Tom Dale’s blog</a> <img class="emoji" draggable="false" alt="😃" src="https://twemoji.maxcdn.com/2/72x72/1f603.png"></p>
<h3 id="webpack"><a class="header-anchor" href="#webpack">#</a>Webpack</h3>
<p>就目前的bundlers来说，<em>Webpack</em>是锋芒初现的。他可以识别任意一种模块系统，比如CommonJS，AMD或者ES6。</p>
<p>你也许会这样想到：既然我们已经有了Browserify和RequireJS这样的工具，为什么还需要Webpack。其实，Webpack提供了很有用的feature像<strong>code splitting</strong>—把你的代码拆分成动态加载的「chuncks」。</p>
<p>比如说，如果你的web应用有一块代码是在特定情况下才加载的，那么把所有的代码打包在一个单独的很大的文件里面就不是很适合了。在这种情况下，你可以使用<em>code splitting</em>提取代码到按需加载的<em>chunks</em>里面，这样就避免了用户首次访问时需要加载体积很大的<code>bundle.js</code>。</p>
<p><em>Code splitting</em>是Webpack提供的feature之一。网上有很多讨论Webpack和Browserify的文章，不妨看下面的链接：</p>
<ul>
<li><a href="https://gist.github.com/substack/68f8d502be42d5cd4942" target="_blank" rel="external">https://gist.github.com/substack/68f8d502be42d5cd4942</a></li>
<li><a href="http://mattdesl.svbtle.com/browserify-vs-webpack" target="_blank" rel="external">http://mattdesl.svbtle.com/browserify-vs-webpack</a></li>
<li><a href="http://blog.namangoel.com/browserify-vs-webpack-js-drama" target="_blank" rel="external">http://blog.namangoel.com/browserify-vs-webpack-js-drama</a></li>
</ul>
<h2 id="es6-modules"><a class="header-anchor" href="#es6-modules">#</a>ES6 Modules</h2>
<p>接下来我会讨论ES6 modules，他也许在未来让以上的bundlers的使用变少(等一下你就会明白我在讲什么)。首先，让我们来理解ES6 modules是如何加载的。</p>
<p>ES6 modules与AMD，CMD最大的不同之处在于，前者设计时考虑到了静态分析(static analysis)。这就意味着，当你<code>import</code> 模块时，这个<code>import</code>动作在编译的时候就完成了。也就是，在执行脚本之前，可以让我们移除掉不需要的<code>exports</code>。移除掉不必要的<code>exports</code>不但可以减少空间，还能减轻浏览器的压力。</p>
<p>那么问题来了：这个和<em>dead code elimination</em>(如使用UglifyJS去压缩代码)有什么不同？答案是：<strong>看情况</strong>。</p>
<p>(注意：<em>Dead code elimination</em>其实是移除掉不必要的代码和变量。不妨这样想：他是把你<strong>打包后</strong>的程序的多余的代码和变量移除掉。</p>
<p>有时候，<em>dead code elimination</em>在ES6 module和UglifyJS中是一样的，但有时候又不是。如果你想了解更多你可以查看在<a href="https://github.com/rollup/rollup" target="_blank" rel="external">Rollup’s wiki</a>的一个很棒的例子。</p>
<p>ES6不同的地方在于实现dead code elimination的方法，叫<strong>tree shaking</strong>。Tree shaking实际上与dead code elimination的理念是相反的。他只打包了你所必需的代码，而不是把不需要的代码移除掉。让我们来看一下tree shaking的一个例子：</p>
<p>假设我们有一个<code>util.js</code>文件 ，他有多个函数，我们用ES6的语法来导出他们。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">each</span>(<span class="params">collection, iterator</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(collection)) &#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; collection.length; i++) &#123;</div><div class="line">      iterator(collection[i], i, collection);</div><div class="line">    &#125;</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> collection) &#123;</div><div class="line">      iterator(collection[key], key, collection);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params">collection, test</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> filtered = [];</div><div class="line">  each(collection, <span class="function"><span class="keyword">function</span>(<span class="params">item</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (test(item)) &#123;</div><div class="line">      filtered.push(item);</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line">  <span class="keyword">return</span> filtered;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">map</span>(<span class="params">collection, iterator</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> mapped = [];</div><div class="line">  each(collection, <span class="function"><span class="keyword">function</span>(<span class="params">value, key, collection</span>) </span>&#123;</div><div class="line">    mapped.push(iterator(value));</div><div class="line">  &#125;);</div><div class="line">  <span class="keyword">return</span> mapped;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">reduce</span>(<span class="params">collection, iterator, accumulator</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> startingValueMissing = accumulator === <span class="literal">undefined</span>;</div><div class="line">  each(collection, <span class="function"><span class="keyword">function</span>(<span class="params">item</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (startingValueMissing) &#123;</div><div class="line">      accumulator = item;</div><div class="line">      startingValueMissing = <span class="literal">false</span>;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      accumulator = iterator(accumulator, item);</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line">  <span class="keyword">return</span> accumulator;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接下来，我们假设我们并不知道我们需要<code>util.js</code>的哪一个函数，所以，在<code>main.js</code>中我们这样引入他：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> * <span class="keyword">as</span> Utils <span class="keyword">from</span> ‘./utils.js’;</div></pre></td></tr></table></figure>
<p>然后，我们开始使用其中的一个函数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> * <span class="keyword">as</span> Utils <span class="keyword">from</span> ‘./utils.js’;</div><div class="line"></div><div class="line">Utils.each([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], <span class="function"><span class="keyword">function</span>(<span class="params">x</span>) </span>&#123; <span class="built_in">console</span>.log(x) &#125;);</div></pre></td></tr></table></figure>
<p>而，<code>main.js</code>被<em>tree shaking</em>编译之后，是长这样的：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">each</span>(<span class="params">collection, iterator</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(collection)) &#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; collection.length; i++) &#123;</div><div class="line">      iterator(collection[i], i, collection);</div><div class="line">    &#125;</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> collection) &#123;</div><div class="line">      iterator(collection[key], key, collection);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">each([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], <span class="function"><span class="keyword">function</span>(<span class="params">x</span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(x)</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>注意到，只有我们使用的<code>each</code>被引入了，而不是<code>util.js</code>里所有的函数。</p>
<p>那么，如果我们使用<code>filter</code>函数而不是<code>each</code>的话，我们的<code>main.js</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> * <span class="keyword">as</span> Utils <span class="keyword">from</span> ‘./utils.js’;</div><div class="line">Utils.filter([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], <span class="function"><span class="keyword">function</span>(<span class="params">x</span>) </span>&#123; <span class="keyword">return</span> x === <span class="number">2</span> &#125;);</div></pre></td></tr></table></figure>
<p>tree shaking 编译后，<code>main.js</code>变成了这样：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">each</span>(<span class="params">collection, iterator</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(collection)) &#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; collection.length; i++) &#123;</div><div class="line">      iterator(collection[i], i, collection);</div><div class="line">    &#125;</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> collection) &#123;</div><div class="line">      iterator(collection[key], key, collection);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params">collection, test</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> filtered = [];</div><div class="line">  each(collection, <span class="function"><span class="keyword">function</span>(<span class="params">item</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (test(item)) &#123;</div><div class="line">      filtered.push(item);</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line">  <span class="keyword">return</span> filtered;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">filter([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], <span class="function"><span class="keyword">function</span>(<span class="params">x</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> x === <span class="number">2</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>注意到这个时候,<code>each</code>和<code>filter</code>都被引入了，这是因为<code>filter</code>函数是依赖于<code>each</code>的。</p>
<p>很cool，对不对？</p>
<p>我建议你通过<em>Rollup.js</em>的 <a href="http://rollupjs.org/" target="_blank" rel="external">live demo and editor</a> ，去玩玩和了解一下tree shaking。</p>
<h2 id="构建es6-modules"><a class="header-anchor" href="#构建es6-modules">#</a>构建ES6 modules</h2>
<p>好的，现在我们知道了ES6 modules的加载很其他module format是不同的，但是我们还没讲怎么构建ES6 modules。</p>
<p>不幸的是，ES6 modules 还需要额外的工作，因为浏览器还没有实现原生的ES6 module加载。</p>
<p>下面有两种方法来构建/转换 ES6 modules，使得在浏览器中可以使用。其中，第一种是当前最常见的：</p>
<ol>
<li>使用转换器(比如，Babel或者Traceur)，把你ES6代码转换成CommonJS，AMD或者UMD格式的ES5代码。然后把转换好的代码送到一个module bundler里去，比如Browserify或者Webpack，这样就创建了一个或多个打包好的文件。</li>
<li>使用<a href="http://rollupjs.org/" target="_blank" rel="external">Rollup.js</a>：这种方法和前面的很相似，除了在打包之前会使用ES6 module的静态分析。他利用<strong>tree shaking</strong>把最少的代码量打包。总体来说，Rollup.js比Webpack或者Browserify最大的好处是，当你使用ES6 module时，可以使你的代码的体积更小。需要注意的是，Rollup提供了多种格式来打包你的代码，包括ES6，CommonJS，AMD，CMD，UMD或者IIFE。IIFE和UMD可以适用于你的浏览器，但如果你选择了AMD，CommonJS或者ES6的话，你需要找其他方法把你的代码转成浏览器可以识别的，比如使用Browserify，Webpack，RequireJS等等。</li>
</ol>
<h2 id="jumping-through-hoops"><a class="header-anchor" href="#jumping-through-hoops">#</a>Jumping through hoops</h2>
<p>作为web开发者，我们需要跳过这些繁文缛节。因为把ES6 modules代码转换成浏览器可以解释的ES5不是一件易事。</p>
<p>问题就是：我们可以直接在浏览器使用ES6 module，且不用弄上面说到的两种方法吗？</p>
<p>答案是：很快。</p>
<p>ECMAScript现在已经有解决方案的规范了，叫做<a href="https://github.com/ModuleLoader/es6-module-loader" target="_blank" rel="external">ECMAScript 6 module loader API</a>。简单介绍，他是一种可编程的，基于Promise的API，可以动态加载你的modules，并且cache他们，使得随后的<code>import</code>不需要加载另外一份新版本的module。</p>
<p>他大概是这样子的：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// myModule.js</span></div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">myModule</span> </span>&#123;</div><div class="line">  <span class="keyword">constructor</span>() &#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'Hello, I am a module'</span>);</div><div class="line">  &#125;</div><div class="line">  hello() &#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'hello!'</span>);</div><div class="line">  &#125;</div><div class="line">  goodbye() &#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'goodbye!'</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// main.js</span></div><div class="line"></div><div class="line">System.import(‘myModule’).then(<span class="function"><span class="keyword">function</span>(<span class="params">myModule</span>) </span>&#123;</div><div class="line">  <span class="keyword">new</span> myModule.hello();</div><div class="line">&#125;);</div><div class="line"><span class="comment">// ‘hello!’</span></div></pre></td></tr></table></figure>
<p>另外一种方法是，你可以直接在<code>script</code>标签里，直接注明<code>type=module</code>来定义modules。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt; script type = <span class="string">"module"</span> &gt;</div><div class="line">  <span class="comment">// loads the 'myModule' export from 'mymodule.js'</span></div><div class="line">  <span class="keyword">import</span> &#123;</div><div class="line">    hello</div><div class="line">  &#125; <span class="keyword">from</span> <span class="string">'mymodule'</span>;</div><div class="line"><span class="keyword">new</span> Hello(); <span class="comment">// 'Hello, I am a module!'</span></div><div class="line">&lt; <span class="regexp">/script&gt;</span></div></pre></td></tr></table></figure>
<p>如果你还没有看过module loader API的polyfill，我强烈建议你至少去<a href="https://github.com/ModuleLoader/es6-module-loader" target="_blank" rel="external">看一看</a>。</p>
<p>如果你想要测试一下这种方法的话，你可以试试<a href="https://github.com/systemjs/systemjs" target="_blank" rel="external">SystemJS</a>。他是基于<a href="https://github.com/ModuleLoader/es6-module-loader" target="_blank" rel="external">ES6 Module Loader polyfill</a>创建的。他可以在浏览器和Node环境中，动态地加载任何格式的modules(ES6 modules，AMD，CommonJS以及全局的scripts)。他会跟踪所有已经加载到「module registry」的modules，避免了重新加载已经加载过的modules。值得提醒的是，他也可以自动地转换ES6 modules(如果你开启这个option的话)，还可以从任何一种模块格式中加载任何一种格式的模块。太棒了。</p>
<h2 id="既然我们已经有了es6-modules-还需要bundlers吗？"><a class="header-anchor" href="#既然我们已经有了es6-modules-还需要bundlers吗？">#</a>既然我们已经有了ES6 modules，还需要bundlers吗？</h2>
<p>ES6 modules的逐渐流行，产生了一些有趣的问题：</p>
<h3 id="http-2会使module-bundlers过时吗？"><a class="header-anchor" href="#http-2会使module-bundlers过时吗？">#</a>HTTP/2会使module bundlers过时吗？</h3>
<p>对于HTTP/1，我们的每个TCP连接只允许一个请求。这就是为什么加载多个资源需要多个请求。有了HTTP/2，一切都变了。HTTP/2是<em>fully multiplexed</em>，这就意味着多个请求和多个响应可以并行。这样一来，我们可以在一个TCP连接中，进行多个请求。</p>
<p>既然每个HTTP/2请求的开销已经比HTTP/1小得多，那么长远来看，加载一堆的modules并不会降低很多的性能。于是有些人就认为，module bundling已经不需要了。这其实是有可能的，但是我们还要视情况而定。</p>
<p>比如说，module bundling提供了HTTP/2没有提供的优点，像移除掉不需要的<code>exports</code>从而减少空间。如果你搭建的网页是每个微小的<code>bit</code>都会影响性能的话，那么bundling就给了你巨大的好处。另一方面，如果你对性能要求不是很高的话，你可以跳过构建过程，从而节省了一些时间。</p>
<p>总起来说，我们现在离享受HTTP/2带来的好处还很远。我个人猜测build process还会持续一段时间。</p>
<h3 id="commonjs-amd和umd还过时吗？"><a class="header-anchor" href="#commonjs-amd和umd还过时吗？">#</a>CommonJS，AMD和UMD还过时吗？</h3>
<p>一旦ES6变成了标准，那么我们真的还需要非原生的module feature吗？</p>
<p>我表示怀疑。</p>
<p>如果只遵循单一的语法去加载和引入module，并且不需要中间步骤，这对于web开发者来说很棒的。但到达这一步还需要多久呢？</p>
<p>机会是有的，但需要一段时间。</p>
<p>并且，每个人都可以根据自己的口味去选择，因此「one truthful approach」并不会成为现实。</p>
<h2 id="结论"><a class="header-anchor" href="#结论">#</a>结论</h2>
<p>当开发者讨论modules和module bundling的时候，我希望这两篇文章可以帮助他们厘清这些术语。如果你有疑问的话，你回头看看<a href="https://medium.freecodecamp.com/javascript-modules-a-beginner-s-guide-783f7d7a5fcc#.y8hs0nsne" target="_blank" rel="external">part I</a> 。</p>
<p>同样地，可以在评论中和我讨论，同时随时欢迎你提问题。</p>
<p>Happy bundling <img class="emoji" draggable="false" alt="😃" src="https://twemoji.maxcdn.com/2/72x72/1f603.png"></p>
<p><strong>(原文：<a href="https://medium.freecodecamp.com/javascript-modules-part-2-module-bundling-5020383cf306#.m5o3ar7dt" target="_blank" rel="external">JavaScript Modules Part 2: Module Bundling</a>)</strong></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;(原文：&lt;a href=&quot;https://medium.freecodecamp.com/javascript-modules-part-2-module-bundling-5020383cf306#.m5o3ar7dt&quot; target=&quot;_blank&quot; r
    
    </summary>
    
      <category term="翻译" scheme="http://drakeleung.github.io/blog/categories/%E7%BF%BB%E8%AF%91/"/>
    
    
  </entry>
  
  <entry>
    <title>「译」JavaScript Modules Part1: A Beginner Guide</title>
    <link href="http://drakeleung.github.io/blog/2016/02/07/JavaScript-Module-A-Beginner-Guide/"/>
    <id>http://drakeleung.github.io/blog/2016/02/07/JavaScript-Module-A-Beginner-Guide/</id>
    <published>2016-02-07T13:50:52.000Z</published>
    <updated>2016-09-08T05:01:57.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>(原文：<a href="https://medium.freecodecamp.com/javascript-modules-a-beginner-s-guide-783f7d7a5fcc#.4ufizwkud" target="_blank" rel="external">JavaScript Modules: A Beginner’s Guide - Preethi Kasireddy</a>)</strong></p>
<p>如果你是刚接触 JavaScript 的话，像「module bundler vs. module loaders」， 「Webpack vs. Browserify」 以及「AMD vs. CommonJS」这些术语可以一下子把你搞晕。</p>
<p>JavaScript的模块系统(module system)也许是很吓人的，但是对于web开发者来说，理解他是很重要的。</p>
<p>在本文，我会使用通俗易懂的话(以及一些代码)来解释这些术语。我希望能帮助到你。</p>
<p>注意：为了简单起见，我会分成2部分来说：Part 1 会解释什么是 <em>module</em> 以及为什么要使用他们。Part 2 (在下周发表)会接着解释什么是 <em>bundle modules</em> 以及其实现方法。</p>
<h2 id="part-1-有谁可以再解释解释什么是-module-吗？"><a class="header-anchor" href="#part-1-有谁可以再解释解释什么是-module-吗？">#</a>Part 1: 有谁可以再解释解释什么是 module 吗？</h2>
<p>好的作者会把他们的书籍分成多个章节；好的程序员也会把他们的程序分成多个模块。</p>
<p>就像书的章节一样，module 只是单词(在这里，即是 code )的集合。</p>
<p>但是，好的模块是高度包含自己独立的功能。这让他们可以根据需求更改，删除，增加，而不扰乱整个系统。</p>
<h2 id="为什么使用-module-？"><a class="header-anchor" href="#为什么使用-module-？">#</a>为什么使用 module ？</h2>
<p>使用modules对于大型，相互依赖的代码库来说是很多好处的。在我看来，最重要的是：</p>
<p>**1) 可维护性：**根据定义，module 是独立的。一个设计良好的 module 是尽可能多地减少代码的耦合，从而他能够独立地开发和改进。当一个 module 的耦合度低的时候，更新他是很容易一件事情。</p>
<p>回到我们书籍的例子，当你因为更新了一个章节，从而需要调整剩余章节的话，这简直是噩耗。相反，你更愿意编写章节的时候，不影响其他章节。</p>
<p>**2) 命名空间(namespacing)：**在 JavaScript 中，在 top-level 函数的作用域的外面的变量就是 <em>global</em> (全局)变量，全局变量即是每个人都可以 access 他们。因为这样，就很容易造成&quot;命名空间污染”，也就是无相关的代码共享全局变量。</p>
<p>在毫无相关的代码中共享全局变量在开发中 <a href="http://c2.com/cgi/wiki?GlobalVariablesAreBad" target="_blank" rel="external">is a big no no</a>。</p>
<p>在本文的下面，我们会解释 module 可以让我们避免命名空间污染，通过为我们的变量创建私有空间。</p>
<p>**3) 可重用性：**我们不妨老实承认，我们过去是把一个项目的代码copy到另一个项目中。比方说，你copy了你之前项目的一些util方法到当前的项目中。</p>
<p>这是很浪费时间的。但是慢着，如果使用 module ，一个我们可以不断复用的 module ，这不是很好吗？</p>
<h2 id="你是如何合并模块-incorporate-modules"><a class="header-anchor" href="#你是如何合并模块-incorporate-modules">#</a>你是如何合并模块(incorporate modules)?</h2>
<p>有很多方法可以在你的程序中合并模块。我们现在就来讲解他们的其中一些：</p>
<h3 id="module-pattern"><a class="header-anchor" href="#module-pattern">#</a>Module Pattern</h3>
<p><em>Module pattern</em> 其实就是模仿 <em>class</em> 的概念(因为 JavaScript 并不真正地支持 class )，因此我们可以把公有方法，私有方法以及变量都保存在一个对象里面——这个就有点类似于 class 在其他编程语言(如 Java 或者 Python )中的使用。这可以让我们给公有方法创建 API ，然后暴露出去；并且同时可以把私有的变量和方法都封装在一个闭包作用域(closure scope)中。</p>
<p>有几个方法可以实现 module pattern。在第一个例子中。我会使用 <em>anonymous closure</em>。他会把我们所有的代码都放进一个匿名函数里面。(记住：在 JavaScript 中，<code>function</code> 是创建作用域的唯一方法？)</p>
<p><strong>例子一：Anonymous closure</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="comment">// We keep these variables private inside this closure scope</span></div><div class="line"></div><div class="line">  <span class="keyword">var</span> myGrades = [<span class="number">93</span>, <span class="number">95</span>, <span class="number">88</span>, <span class="number">0</span>, <span class="number">55</span>, <span class="number">91</span>];</div><div class="line"></div><div class="line">  <span class="keyword">var</span> average = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> total = myGrades.reduce(<span class="function"><span class="keyword">function</span>(<span class="params">accumulator, item</span>) </span>&#123;</div><div class="line">      <span class="keyword">return</span> accumulator + item&#125;, <span class="number">0</span>);</div><div class="line"></div><div class="line">      <span class="keyword">return</span> <span class="string">'Your average grade is '</span> + total / myGrades.length + <span class="string">'.'</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">var</span> failing = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    <span class="keyword">var</span> failingGrades = myGrades.filter(<span class="function"><span class="keyword">function</span>(<span class="params">item</span>) </span>&#123;</div><div class="line">      <span class="keyword">return</span> item &lt; <span class="number">70</span>;&#125;);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="string">'You failed '</span> + failingGrades.length + <span class="string">' times.'</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="built_in">console</span>.log(failing());</div><div class="line"></div><div class="line">&#125;());</div><div class="line"></div><div class="line"><span class="comment">// ‘You failed 2 times.’</span></div></pre></td></tr></table></figure>
<p>有了这个，我们的匿名函数就有了它自己的求值环境(evaluation environment)或者&quot;closure&quot;，并且我们可以立马对他求值(evaluate)。这可以让我们从 parent namespace(global) 中隐藏变量。</p>
<p>这种方法的好处就是，你可以在匿名函数中使用局部变量而不会 overwrite(覆盖) 已经存在的全局变量，但与此同时，你还可以 access 全局变量，就像这样：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> global = <span class="string">'Hello, I am a global variable :)'</span>;</div><div class="line"></div><div class="line">(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="comment">// We keep these variables private inside this closure scope</span></div><div class="line"></div><div class="line">  <span class="keyword">var</span> myGrades = [<span class="number">93</span>, <span class="number">95</span>, <span class="number">88</span>, <span class="number">0</span>, <span class="number">55</span>, <span class="number">91</span>];</div><div class="line"></div><div class="line">  <span class="keyword">var</span> average = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> total = myGrades.reduce(<span class="function"><span class="keyword">function</span>(<span class="params">accumulator, item</span>) </span>&#123;</div><div class="line">      <span class="keyword">return</span> accumulator + item&#125;, <span class="number">0</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="string">'Your average grade is '</span> + total / myGrades.length + <span class="string">'.'</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">var</span> failing = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    <span class="keyword">var</span> failingGrades = myGrades.filter(<span class="function"><span class="keyword">function</span>(<span class="params">item</span>) </span>&#123;</div><div class="line">      <span class="keyword">return</span> item &lt; <span class="number">70</span>;&#125;);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="string">'You failed '</span> + failingGrades.length + <span class="string">' times.'</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="built_in">console</span>.log(failing());</div><div class="line">  <span class="built_in">console</span>.log(global);</div><div class="line">&#125;());</div><div class="line"></div><div class="line"><span class="comment">// 'You failed 2 times.'</span></div><div class="line"><span class="comment">// 'Hello, I am a global variable :)'</span></div></pre></td></tr></table></figure>
<p>注意到在匿名函数2旁的括号是必须的，因为以关键字<code>function</code>开头的语句会被认为是 <em>function declaration</em> (记住，在 JavaScript 中，你是不能定义没有名字的function declaration。) 因此，这对括号就创建一个 <em>function expression</em>。如果不明白的话，你可以<a href="http://stackoverflow.com/questions/1634268/explain-javascripts-encapsulated-anonymous-function-syntax" target="_blank" rel="external">阅读这里</a>。</p>
<p><strong>例子二：Global import</strong></p>
<p>另一个较流行的方法是 <em>global import</em> ，就像 jQuery 一样。他有点类似于上面的　<em>anonymous closure</em>，只是现在我们把全局变量作为参数传进了匿名函数中。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">globalVariable</span>) </span>&#123;</div><div class="line"></div><div class="line">  <span class="comment">// Keep this variables private inside this closure scope</span></div><div class="line">  <span class="keyword">var</span> privateFunction = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'Shhhh, this is private!'</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// Expose the below methods via the globalVariable interface while</span></div><div class="line">  <span class="comment">// hiding the implementation of the method within the</span></div><div class="line">  <span class="comment">// function() block</span></div><div class="line"></div><div class="line">  globalVariable.each = <span class="function"><span class="keyword">function</span>(<span class="params">collection, iterator</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(collection)) &#123;</div><div class="line">      <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; collection.length; i++) &#123;</div><div class="line">        iterator(collection[i], i, collection);</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> collection) &#123;</div><div class="line">        iterator(collection[key], key, collection);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  globalVariable.filter = <span class="function"><span class="keyword">function</span>(<span class="params">collection, test</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> filtered = [];</div><div class="line">    globalVariable.each(collection, <span class="function"><span class="keyword">function</span>(<span class="params">item</span>) </span>&#123;</div><div class="line">      <span class="keyword">if</span> (test(item)) &#123;</div><div class="line">        filtered.push(item);</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">    <span class="keyword">return</span> filtered;</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  globalVariable.map = <span class="function"><span class="keyword">function</span>(<span class="params">collection, iterator</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> mapped = [];</div><div class="line">    globalUtils.each(collection, <span class="function"><span class="keyword">function</span>(<span class="params">value, key, collection</span>) </span>&#123;</div><div class="line">      mapped.push(iterator(value));</div><div class="line">    &#125;);</div><div class="line">    <span class="keyword">return</span> mapped;</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  globalVariable.reduce = <span class="function"><span class="keyword">function</span>(<span class="params">collection, iterator, accumulator</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> startingValueMissing = accumulator === <span class="literal">undefined</span>;</div><div class="line"></div><div class="line">    globalVariable.each(collection, <span class="function"><span class="keyword">function</span>(<span class="params">item</span>) </span>&#123;</div><div class="line">      <span class="keyword">if</span>(startingValueMissing) &#123;</div><div class="line">        accumulator = item;</div><div class="line">        startingValueMissing = <span class="literal">false</span>;</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        accumulator = iterator(accumulator, item);</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> accumulator;</div><div class="line"></div><div class="line">  &#125;;</div><div class="line"></div><div class="line"> &#125;(globalVariable));</div></pre></td></tr></table></figure>
<p>在这个例子中，<code>globalVariable</code> 在全局中唯一的一个变量。这个方法比前一个方法好的地方在于：你可以在前面就定义全局变量，这样就方便别人阅读你的代码。</p>
<p><strong>例子三：Object interface</strong></p>
<p>创建 module 的例子还有一个就是使用独立的 <em>object interface</em>，就像这样：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> myGradesCalculate = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line"></div><div class="line">  <span class="comment">// Keep this variable private inside this closure scope</span></div><div class="line">  <span class="keyword">var</span> myGrades = [<span class="number">93</span>, <span class="number">95</span>, <span class="number">88</span>, <span class="number">0</span>, <span class="number">55</span>, <span class="number">91</span>];</div><div class="line"></div><div class="line">  <span class="comment">// Expose these functions via an interface while hiding</span></div><div class="line">  <span class="comment">// the implementation of the module within the function() block</span></div><div class="line"></div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    average: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">      <span class="keyword">var</span> total = myGrades.reduce(<span class="function"><span class="keyword">function</span>(<span class="params">accumulator, item</span>) </span>&#123;</div><div class="line">        <span class="keyword">return</span> accumulator + item;</div><div class="line">        &#125;, <span class="number">0</span>);</div><div class="line"></div><div class="line">      <span class="keyword">return</span><span class="string">'Your average grade is '</span> + total / myGrades.length + <span class="string">'.'</span>;</div><div class="line">    &#125;,</div><div class="line"></div><div class="line">    failing: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">      <span class="keyword">var</span> failingGrades = myGrades.filter(<span class="function"><span class="keyword">function</span>(<span class="params">item</span>) </span>&#123;</div><div class="line">          <span class="keyword">return</span> item &lt; <span class="number">70</span>;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">      <span class="keyword">return</span> <span class="string">'You failed '</span> + failingGrades.length + <span class="string">' times.'</span>;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;)();</div><div class="line"></div><div class="line">myGradesCalculate.failing(); <span class="comment">// 'You failed 2 times.'</span></div><div class="line">myGradesCalculate.average(); <span class="comment">// 'Your average grade is 70.33333333333333.'</span></div></pre></td></tr></table></figure>
<p>显而易见，这种方法可以让我们自己定义哪些变量/方法是私有的(例如，<code>myGrads</code>)，以及哪些变量/方法是我们想要暴露给他们的，通过 <code>return</code> 语句(比如，<code>average</code> &amp; <code>failing</code>)。</p>
<p><strong>例子四：Revealing module pattern</strong></p>
<p>这个跟上面的方法是很相似的，除了他保证所有的变量和方法都是私有的，直到我们显式地暴露出去：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> myGradesCalculate = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line"></div><div class="line">  <span class="comment">// Keep this variable private inside this closure scope</span></div><div class="line">  <span class="keyword">var</span> myGrades = [<span class="number">93</span>, <span class="number">95</span>, <span class="number">88</span>, <span class="number">0</span>, <span class="number">55</span>, <span class="number">91</span>];</div><div class="line"></div><div class="line">  <span class="keyword">var</span> average = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> total = myGrades.reduce(<span class="function"><span class="keyword">function</span>(<span class="params">accumulator, item</span>) </span>&#123;</div><div class="line">      <span class="keyword">return</span> accumulator + item;</div><div class="line">      &#125;, <span class="number">0</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span><span class="string">'Your average grade is '</span> + total / myGrades.length + <span class="string">'.'</span>;</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  <span class="keyword">var</span> failing = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> failingGrades = myGrades.filter(<span class="function"><span class="keyword">function</span>(<span class="params">item</span>) </span>&#123;</div><div class="line">        <span class="keyword">return</span> item &lt; <span class="number">70</span>;</div><div class="line">      &#125;);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="string">'You failed '</span> + failingGrades.length + <span class="string">' times.'</span>;</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  <span class="comment">// Explicitly reveal public pointers to the private functions</span></div><div class="line">  <span class="comment">// that we want to reveal publicly</span></div><div class="line"></div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    average: average,</div><div class="line">    failing: failing</div><div class="line">  &#125;</div><div class="line">&#125;)();</div><div class="line"></div><div class="line">myGradesCalculate.failing(); <span class="comment">// 'You failed 2 times.'</span></div><div class="line">myGradesCalculate.average(); <span class="comment">// 'Your average grade is 70.33333333333333.'</span></div></pre></td></tr></table></figure>
<p>上面好像讲了好多东西，其实对于 module pattern 来说，只是冰山一角。下面是一些我认为比较有用的资源：</p>
<ul>
<li><a href="https://addyosmani.com/resources/essentialjsdesignpatterns/book/#modulepatternjavascript" target="_blank" rel="external">Learn JavaScript Design Patterns</a> - by <em>Addy Osmani</em></li>
<li><a href="http://www.adequatelygood.com/JavaScript-Module-Pattern-In-Depth.html" target="_blank" rel="external">Adequately Good by Ben Cherry</a> - 通过例子讲述module pattern的高级使用</li>
<li><a href="https://carldanley.com/js-module-pattern/" target="_blank" rel="external">Blog of Carl Danley</a> - module pattern的概述以及其他 JavaScript pattern 的资源</li>
</ul>
<h2 id="commonjs-and-amd"><a class="header-anchor" href="#commonjs-and-amd">#</a>CommonJS and AMD</h2>
<p>上面讲到的所有方法都有一个共同点：使用全局变量将其所有代码都封装在一个函数里面，从而使用 <em>closure scope</em> 为他自己创建出了一个私有的命名空间。</p>
<p>他们各自有各自的优点，但是他们也有他们的弊端。</p>
<p>其中一个，作为一名开发者，为了加载你的文件，你需要知道正确的依赖顺序。比如，你要在项目中使用 <code>Backbone</code>，那么你需要通过 <code>script</code> 标签来加载他的源文件。</p>
<p>但是，因为 <code>Backbone</code> 是依赖 <code>Underscore.js</code>，那么加载 <code>Backbone</code> 的 <code>script</code> 标签就不能在 <code>Underscore</code> 的前面。</p>
<p>作为一名开发者，维护依赖以及让他们的顺序都正确的话，有时是一件很头疼的事情。</p>
<p>另一个弊端就是他们仍然会产生命名空间冲突。比如，你的两个 module 具有相同的名字。又或者，你的一个模块有两个版本，并且你同时需要他们。</p>
<p>因此，你也会这样想到：能不能设计一种方法，既可以访问 module 的接口，但同时又不污染全局作用域。</p>
<p>其实有两种已经实现好的方法：即是 CommonJS 和 AMD 。</p>
<h3 id="commonjs"><a class="header-anchor" href="#commonjs">#</a>CommonJS</h3>
<p>CommonJS是一个自愿的工作小组，设计和实现 JavaScript 模块系统的 API。</p>
<p>一个 CommonJS 模块其实就是 <code>exports</code> 了具体对象的 JavaScript 代码块，使得他们能够被程序中的其他模块 <code>require</code> 。如果你写过 <code>Node.js</code> 的话，你应该对他很熟悉。</p>
<p>有了 CommonJS，每个 JavaScript 文件在他们各自唯一的 module context (就像封装在一个闭包中)保存了模块。在这个作用域里面，我们使用 <code>module.exports</code> 对象来暴露模块，使用<code>require</code>来加载他们。</p>
<p>当你定义了一个 CommonJS 文件，也许他就长这样子的：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">myModule</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">this</span>.hello = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">'hello!'</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">this</span>.goodbye = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">'goodbye!'</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = myModule;</div></pre></td></tr></table></figure>
<p>我们使用特殊的对象<code>module</code>，然后把我们函数的引用赋给<code>module.exports</code>。这个让CommonJS的模块系统知道我们想要暴露哪些，从而让别的文件引用。</p>
<p>然后，如果别人想使用我的<code>myModule</code>，他们可以引用它到文件中，像这样：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> myModule = <span class="built_in">require</span>(<span class="string">'myModule'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> myModuleInstance = <span class="keyword">new</span> myModule();</div><div class="line">myModuleInstance.hello(); <span class="comment">// 'hello!'</span></div><div class="line">myModuleInstance.goodbye(); <span class="comment">// 'goodbye!'</span></div></pre></td></tr></table></figure>
<p>这个方法比前面所讲的 <em>module pattern</em> 有2个明显的优点：</p>
<ol>
<li>避免全局命名空间的污染</li>
<li>让我们的依赖更加清晰</li>
</ol>
<p>而且，语法很简洁，我很喜欢。</p>
<p>还有一个注意的是，CommonJS是针对server实现的，并且<strong>同步加载modules</strong>。这是很重要的，因为如果我们有3个module需要引入，那么他会一个接着一个加载。</p>
<p>现在，CommonJS对于server端很极好的。但是不幸的是，他不适用于浏览器。因为在web读取一个module比在磁盘中读取慢得多。如果开始加载module，就会阻塞浏览器直到modules全部加载完毕。(我会在 Part 2 讲述解决方法)。</p>
<h3 id="amd"><a class="header-anchor" href="#amd">#</a>AMD</h3>
<p>CommonJS是很好，但是如果我们想要异步加载modules呢？答案就是<em>Asynchronous Module Definition</em>，即<em>AMD</em>。</p>
<p>使用AMD加载module就像这样：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">define([<span class="string">'myModule'</span>, <span class="string">'myOtherModule'</span>], <span class="function"><span class="keyword">function</span>(<span class="params">myModule, myOtherModule</span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(myModule.hello());</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><code>define</code>函数的第一个参数是一个数组，他包含了所需的依赖。这些依赖会在背后加载(不会阻塞)，而且一旦加载完毕，<code>define</code>就会调用传给他的callback函数。</p>
<p>接着，callback函数就会把加载好的依赖作为他的参数——在上面例子中，即是<code>myModule</code>和<code>myOtherModule</code>。最后，这些依赖他们自己必须通过关键字<code>define</code>来定义。</p>
<p>比如，<code>myModule</code>也许是这样子的：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">define([], <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    hello: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">      <span class="built_in">console</span>.log(<span class="string">'hello'</span>);</div><div class="line">    &#125;,</div><div class="line">    goodbye: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">      <span class="built_in">console</span>.log(<span class="string">'goodbye'</span>);</div><div class="line">    &#125;</div><div class="line">  &#125;;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>不像CommonJS，AMD是以浏览器为核心来实现异步加载module的。(注意到，有很多人强烈地认为动态加载文件是不好的，这个我们在Part 2会讲到)。</p>
<p>除了异步之外，AMD的另一个优点是，你的module可以是对象，函数，构造函数，字符串，JSON以及其他类型。而CommonJS只支持对象作为module。</p>
<p>总的来说，AMD并不兼容io，文件系统，以及其他面向server的feature，并且，封装的语法比<code>require</code>较复杂一点。</p>
<h3 id="umd"><a class="header-anchor" href="#umd">#</a>UMD</h3>
<p>对于需要你同时支持AMD和CommonJS的项目，你可以选择<em>Universal Module Definition (UMD)</em>。</p>
<p>UMD本质上创建了一个方式，支持他们其中的一种，也支持全局变量的定义。因此，UMD module可以同时在client和server端使用。</p>
<p>让我们来看看UMD是怎样子的：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">root, factory</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> define === <span class="string">'function'</span> &amp;&amp; define.amd) &#123;</div><div class="line">      <span class="comment">// AMD</span></div><div class="line">    define([<span class="string">'myModule'</span>, <span class="string">'myOtherModule'</span>], factory);</div><div class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> exports === <span class="string">'object'</span>) &#123;</div><div class="line">      <span class="comment">// CommonJS</span></div><div class="line">    <span class="built_in">module</span>.exports = factory(<span class="built_in">require</span>(<span class="string">'myModule'</span>), <span class="built_in">require</span>(<span class="string">'myOtherModule'</span>));</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="comment">// Browser globals (Note: root is window)</span></div><div class="line">    root.returnExports = factory(root.myModule, root.myOtherModule);</div><div class="line">  &#125;</div><div class="line">&#125;(<span class="keyword">this</span>, <span class="function"><span class="keyword">function</span> (<span class="params">myModule, myOtherModule</span>) </span>&#123;</div><div class="line">  <span class="comment">// Methods</span></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">notHelloOrGoodbye</span>(<span class="params"></span>)</span>&#123;&#125;; <span class="comment">// A private method</span></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">hello</span>(<span class="params"></span>)</span>&#123;&#125;; <span class="comment">// A public method because it's returned (see below)</span></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">goodbye</span>(<span class="params"></span>)</span>&#123;&#125;; <span class="comment">// A public method because it's returned (see below)</span></div><div class="line"></div><div class="line">  <span class="comment">// Exposed public methods</span></div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">      hello: hello,</div><div class="line">      goodbye: goodbye</div><div class="line">  &#125;</div><div class="line">&#125;));</div></pre></td></tr></table></figure>
<p>更多关于UMD的例子，请查看 <a href="https://github.com/umdjs/umd" target="_blank" rel="external">enlightening repo</a>。</p>
<h2 id="native-js"><a class="header-anchor" href="#native-js">#</a>Native JS</h2>
<p>哈！你居然能看到这里，看来我没有搞晕你。太棒了。因为在结束之前，我们还有一个定义module的方法。</p>
<p>如你所见，上面的方法没有一种是原生JavaScript支持的。相反，我们使用了各种各样的方式去模拟一个模块系统。</p>
<p>幸运的是，在TC39工作的人(设计ECMAScript的语法和语义)在ES6实现了内置的模块系统。</p>
<p>下面的资源很好地讲解了ES6的模块系统：</p>
<ul>
<li><a href="http://jsmodules.io/cjs.html" target="_blank" rel="external">jsmodules.io</a></li>
<li><a href="http://exploringjs.com/es6/ch_modules.html" target="_blank" rel="external">exploringjs.com</a></li>
</ul>
<p>ES6的module结合了CommonJS和AMD的优点，比如简洁的语法和异步加载。还有优点是，比如支持循环依赖。</p>
<p>我最喜欢的ES6 modules的feature是，<em>imports</em>是<em>exports</em>的<strong>live read-only views</strong>(而CommonJS的import只是exports的一份copy而已，并且不是即时)。</p>
<p>下面例子会讲述live read-only view是怎样子的：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// lib/counter.js</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> counter = <span class="number">1</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">increment</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  counter++;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">decrement</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  counter--;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line">  counter: counter,</div><div class="line">  increment: increment,</div><div class="line">  decrement: decrement</div><div class="line">&#125;;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// src/main.js</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> counter = <span class="built_in">require</span>(<span class="string">'../../lib/counter'</span>);</div><div class="line"></div><div class="line">counter.increment();</div><div class="line"><span class="built_in">console</span>.log(counter.counter); <span class="comment">// 1</span></div></pre></td></tr></table></figure>
<p>在这个例子中，我们创建了module的<strong>2份copy</strong>：一个是当我们<code>export</code>他，另一个是当我们<code>require</code>他。</p>
<p>并且，在<code>main.js</code>的那份copy已经和原本的失去连接了。这就是为什么当我们给<code>counter</code>增加时他还是<code>1</code>——因为我们<code>import</code>的<code>counter</code>已经和原来的失去联系。</p>
<p>因为，增加<code>counter</code>会在原来的module可以实现，但是在你copy的那份就实现不了。如果想要后者实现的话，只能手动地操作了：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">counter.counter++;</div><div class="line"><span class="built_in">console</span>.log(counter.counter); <span class="comment">// 2</span></div></pre></td></tr></table></figure>
<p>在另一个方面，ES6对于我们<code>import</code>的module创建了一个<strong>live read-only view</strong>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// lib/counter.js</span></div><div class="line"><span class="keyword">export</span> <span class="keyword">let</span> counter = <span class="number">1</span>;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">increment</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  counter++;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">decrement</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  counter--;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// src/main.js</span></div><div class="line"><span class="keyword">import</span> * <span class="keyword">as</span> counter <span class="keyword">from</span> <span class="string">'../../counter'</span>;</div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(counter.counter); <span class="comment">// 1</span></div><div class="line">counter.increment();</div><div class="line"><span class="built_in">console</span>.log(counter.counter); <span class="comment">// 2</span></div></pre></td></tr></table></figure>
<p>很cool，对吧。</p>
<h2 id="向前看：bunding-modules"><a class="header-anchor" href="#向前看：bunding-modules">#</a>向前看：bunding modules</h2>
<p>哇。时间过得真快。我真的希望能够帮助你更好地理解JavaScript的modules。</p>
<p>在下一部分，我会讲<strong>module bundling</strong>，涉及到几个核心的主题：</p>
<ul>
<li>为什么我们需要<em>module bundling</em></li>
<li>不同方法实现<em>bundling</em></li>
<li>ECMAScript的模块加载器API</li>
<li>…更多…</li>
</ul>
<p>注意：为了简单起见，我跳过了许多细节(比如，循环依赖)。如果我留下了很重要或者很棒的东西，请留言让我知道！</p>
<p><strong>(原文：<a href="https://medium.freecodecamp.com/javascript-modules-a-beginner-s-guide-783f7d7a5fcc#.4ufizwkud" target="_blank" rel="external">JavaScript Modules: A Beginner’s Guide - Preethi Kasireddy</a>)</strong></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;(原文：&lt;a href=&quot;https://medium.freecodecamp.com/javascript-modules-a-beginner-s-guide-783f7d7a5fcc#.4ufizwkud&quot; target=&quot;_blank&quot; rel=&quot;
    
    </summary>
    
      <category term="翻译" scheme="http://drakeleung.github.io/blog/categories/%E7%BF%BB%E8%AF%91/"/>
    
    
  </entry>
  
  <entry>
    <title>迷之前端轮子 - 实现 ES2015 Promise</title>
    <link href="http://drakeleung.github.io/blog/2016/02/06/Promise/"/>
    <id>http://drakeleung.github.io/blog/2016/02/06/Promise/</id>
    <published>2016-02-06T09:59:59.000Z</published>
    <updated>2016-09-08T05:01:57.000Z</updated>
    
    <content type="html"><![CDATA[<p>(所有代码请查看<a href="https://github.com/DrakeLeung/tiny-promise" target="_blank" rel="external">GitHub tiny-promise</a>)</p>
<h2 id="why"><a class="header-anchor" href="#why">#</a>Why</h2>
<p>在此之前，我一直不明白 <em>promise</em> 的workflow是怎样子的。所以在使用的时候，一直很迷惑。比如，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> p1 = <span class="keyword">new</span> <span class="built_in">Promise</span>((resolve, reject) =&gt; &#123;</div><div class="line">  setTimeout(() =&gt; resolve(<span class="string">'success'</span>), <span class="number">1000</span>)</div><div class="line">&#125;)</div><div class="line"></div><div class="line">p1.then(msg =&gt; <span class="built_in">console</span>.log(msg))</div></pre></td></tr></table></figure>
<p>对于上面的代码，之前的我只知道<code>resolve</code>的参数<code>success</code>会传给<code>then</code>的<code>msg</code>。但是为什么呢？而且，我更没想过到底是<code>then</code>先执行呢还是<code>resolve</code>先执行？这有什么影响？</p>
<h2 id="how"><a class="header-anchor" href="#how">#</a>How</h2>
<p>那么，就让我们从零开始实现一个promise吧。</p>
<h3 id="promise-constructor"><a class="header-anchor" href="#promise-constructor">#</a>Promise Constructor</h3>
<p>根据<a href="http://devdocs.io/javascript/global_objects/promise" target="_blank" rel="external">docs</a>，<code>Promise</code>这个构造函数只接受一个参数，且这个参数是一个<code>function</code>。他有2个参数，分别是<code>resolve</code>和<code>reject</code>。<br>
我们要在构造函数里面执行<code>executor</code>函数，并且传2个参数给他。</p>
<p>并且，我们构造函数还有一些property，比如他的状态，数据等</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">TinyPromise</span> (<span class="params">executor</span>) </span>&#123;</div><div class="line">  <span class="keyword">this</span>.state = promiseState.PENDING</div><div class="line">  <span class="keyword">this</span>.msg = <span class="keyword">void</span> <span class="number">0</span></div><div class="line">  <span class="keyword">this</span>.chains = [] <span class="comment">// 在`then()`时再讲</span></div><div class="line"></div><div class="line">  executor(resolve, reject)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接着，定义<code>resolve</code>和<code>reject</code>这2个传给<code>executor</code>的参数</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> resolve = <span class="function"><span class="keyword">function</span> (<span class="params">value</span>) </span>&#123;</div><div class="line">  <span class="keyword">let</span> self = <span class="keyword">this</span></div><div class="line"></div><div class="line">  <span class="keyword">if</span> (self.state !== promiseState.FULLFILLED) &#123; <span class="comment">// #0</span></div><div class="line">    self.state = promiseState.FULLFILLED</div><div class="line">    self.msg = value</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  notify(self) <span class="comment">// 下面再讲</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>#0</code>为什么要加上<code>if</code>判断呢？因为有可能<code>resolve</code>并不是异步执行的，所以在调用<code>then()</code>的时候，promise的状态已经为<code>fullfilled</code>了，所以这个时候<code>value</code>是<code>undefined</code>的。你可以自己试试。</p>
<p>到底<code>chains</code>是什么呢？</p>
<h3 id="then"><a class="header-anchor" href="#then">#</a>Then</h3>
<p>当调用<code>then</code>的时候，他会返回一个promise。重复之，便形成了链(chain)。因此，我们每次都把这个promise放进<code>this.chains</code>里面。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">this</span>[<span class="string">'then'</span>] = (onFullfilled, onRejected) =&gt; &#123;</div><div class="line">  <span class="keyword">let</span> o = &#123;</div><div class="line">    onFullfilled,</div><div class="line">    onRejected</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  o.promise = <span class="keyword">new</span> <span class="keyword">this</span>.constructor((resolve, reject) =&gt; &#123;</div><div class="line">    o = <span class="built_in">Object</span>.assign(o, &#123;resolve, reject&#125;)</div><div class="line">  &#125;)</div><div class="line"></div><div class="line">  <span class="keyword">this</span>.chains = [...this.chains, o]</div><div class="line"></div><div class="line">  <span class="comment">// doesn't call resolve or reject in executor async-ly</span></div><div class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.state === promiseState.FULLFILLED) <span class="comment">// #0</span></div><div class="line">    resolve.call(<span class="keyword">this</span>)</div><div class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.state === promiseState.REJECTED)</div><div class="line">    reject.call(<span class="keyword">this</span>)</div><div class="line"></div><div class="line">  <span class="keyword">return</span> o.promise</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在<code>#0</code>，我们为什么需要做这个判断呢？因为在调用<code>then</code>时，promise的状态已经不是<code>pending</code>了。为什么？看看文本前面的<em>Why</em>部分。</p>
<p>注意到，我们把<code>then</code>的2个参数，以及<code>executor</code>的2个参数都放进了<code>this.chains</code>里面。</p>
<h3 id="notify"><a class="header-anchor" href="#notify">#</a>Notify</h3>
<p><code>notify</code>函数的作用就是把<code>then</code>返回的结果传递到下一个<code>then</code>里面去。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> handleFullfill = (chain, self) =&gt; &#123;</div><div class="line">  <span class="comment">// 上一个then()的success handler的返回值</span></div><div class="line">  <span class="keyword">const</span> result = chain.onFullfilled(self.msg)</div><div class="line">  <span class="comment">// 传给下一个then()</span></div><div class="line">  chain.resolve(result)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">const</span> notify = self =&gt; &#123;</div><div class="line">  self.chains.forEach(chain =&gt; &#123;</div><div class="line">    <span class="keyword">switch</span> (self.state) &#123;</div><div class="line">      <span class="keyword">case</span> promiseState.FULLFILLED:</div><div class="line">        handleFullfill(chain, self)</div><div class="line">        <span class="keyword">break</span></div><div class="line"></div><div class="line">      <span class="keyword">case</span> promiseState.REJECTED:</div><div class="line">        handleReject(chain, self)</div><div class="line">        <span class="keyword">break</span></div><div class="line">    &#125;</div><div class="line">  &#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="promise-resolve"><a class="header-anchor" href="#promise-resolve">#</a>Promise.resolve</h3>
<p>这个方法<code>resolve</code>其实就是<code>Promise</code>构造函数的一个property。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">defineProp(TinyPromise, <span class="string">'resolve'</span>, msg =&gt;</div><div class="line">  <span class="keyword">new</span> TinyPromise((resolve, reject) =&gt; &#123;</div><div class="line">    resolve(msg)</div><div class="line">  &#125;)</div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">const</span> defineProp = (</div><div class="line">  obj = &#123;&#125;,</div><div class="line">  prop,</div><div class="line">  value</div><div class="line">) =&gt; &#123;</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    <span class="keyword">return</span> <span class="built_in">Object</span>.defineProperties(obj, prop, &#123;</div><div class="line">      value,</div><div class="line">      writable: <span class="literal">true</span>,</div><div class="line">      configurable: <span class="literal">true</span>,</div><div class="line">      enumerate: <span class="literal">true</span></div><div class="line">    &#125;)</div><div class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</div><div class="line">    obj[prop] = value</div><div class="line">    <span class="keyword">return</span> obj</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="wrap-up"><a class="header-anchor" href="#wrap-up">#</a>Wrap up</h2>
<p>实现完以上，你就可以解决本文前面部分<em>Why</em>的问题了。</p>
<p><code>then</code>首先会执行，因为<code>resolve</code>是异步的(<code>setTimeout</code>里面)。这时，我们把<code>then</code>的参数放在一个对象数组里面。等到<code>resolve</code>调用的时候，我们再去遍历这个数组，调用<code>then</code>的参数，并且把返回值传给下一个promise。</p>
<p>如果<code>resolve</code>不是异步的话，那么<code>resolve</code>比<code>then</code>先执行。在<code>then</code>执行的时候，状态已经为<code>fullfilled</code>了。因此只需要直接调用<code>notify</code>函数。</p>
<p>Cool~</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;(所有代码请查看&lt;a href=&quot;https://github.com/DrakeLeung/tiny-promise&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;GitHub tiny-promise&lt;/a&gt;)&lt;/p&gt;
&lt;h2 id=&quot;why&quot;&gt;&lt;a 
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>迷之前端轮子 - 实现一个简单的 Virtual DOM</title>
    <link href="http://drakeleung.github.io/blog/2016/01/31/Virtual-DOM/"/>
    <id>http://drakeleung.github.io/blog/2016/01/31/Virtual-DOM/</id>
    <published>2016-01-31T05:30:49.000Z</published>
    <updated>2016-09-08T05:01:57.000Z</updated>
    
    <content type="html"><![CDATA[<p>最近实现了一个简单版的<a href="https://github.com/DrakeLeung/little-virtual-DOM" target="_blank" rel="external">Virtual DOM</a>。<br>
之所以简单，是因为并没有实现React的diff算法，不过我们还是可以了解一下Virtual DOM。</p>
<h2 id="what"><a class="header-anchor" href="#what">#</a>What</h2>
<p><em>Virtual DOM</em> 其实就是用JS对象去表示DOM元素。</p>

<h2 id="why"><a class="header-anchor" href="#why">#</a>Why</h2>
<p>为什么要Virtual DOM呢？因为DOM的操作本身是很慢的。但更慢的是批量操作时的不当。</p>
<p>比如，我们要添加5个<code>&lt;li&gt;</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> appendElement =</div><div class="line">  type =&gt;</div><div class="line">    () =&gt;</div><div class="line">      <span class="built_in">document</span>.body.appendChild(<span class="built_in">document</span>.createElement(type))</div><div class="line"></div><div class="line"><span class="built_in">Array</span>.from(<span class="built_in">Array</span>(<span class="number">5</span>)).forEach(appendElement(<span class="string">'li'</span>))</div></pre></td></tr></table></figure>
<p>上面每次生成一个<code>li</code>就插入，这样是很慢的。正确的做法应该是先生成5个<code>li</code>，然后再一次性把这个5个<code>li</code>插入。这个过程，我们就可以使用Virtual DOM来实现。</p>
<h2 id="how"><a class="header-anchor" href="#how">#</a>How</h2>
<p>总共分4个步骤，如下图所示：</p>

<h3 id="vnode"><a class="header-anchor" href="#vnode">#</a>VNode</h3>
<p><code>VNode</code>这个函数是用JavaScript对象来表示DOM元素，比如：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">id</span>=<span class="string">"item1"</span>&gt;</span>Call Me Item 1<span class="tag">&lt;/<span class="name">li</span>&gt;</span></div></pre></td></tr></table></figure>
<p>可以表示为:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  type: <span class="string">'li'</span>,</div><div class="line">  props: &#123;</div><div class="line">    id: <span class="string">'item1'</span></div><div class="line">  &#125;,</div><div class="line">  children: [<span class="string">'item1'</span>]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当然，<code>props</code>可以是数组，<code>children</code> 也可以放在<code>props</code>里面。</p>
<h3 id="tohtml"><a class="header-anchor" href="#tohtml">#</a>toHTML</h3>
<p>这个就是把<code>VNode</code>转化成真正的DOM元素。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// 大体分3步</span></div><div class="line"><span class="comment">//</span></div><div class="line"></div><div class="line"><span class="comment">// Step 1: createElement</span></div><div class="line"><span class="keyword">const</span> node = <span class="built_in">document</span>.createElement(type)</div><div class="line"></div><div class="line"><span class="comment">// Step 2: set props</span></div><div class="line"><span class="built_in">Object</span>.keys(props).forEach(prop =&gt; &#123;</div><div class="line">  node.setAttribute(prop, props[prop])</div><div class="line">&#125;)</div><div class="line"></div><div class="line"><span class="comment">// Step 3: set children</span></div><div class="line">children.forEach(VChild =&gt; &#123;</div><div class="line">  <span class="keyword">let</span> childNode</div><div class="line"></div><div class="line">  <span class="comment">// if text</span></div><div class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> VChild === <span class="string">'string'</span>) &#123;  <span class="comment">// #0</span></div><div class="line">    childNode = <span class="built_in">document</span>.createTextNode(VChild)</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    childNode = createNode(VChild)</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  node.appendChild(childNode)</div><div class="line">&#125;)</div><div class="line"></div><div class="line"><span class="keyword">return</span> node</div></pre></td></tr></table></figure>
<p>在<code>#0</code>中，如果当前node是<code>string</code>的话，就表明是<code>text</code>。否则进行递归。</p>
<h3 id="diff"><a class="header-anchor" href="#diff">#</a>Diff</h3>
<p><code>diff</code>需要把新的Virtual DOM和旧的进行比较，从而得到变化的地方。<br>
这个过程最难的了。我没用实现React的diff算法，只是对同级元素进行了比较而已。</p>
<p>主要有不同的4种情况:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="keyword">const</span> TEXT = <span class="string">'TEXT'</span></div><div class="line"><span class="keyword">export</span> <span class="keyword">const</span> PROPS = <span class="string">'PROPS'</span></div><div class="line"><span class="keyword">export</span> <span class="keyword">const</span> REPLACE = <span class="string">'REPLACE'</span></div><div class="line"><span class="keyword">export</span> <span class="keyword">const</span> ADD_CHILD = <span class="string">'ADD_CHILD'</span></div></pre></td></tr></table></figure>
<ul>
<li><code>TEXT</code>: 替换旧的<code>text</code></li>
<li><code>PROPS</code>: 表明<code>props</code>可能是增加，删除或修改</li>
<li><code>REPLACE</code>: 替换旧的节点，包括删除的</li>
<li><code>ADD_CHILD</code>: 表示需要增加child</li>
</ul>
<p>实现过程不讲述，详细看源代码(<a href="https://github.com/DrakeLeung/little-virtual-DOM/blob/master/src%2Fdiff.js" target="_blank" rel="external">diff</a>)</p>
<h3 id="patch"><a class="header-anchor" href="#patch">#</a>Patch</h3>
<p>这个过程把上个步骤得到的<code>diff</code>来给当前的DOM节点进行操作。这个过程就是我们优化DOM操作的地方。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> applyPatch = (node, currentPatch) =&gt; &#123;</div><div class="line">  <span class="keyword">switch</span> (currentPatch.type) &#123;</div><div class="line">    <span class="keyword">case</span> patchType.TEXT:</div><div class="line">      node.nodeValue = currentPatch.content</div><div class="line">      <span class="keyword">break</span></div><div class="line"></div><div class="line">    <span class="keyword">case</span> patchType.PROPS:</div><div class="line">      setProps(node, currentPatch.props)</div><div class="line">      <span class="keyword">break</span></div><div class="line"></div><div class="line">    <span class="keyword">case</span> patchType.REPLACE:</div><div class="line">      <span class="keyword">if</span> (isExist(currentPatch.node)) &#123;</div><div class="line">        node.parentNode.replaceChild(toHTML(currentPatch.node), node)</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        node.parentNode.removeChild(node)</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">break</span></div><div class="line"></div><div class="line">    <span class="keyword">case</span> patchType.ADD_CHILD:</div><div class="line">      node.appendChild(toHTML(currentPatch.node))</div><div class="line">      <span class="keyword">break</span></div><div class="line"></div><div class="line">    <span class="keyword">default</span>:</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="wrap-up"><a class="header-anchor" href="#wrap-up">#</a>Wrap up</h2>
<p>从实现这个简单的Virtual DOM，思路确实是打开了不少。</p>
<ul>
<li>用JavaScript对象来表示DOM元素。之前只会直接操作DOM，没有想到可以这样玩。</li>
<li>怎么比较2棵树的不同？只需要比较同级的元素。虽然还是不会比较children</li>
<li>复习了DOM的一些知识。</li>
</ul>
<p>所以<strong>多尝试</strong>不同的东西，思路会扩展不少~</p>
<h2 id="resource"><a class="header-anchor" href="#resource">#</a>Resource</h2>
<ul>
<li><a href="https://gist.github.com/sebmarkbage/fcb1b6ab493b0c77d589" target="_blank" rel="external">React (Virtual) DOM Terminology</a></li>
<li><a href="https://gcanti.github.io/2014/10/29/understanding-react-and-reimplementing-it-from-scratch-part-1.html" target="_blank" rel="external">Understanding-react-and-reimplementing-it-from-scratch-part-1</a></li>
<li><a href="https://www.zhihu.com/question/29504639" target="_blank" rel="external">怎么更好地理解虚拟DOM</a></li>
<li><a href="https://github.com/livoras/blog/issues/13" target="_blank" rel="external">如何实现一个Virtual DOM算法</a></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;最近实现了一个简单版的&lt;a href=&quot;https://github.com/DrakeLeung/little-virtual-DOM&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Virtual DOM&lt;/a&gt;。&lt;br&gt;
之所以简单，是因为并没有实现R
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>从零开始编写一个Hexo主题</title>
    <link href="http://drakeleung.github.io/blog/2016/01/27/Write-a-Hexo-Theme-From-Strach/"/>
    <id>http://drakeleung.github.io/blog/2016/01/27/Write-a-Hexo-Theme-From-Strach/</id>
    <published>2016-01-27T14:23:29.000Z</published>
    <updated>2016-09-08T05:01:57.000Z</updated>
    
    <content type="html"><![CDATA[<p>之前我也不会写，但是当我了解以下东西的时候，就可以从零开始写一个Hexo主题了。</p>

<ul>
<li>NodeJS / NPM</li>
<li>模板引擎(Template Engine)，比如EJS, Jade，Handlebars等等都可以</li>
<li>HTML / CSS / JavaScript</li>
<li>阅读Hexo的<a href="https://hexo.io/docs/" target="_blank" rel="external">文档</a></li>
<li>阅读Hexo默认主题<a href="https://github.com/hexojs/hexo-theme-landscape" target="_blank" rel="external">landscape</a>的源码</li>
</ul>
<p>以上正是一名Web前端人员需要了解和掌握的东西。<br>
<strong>不过，不会前端也不要紧，我告诉你以下的东西就足够了。</strong></p>
<h2 id="nodejs-npm"><a class="header-anchor" href="#nodejs-npm">#</a>NodeJS / NPM</h2>
<p>首先，Hexo是由NodeJS来编写的。编写一个应用是需要第三方包(依赖/库)，这个就是我们的<code>package.json</code>文件的由来。这些package怎么下载的呢？答案就是通过<a href="https://www.npmjs.com/" target="_blank" rel="external">NPM</a>(Node Package Manager)，然后他们都会安装在<code>node_modules/</code>这个文件夹里面。</p>
<p>OK，这就是我们需要知道的NodeJS和NPM的知识。</p>
<h2 id="hexo的workflow"><a class="header-anchor" href="#hexo的workflow">#</a>Hexo的Workflow</h2>
<p><strong>下面是重点。</strong></p>
<p>Hexo会读取根目录下的<code>_config.yml</code>里面的<code>theme</code>属性, 从而采用对应的主题。而主题都是放在<code>themes/</code>目录下面的，然后你会发现他里面有个<code>landscape</code>的目录，这个就是默认主题啦。</p>

<p>接着，我们查看<code>themes/landscape/</code>目录，以及根据文档<a href="https://hexo.io/docs/themes.html" target="_blank" rel="external">docs-themes</a>，我们很容易得出：一个主题其实由4部分组成。</p>
<ul>
<li><code>_config.yml</code>: 主题的配置文件</li>
<li><code>source/</code>: 放我们的CSS文件以及图片</li>
<li><code>layout/</code>: 模板文件</li>
<li><code>scripts</code>: 放JavaScript文件，他们会自动加载</li>
</ul>
<p>然后，根据文档<a href="https://hexo.io/docs/templates.html" target="_blank" rel="external">docs-templates</a>，不难得出：</p>
<p>每次当我们在浏览器访问时，Hexo都会去解析<code>sources</code>目录下对应的模板文件。不同的URL对应不同的文件，所以才有了不同的页面。那么，我们怎么知道哪个URL对应哪个页面呢？(下面我们以<code>EJS</code>为例)</p>
<p>无论URL是什么，Hexo先读取<code>layout.ejs</code>，然后里面的<a href="https://github.com/hexojs/hexo-theme-landscape/blob/master/layout%2Flayout.ejs" target="_blank" rel="external">body</a>变量会替换成以下内容：(<em>Fallback</em>的意思是如果访问<code>/archives</code>时，我们的<code>archives.ejs</code>不存在的话，就会返回<code>index.ejs</code>)</p>
<table>
<thead>
<tr>
<th>URL</th>
<th>Template</th>
<th>Fallback</th>
</tr>
</thead>
<tbody>
<tr>
<td>/</td>
<td>index.ejs</td>
<td></td>
</tr>
<tr>
<td>/archives</td>
<td>archive.ejs</td>
<td>index.ejs</td>
</tr>
<tr>
<td>文章</td>
<td>post.ejs</td>
<td>index.ejs</td>
</tr>
</tbody>
</table>
<p>如下图所示:</p>

<p>或者，可以先尝试一下没有<code>layout.ejs</code>的情况，因为比较简单。也就是，访问<code>/</code>，Hexo就返回<code>index.ejs</code>里面的东西给你。访问<code>/archives</code>就返回<code>archive.ejs</code>。</p>
<h2 id="模板文件"><a class="header-anchor" href="#模板文件">#</a>模板文件</h2>
<p>那么，接下来就要编写我们的模板文件了。怎么写呢？<br>
比如我的根目录想显示所有的文章？我们就要使用Hexo提供的<a href="https://hexo.io/docs/variables.html" target="_blank" rel="external">变量</a>了。通过文档，我们可以得出<code>page.posts</code>这个变量就包含了所有的文章。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">%</span> <span class="attr">page.posts.each</span>(<span class="attr">function</span>(<span class="attr">post</span>)&#123; %&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">article</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span> post.title <span class="tag">&lt;/<span class="name">h1</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span> post.content <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">article</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">%</span> &#125;) %&gt;</span></div></pre></td></tr></table></figure>
<p>编写模板文件的时候，我们可能利用Hexo内置的一些<a href="https://hexo.io/docs/helpers.html" target="_blank" rel="external">helper</a>来方便开发，比如分页使用<a href="https://hexo.io/docs/helpers.html#paginator" target="_blank" rel="external">paginator</a>，路径处理使用<a href="https://hexo.io/docs/helpers.html#url_for" target="_blank" rel="external">url_for</a>等。</p>
<h2 id="样式"><a class="header-anchor" href="#样式">#</a>样式</h2>
<p>我们的CSS文件是放在<code>source</code>里面的，然后要怎么加载呢？这个时候，我们就需要在模板文件里面引入，比如我们的首页需要<code>app.css</code>，那么就在<code>index.ejs</code>里面引用就行了。如果每个页面都用到的话，就放在<code>layout.ejs</code>。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">%-</span> <span class="attr">css</span>('<span class="attr">path</span>/<span class="attr">to</span>/<span class="attr">app</span>') %&gt;</span></div></pre></td></tr></table></figure>
<p>当然，你也可以使用预处理器来写样式，比如Sass，Stylus等等。此时，你就要下载对应的package来解释成CSS。比如，我使用的是Sass，那么我就要<code>npm i --save hexo-renderer-sass</code>来把<code>.scss</code>文件解释成<code>.css</code>文件。</p>
<h2 id="总结一下"><a class="header-anchor" href="#总结一下">#</a>总结一下</h2>
<p>如果遇到问题的话，查看Hexo默认主题<a href="https://github.com/hexojs/hexo-theme-landscape" target="_blank" rel="external">landscape</a>的源码以及<a href="https://hexo.io/docs/" target="_blank" rel="external">文档</a>就能解决了。<br>
最后卖下广告，这是我写的主题：<a href="https://github.com/DrakeLeung/hexo-theme-again" target="_blank" rel="external">hexo-theme-again</a>。</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;之前我也不会写，但是当我了解以下东西的时候，就可以从零开始写一个Hexo主题了。&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;NodeJS / NPM&lt;/li&gt;
&lt;li&gt;模板引擎(Template Engine)，比如EJS, Jade，Handlebars等等都可以&lt;/li&gt;
&lt;li&gt;H
    
    </summary>
    
    
      <category term="hexo" scheme="http://drakeleung.github.io/blog/tags/hexo/"/>
    
      <category term="theme" scheme="http://drakeleung.github.io/blog/tags/theme/"/>
    
  </entry>
  
  <entry>
    <title>5 Ways To Make A Sticky Footer</title>
    <link href="http://drakeleung.github.io/blog/2016/01/20/5-Ways-to-Make-a-Sticky-Footer/"/>
    <id>http://drakeleung.github.io/blog/2016/01/20/5-Ways-to-Make-a-Sticky-Footer/</id>
    <published>2016-01-20T07:19:06.000Z</published>
    <updated>2016-09-08T05:01:57.000Z</updated>
    
    <content type="html"><![CDATA[<p><em>Sticky Footer</em>在内容展示的网站都会用到。比如blog，xx的主页等等。</p>
<h2 id="what-is-sticky-footer"><a class="header-anchor" href="#what-is-sticky-footer">#</a>What is Sticky Footer</h2>
<p>为了简单起见，我们不妨假设我们的<code>index.html</code>是这样的:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Ways to make a sticky foote<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">main</span>&gt;</span><span class="tag">&lt;/<span class="name">main</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">footer</span>&gt;</span><span class="tag">&lt;/<span class="name">footer</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure>
<p>那么，如下面的图所示，图<code>a</code>和<code>b</code>都不是<em>Sticky Footer</em>.</p>
<p><img src="http://ww2.sinaimg.cn/large/7f85b91egw1f0asb7siypj20go088q4x.jpg" alt=""></p>
<p>因为图<code>a</code>的页脚的后面还有空白部分。我们想要的应该是页脚就是在页面的最底部。</p>
<p>那么图<code>b</code>为什么不是呢？他不是在页面的最底部吗？没错，但是我们想要的是只有当<strong>scroller bar</strong>滑到最底部的时候，才会出现页脚。</p>
<p>像下面的图<code>c</code>和<code>d</code>才是我们的<em>Sticky Footer</em>:<br>
<img src="http://ww2.sinaimg.cn/large/7f85b91egw1f0asq75p07j20gl09i0vh.jpg" alt=""></p>
<h2 id="ways-to-sticky-footer"><a class="header-anchor" href="#ways-to-sticky-footer">#</a>Ways to Sticky Footer</h2>
<p>废话少说，下面会介绍几种创建<em>Sticky Footer</em>的方法。</p>
<p>我们会从最简单的方法开始，但最简单的不一定是最好的，符合自己的使用场景才是最好的。最后总结每种方法的优缺点。</p>
<p>(P.S. 假设我们都使用上面的<code>index.html</code>所示结构)</p>
<h3 id="flexbox"><a class="header-anchor" href="#flexbox">#</a>Flexbox</h3>
<p><em><a href="https://philipwalton.github.io/solved-by-flexbox/demos/sticky-footer/" target="_blank" rel="external">方法来源</a></em></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* #0 */</span></div><div class="line"><span class="selector-tag">body</span> &#123;</div><div class="line">  <span class="attribute">display</span>: flex;</div><div class="line">  <span class="attribute">flex-direction</span>: column;</div><div class="line">  <span class="attribute">min-height</span>: <span class="number">100vh</span>;</div><div class="line">  <span class="attribute">margin</span>: <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/* #1 */</span></div><div class="line"><span class="selector-tag">main</span> &#123;</div><div class="line">  <span class="attribute">flex</span>: <span class="number">1</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>#0</code>是中的<code>min-height: 100vh</code>是为了让<code>&lt;main&gt;</code>的高度没有大于屏幕的高度时，使得<code>footer</code>可以在页面的底部。而，<code>margin: 0</code>是去掉原本浏览器自带的<code>&lt;body&gt;</code>的样式。</p>
<p><code>#1</code>的<code>flex: 1</code>是为了让<code>&lt;main&gt;</code>占满多余的空间。</p>
<h3 id="modern-way"><a class="header-anchor" href="#modern-way">#</a>Modern Way</h3>
<p><em><a href="http://mystrd.at/modern-clean-css-sticky-footer/" target="_blank" rel="external">方法来源</a></em></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* #0 */</span></div><div class="line"><span class="selector-tag">html</span> &#123;</div><div class="line">  <span class="attribute">position</span>: relative;</div><div class="line">  <span class="attribute">min-height</span>: <span class="number">100%</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/* #1 */</span></div><div class="line"><span class="selector-tag">body</span> &#123;</div><div class="line">  <span class="attribute">margin</span>: <span class="number">0</span>;</div><div class="line">  <span class="attribute">margin-bottom</span>: <span class="number">100px</span>; <span class="comment">/* same to footer height */</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/* #2 */</span></div><div class="line"><span class="selector-tag">footer</span> &#123;</div><div class="line">  <span class="attribute">position</span>: absolute;</div><div class="line">  <span class="attribute">left</span>: <span class="number">0</span>;</div><div class="line">  <span class="attribute">bottom</span>: <span class="number">0</span>;</div><div class="line">  <span class="attribute">height</span>: <span class="number">100px</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>#0</code>中的<code>position: relative</code>很显然是为了让<code>&lt;html&gt;</code>变成<em>containning block</em>，<br>
这个在<code>#2</code>会说到。同样地，<code>min-height: 100%</code>和上面的<em>flexbox</em>方法中的<code>#0</code>一样。</p>
<p><code>#1</code>的<code>margin-bottom</code>设为<code>100px</code>是和<code>&lt;footer&gt;</code>的高度一样的。目的是当<code>&lt;body&gt;</code>的内容溢出<br>
的时候，防止<code>&lt;footer&gt;</code>的内容蹿到<code>&lt;body&gt;</code>里面。</p>
<p><code>#2</code>设置了<code>position: absolute</code>，这样，<code>left</code>和<code>bottom</code>的值都是相对于<code>&lt;footer&gt;</code>的<em>containning block</em>来说的。<br>
由于在<code>#0</code>设置了<code>&lt;html&gt;</code>的<code>position</code>为<code>relative</code>，所以<code>&lt;html&gt;</code>就是<code>&lt;footer&gt;</code>的<em>containning block</em>。</p>
<h3 id="table-way"><a class="header-anchor" href="#table-way">#</a>Table Way</h3>
<p><em><a href="http://codepen.io/anon/pen/zrRLVW" target="_blank" rel="external">方法来源</a>或者<a href="https://gist.github.com/goldsky/7322156" target="_blank" rel="external">这个</a></em></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">html</span>,</div><div class="line"><span class="selector-tag">body</span> &#123;</div><div class="line">  <span class="attribute">height</span>: <span class="number">100%</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="selector-tag">body</span> &#123;</div><div class="line">  <span class="attribute">margin</span>: <span class="number">0</span>;</div><div class="line">  <span class="attribute">display</span>: table; <span class="comment">/* #0 */</span></div><div class="line">&#125;</div><div class="line"><span class="selector-tag">main</span>,</div><div class="line"><span class="selector-tag">footer</span> &#123;</div><div class="line">  <span class="attribute">display</span>: table-row;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/* #1</span></div><div class="line">main &#123;</div><div class="line">  height: 100%;</div><div class="line">&#125;</div><div class="line">*/</div><div class="line"></div><div class="line"><span class="selector-tag">footer</span> &#123;</div><div class="line">  <span class="attribute">height</span>: <span class="number">1px</span>; <span class="comment">/* #2 */</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其实这个方法就是利用了<code>table</code>布局，然后设置<code>&lt;footer&gt;</code>的高度为<code>1px</code>(如<code>#2</code>所示)。但是我并不知道为什么。<br>
并且，如果我把<code>#2</code>注释掉，把<code>#1</code>的注释去掉，也是work的。所以不知道设置<code>1px</code>有什么用。</p>
<h3 id="old-way"><a class="header-anchor" href="#old-way">#</a>Old Way</h3>
<p><em><a href="http://ryanfait.com/resources/footer-stick-to-bottom-of-page/" target="_blank" rel="external">方法来源</a></em></p>
<p>这种方法需要我们改变一下我们的<code>index.html</code>，给我们的<code>&lt;main&gt;</code>添加一个空白的<code>&lt;div&gt;</code>。<br>
他其实是<code>&lt;footer&gt;</code>的<em>placeholder</em>。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Ways to make a sticky foote<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">main</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"push"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span> <span class="comment">&lt;!-- new --&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">main</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">footer</span>&gt;</span><span class="tag">&lt;/<span class="name">footer</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure>
<p>那么，对应的CSS是这样的：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">html</span>, <span class="selector-tag">body</span> &#123;</div><div class="line">  <span class="attribute">height</span>: <span class="number">100%</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="selector-tag">body</span> &#123;</div><div class="line">  <span class="attribute">margin</span>: <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="selector-tag">main</span> &#123;</div><div class="line">  <span class="attribute">min-height</span>: <span class="number">100%</span>;</div><div class="line">  <span class="attribute">margin-bottom</span>: -<span class="number">100px</span>; <span class="comment">/* #0 */</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="selector-tag">footer</span>,</div><div class="line"><span class="selector-class">.push</span> &#123;</div><div class="line">  <span class="attribute">height</span>: <span class="number">100px</span>; <span class="comment">/* #1 */</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>#0</code>给<code>&lt;main&gt;</code>设置了<code>margin-bottom: -100px</code>。这是<code>&lt;footer&gt;</code>的高度的相反数。<br>
他是为了让<code>&lt;footer&gt;</code>可以蹿到<code>&lt;div class=&quot;push&quot;&gt;&lt;/div&gt;</code>的位置。</p>
<p>因为<code>.push</code>就是<code>&lt;footer&gt;</code>的placeholder, 显然他们的<code>height</code>必须是一样的，如<code>#1</code>所示。</p>
<p>其实我们还可以使用为了<code>:after</code>改进一下。因为<code>.push</code>存在的意义只是为了样式而样式，并不是页面的结构，所以也没有必要出现在<code>index.html</code>里面。因此，我们有了下面的<em>Old Way Plus</em>。</p>
<h3 id="old-way-plus"><a class="header-anchor" href="#old-way-plus">#</a>Old Way Plus</h3>
<p><em><a href="https://css-tricks.com/snippets/css/sticky-footer/" target="_blank" rel="external">方法来源</a></em></p>
<p>(注意，这个时候我们并不需要给<code>&lt;main&gt;</code>添加一个<code>&lt;div class=&quot;push&quot;&gt;&lt;/div&gt;</code>)</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">html</span>, <span class="selector-tag">body</span> &#123;</div><div class="line">  <span class="attribute">height</span>: <span class="number">100%</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="selector-tag">main</span> &#123;</div><div class="line">  <span class="attribute">min-height</span>: <span class="number">100%</span>;</div><div class="line">  <span class="comment">/* equal to footer height */</span></div><div class="line">  <span class="attribute">margin-bottom</span>: -<span class="number">100px</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/* #0 */</span></div><div class="line"><span class="selector-tag">main</span><span class="selector-pseudo">:after</span> &#123;</div><div class="line">  <span class="attribute">content</span>: <span class="string">""</span>;</div><div class="line">  <span class="attribute">display</span>: block;</div><div class="line">  <span class="attribute">height</span>: <span class="number">100px</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="selector-tag">footer</span> &#123;</div><div class="line">  <span class="attribute">height</span>: <span class="number">100px</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>#0</code>, 我们利用伪类<code>:after</code>来替代上面的<em>Old Way</em>的<code>.push</code>，这样就不需要给<code>index.html</code><br>
添加不必要的标签。</p>
<h2 id="to-sum-up"><a class="header-anchor" href="#to-sum-up">#</a>To Sum Up</h2>
<table>
<thead>
<tr>
<th>方法</th>
<th>难度</th>
<th>Footer需要固定高度</th>
<th>浏览器兼容</th>
</tr>
</thead>
<tbody>
<tr>
<td>Flexbox</td>
<td>+</td>
<td>No</td>
<td>+</td>
</tr>
<tr>
<td>Modern way</td>
<td>++</td>
<td>Yes</td>
<td>+++</td>
</tr>
<tr>
<td>Table way</td>
<td>++</td>
<td>No</td>
<td>++?</td>
</tr>
<tr>
<td>Old way</td>
<td>+++</td>
<td>Yes</td>
<td>+++</td>
</tr>
<tr>
<td>Old way Plus</td>
<td>++</td>
<td>Yes</td>
<td>++</td>
</tr>
</tbody>
</table>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;em&gt;Sticky Footer&lt;/em&gt;在内容展示的网站都会用到。比如blog，xx的主页等等。&lt;/p&gt;
&lt;h2 id=&quot;what-is-sticky-footer&quot;&gt;&lt;a class=&quot;header-anchor&quot; href=&quot;#what-is-sticky-foot
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>BFC in CSS(0) - WTF</title>
    <link href="http://drakeleung.github.io/blog/2015/07/25/BFC-in-CSS-0-WTF/"/>
    <id>http://drakeleung.github.io/blog/2015/07/25/BFC-in-CSS-0-WTF/</id>
    <published>2015-07-24T17:21:40.000Z</published>
    <updated>2016-09-08T05:01:57.000Z</updated>
    
    <content type="html"><![CDATA[<p>看了<a href="http://www.sitepoint.com/understanding-block-formatting-contexts-in-css/" target="_blank" rel="external">Understanding Block Formatting Contexts in CSS</a>这篇文章，终于有点明白什么是BFC(Block Formatting Context)了。</p>
<h2 id="normal-flow"><a class="header-anchor" href="#normal-flow">#</a>Normal Flow</h2>
<p><strong>下面这句话不要忽略啊。要不然很多事情就想不通</strong>。</p>
<blockquote>
<p>Boxes in the normal flow belong to a formatting context, which may be block or inline, but not both simultaneously. Block-level boxes participate in a block formatting context. Inline-level boxes participate in an inline formatting context.</p>
</blockquote>
<p>在normal flow中的盒子都是属于formatting context的！！什么意思？</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span> I am in the formatting context<span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span> I also belong to the formatting context<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div></pre></td></tr></table></figure>
<p>在上面的例子，<code>p</code>和<code>div</code>都是在<em>normal flow</em>里面的。并且，他们都是块级元素，所以他们参与了block formatting contexts。</p>
<p>那么，参与了BFC又会怎么样呢？</p>
<h2 id="block-formatting-contexts"><a class="header-anchor" href="#block-formatting-contexts">#</a>Block Formatting Contexts</h2>
<p>下面的<a href="http://www.w3.org/TR/CSS21/visuren.html#block-formatting" target="_blank" rel="external">文档</a>定义了<em>在BFC中盒子是怎么排版的</em>:</p>
<blockquote>
<p>In a block formatting context, boxes are laid out one after the other, vertically, beginning at the top of a containing block. The vertical distance between two sibling boxes is determined by the ‘margin’ properties. Vertical margins between adjacent block-level boxes in a block formatting context collapse.</p>
</blockquote>
<p>在BFC中，盒子都是按垂直方向一个挨着一个排版的，从<em>containing block</em>的顶部开始。2个sibing boxed的<br>
垂直方向的距离是由<code>margin</code>来决定的，但此时的2个盒子的<code>margin</code>是会<strong>collapse</strong>(坍塌？折叠？)</p>
<p>那到底是怎么collapse法，我们要怎样才能解决。</p>
<h2 id="bfc引起的collapse-margins"><a class="header-anchor" href="#bfc引起的collapse-margins">#</a>BFC引起的Collapse Margins</h2>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="css"></span></div><div class="line">  <span class="selector-tag">p</span> &#123;</div><div class="line">    <span class="attribute">margin</span>: <span class="number">10px</span>;</div><div class="line">    <span class="attribute">background-color</span>: lightgreen;</div><div class="line">  &#125;</div><div class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span> Sibling 1 <span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span> Sibling 2 <span class="tag">&lt;/<span class="name">p</span>&gt;</span></div></pre></td></tr></table></figure>
<p>上面的例子中，2个<code>p</code>的之间的<code>margin</code>只有<code>10px</code>而不是<code>20px(10 + 10)</code>。为什么？因为前面说过，</p>
<p>2个<code>p</code>都是在<em>normal flow</em>中，并且，他们是块级元素，所以他们会参与block formatting contexts。</p>
<p>又因为在BFC中，2个sibling element的垂直方面的<code>margin</code>会collapse！于是，结果取2者较大的那个。</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">P</span><span class="selector-pseudo">:last-child</span> &#123;</div><div class="line">  <span class="attribute">margin</span>: <span class="number">20px</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样一来，2个<code>p</code>垂直方向的<code>margin</code>就取<code>20</code>。因为20比10大。</p>
<p>那么，我们如何解决margin collapse呢？答案就是<strong>创建一个新的bfc</strong>。</p>
<p>为什么可以？因为前面的文档说过: <em>In a block formatting…<em>才会发生margin collapse。<br>
也就是说，如果</em></em>不在同一个bfc**的话，那么就不会有margin collapse。因此，我们创建新的bfc就行了。</p>
<p>那么，怎样才能创建新的bfc呢？</p>
<h2 id="create-a-new-bfc"><a class="header-anchor" href="#create-a-new-bfc">#</a>Create a New BFC</h2>
<blockquote>
<p>Floats, absolutely positioned elements, block containers (such as inline-blocks, table-cells, and table-captions) that are not block boxes, and block boxes with ‘overflow’ other than ‘visible’ (except when that value has been propagated to the viewport) establish new block formatting contexts for their contents.</p>
</blockquote>
<p>通过上面的<a href="http://www.w3.org/TR/CSS21/visuren.html#block-formatting" target="_blank" rel="external">文档</a>，我们可以总结出以下的情况会创建出新的BFC:</p>
<ul>
<li><code>float</code>的值不为<code>none</code></li>
<li><code>position</code>的值不为<code>static</code>或者<code>relative</code>。</li>
<li><code>display</code>的值为<code>table-cell</code>, <code>table-caption</code>, <code>inline-block</code></li>
<li><code>overflow</code>的值不为<code>visible</code>。</li>
</ul>
<p>举个例子:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="css"></span></div><div class="line">  <span class="selector-class">.newBFC</span> &#123;</div><div class="line">    <span class="attribute">overflow</span>: hidden;</div><div class="line">  &#125;</div><div class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"newBFC"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span>I am in the BFC created by my parent tag<span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure>
<p>上面例子中的<code>div</code>就创建了一个新的bfc。</p>
<p>所以，我们就可以解决margin collapse:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="css"></span></div><div class="line">  <span class="selector-tag">p</span> &#123;</div><div class="line">    <span class="attribute">margin</span>: <span class="number">10px</span>;</div><div class="line">    <span class="attribute">background-color</span>: lightgreen;</div><div class="line">  &#125;</div><div class="line">  <span class="selector-class">.newBFC</span> &#123;</div><div class="line">    <span class="attribute">overflow</span>: hidden;</div><div class="line">  &#125;</div><div class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span> Sibling 1 <span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"newBFC"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span> Sibling 2 <span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure>
<h2 id="wrap-up"><a class="header-anchor" href="#wrap-up">#</a>Wrap up</h2>
<p>总的来说，BFC就是定义了块级元素是如何排版的。</p>
<p>另外，创建新的BFC可以解决一些问题。比如上面的<em>margin collapse</em>，还有更多的例子，我们下篇再说。</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;看了&lt;a href=&quot;http://www.sitepoint.com/understanding-block-formatting-contexts-in-css/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Understanding Block F
    
    </summary>
    
      <category term="CSS" scheme="http://drakeleung.github.io/blog/categories/CSS/"/>
    
    
      <category term="BFC" scheme="http://drakeleung.github.io/blog/tags/BFC/"/>
    
  </entry>
  
  <entry>
    <title>Scope(3)-What Is Closure</title>
    <link href="http://drakeleung.github.io/blog/2015/07/19/Scope-3-What-Is-Closure/"/>
    <id>http://drakeleung.github.io/blog/2015/07/19/Scope-3-What-Is-Closure/</id>
    <published>2015-07-18T17:58:31.000Z</published>
    <updated>2016-09-08T05:01:57.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="what-is-closure"><a class="header-anchor" href="#what-is-closure">#</a>What is Closure</h2>
<p>什么是闭包呢？我们来下个定义吧。</p>
<blockquote>
<p>闭包就是函数可以访问他的lexical scope，即使他是在他的lexical scope外面执行的。</p>
</blockquote>
<p>先看个例子压压惊。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> x = <span class="number">42</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">bar</span> (<span class="params"></span>) </span>&#123;</div><div class="line">      <span class="built_in">console</span>.log(x);</div><div class="line">    &#125;</div><div class="line">    bar();</div><div class="line">&#125;</div><div class="line"></div><div class="line">foo(); <span class="comment">// 42</span></div></pre></td></tr></table></figure>
<p>很自然而然地，上面例子输出的结果就是<code>42</code>。为什么呢？这其实就是作用域链的问题而已。<br>
<code>bar</code>函数要引用到<code>x</code>这个变量的值。于是就在自己的作用域找，找不到。于是向上找，然后在<code>foo</code>函数的作用域就找到了。</p>
<p>很显然，上面的例子是符合我们对闭包定义的前半部分，<strong>但是后半部分是不符合的</strong>。因为<code>bar</code>的lexical scope就是<code>foo</code>的作用域，而<code>bar</code>就是在<code>foo</code>的作用域里面被调用的。</p>
<h2 id="how-it-works"><a class="header-anchor" href="#how-it-works">#</a>How it Works</h2>
<p>既然这样，我们就想办法让<code>bar</code>在<code>foo</code>的作用域外面执行。比如使用<code>return</code>.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> x = <span class="number">42</span>;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">bar</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(x);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> bar;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> baz = foo();</div><div class="line">baz();</div></pre></td></tr></table></figure>
<p>在上面的例子中，其实<code>baz</code>就是<code>bar</code>，只是名字换了而已，内容还是没有改变的。那么好，现在，<code>bar</code>(也就是<code>baz</code>)并不是在他的lexical scope(<code>foo</code>'s scope)被调用，而是在global scope。并且，<code>bar</code>还可以访问他的lexical scope里面的<code>x</code>。所以，你可以说，<strong>这就是闭包</strong>。</p>
<p>我们再来看1个例子:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">baz</span>(<span class="params">fn</span>) </span>&#123;</div><div class="line">  fn();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> x = <span class="number">42</span>;</div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">bar</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(x);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  baz(bar);</div><div class="line">&#125;</div><div class="line"></div><div class="line">foo();</div></pre></td></tr></table></figure>
<p>同样地，上面的例子中，<code>bar</code>并没有在他的lexical scope(<code>foo</code>'s scope)中执行，而在是<code>baz</code>里面执行。并且，<code>bar</code>还是可以访问他的lexical scope。因此，这个也是闭包！</p>
<h2 id="more-examples"><a class="header-anchor" href="#more-examples">#</a>More Examples</h2>
<p>其实，闭包到处都是~</p>
<p>比如，一个定时器。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">wait</span>(<span class="params">msg</span>) </span>&#123;</div><div class="line">  setTimeout(<span class="function"><span class="keyword">function</span> <span class="title">timer</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(msg);</div><div class="line">  &#125;, <span class="number">2</span> * <span class="number">1000</span>);</div><div class="line">&#125;</div><div class="line">wait(<span class="string">'I am also a closure example'</span>);</div></pre></td></tr></table></figure>
<p>2秒钟之后，浏览器引擎就会在全局中调用<code>timer</code>函数。也就是说，<code>timer</code>并没有在他的lexical scope(<code>wait</code>'s scope)里面执行，但是他仍然可以访问<code>msg</code>。所以，这个也是一个闭包。</p>
<p>再比如，一个Event Handler.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">submit</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> username = <span class="string">'Drake'</span>,</div><div class="line">    submitBtn = <span class="built_in">document</span>.querySelector(<span class="string">'button[type=submit]'</span>);</div><div class="line"></div><div class="line">  submitBtn.addEventListener(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(username);</div><div class="line">  &#125;, <span class="literal">false</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="loops-and-closure"><a class="header-anchor" href="#loops-and-closure">#</a>Loops and Closure</h2>
<p>当闭包出现在循环中的时候，就会很容易出现问题。举个例子，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</div><div class="line">  setTimeout(<span class="function"><span class="keyword">function</span> <span class="title">timer</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(i);</div><div class="line">  &#125;, <span class="number">1000</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面例子中，很出乎意料地输出了5个<code>5</code>。为什么呢？原因在于:</p>
<ol>
<li>在第一个<code>timer</code>函数执行之前，已经有5个<code>timer</code>函数定义好了。</li>
<li>当第一个<code>timer</code>执行时，他需要引用到<code>i</code>。</li>
<li>首先他在自己的作用域找，找不到。</li>
<li>于是向上找，因为JavaScript并没有block scope。所以向上的话就是global scope.</li>
<li>在global scope里面找到了<code>i</code>。此时<code>i</code>为<code>5</code>（因为已经循环了5次)</li>
</ol>
<p>是不是觉得少了点什么？如果<code>timer</code>在自己的作用域就可以找到<code>i</code>的话就好咯。或者，在中间加多一层作用域，而不用去到<code>global scope</code>里面找（因为他的<code>i</code>一定是为<code>5</code>的)</p>
<h3 id="solution"><a class="header-anchor" href="#solution">#</a>Solution</h3>
<p>第一种，<code>timer</code>在自己的作用域就可以找到<code>i</code>。可以利用<code>forEach</code>等循环方法。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> aArray = [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>, <span class="string">'e'</span>];</div><div class="line"></div><div class="line">aArray.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">item, index, array</span>) </span>&#123;</div><div class="line">  setTimeout(<span class="function"><span class="keyword">function</span> <span class="title">timer</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(index);</div><div class="line">  &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>第二种，在中间新增一层作用域。常用的pattern就是使用IIFE。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</div><div class="line">  (<span class="function"><span class="keyword">function</span>(<span class="params">j</span>) </span>&#123;</div><div class="line">    setTimeout(<span class="function"><span class="keyword">function</span> <span class="title">timer</span>(<span class="params"></span>) </span>&#123;</div><div class="line">      <span class="built_in">console</span>.log(j);</div><div class="line">    &#125;);</div><div class="line">  &#125;)(i);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>由于IIFE是立即调用的，所以每次调用的时候都传进了不同的实参。</p>
<ol>
<li>当<code>timer</code>要引用<code>i</code>的时候，现在自己的作用域里面找。找不到。</li>
<li>然后向上找，在IIFE里面找到了，也就是形参<code>j</code>。</li>
</ol>
<p>第三种利用<code>let</code>来创建block scope.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</div><div class="line">  setTimeout(<span class="function"><span class="keyword">function</span> <span class="title">timer</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(i);</div><div class="line">  &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>let</code>劫持了<code>for</code>的作用域。每次循环，都会初始化一个新的<code>i</code>。</p>
<p><code>timer</code>在自己的作用域找不到<code>i</code>,向上找，在<code>for</code>里面找，哈，找到了。</p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;what-is-closure&quot;&gt;&lt;a class=&quot;header-anchor&quot; href=&quot;#what-is-closure&quot;&gt;#&lt;/a&gt;What is Closure&lt;/h2&gt;
&lt;p&gt;什么是闭包呢？我们来下个定义吧。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;
    
    </summary>
    
      <category term="JavaScript" scheme="http://drakeleung.github.io/blog/categories/JavaScript/"/>
    
    
      <category term="scope" scheme="http://drakeleung.github.io/blog/tags/scope/"/>
    
      <category term="closure" scheme="http://drakeleung.github.io/blog/tags/closure/"/>
    
  </entry>
  
</feed>
