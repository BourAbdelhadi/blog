<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>让我们一起来学习 RxJS | lyyourc</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="stylesheet" href="/css/app.css">
  <!-- <link rel='stylesheet' href='http://fonts.useso.com/css?family=Source+Code+Pro'> -->
</head>

<body>
  <nav class="app-nav">
  
    
      <a href="/.">home</a>
    
  
    
      <a href="/archives">archive</a>
    
  
    
      <a href="/atom.xml">rss</a>
    
  
</nav>

  <main class="post">
  <article>
  <h1 class="article-title">
    <a href="/2016/09/21/Let-Us-Learn-RxJS/">让我们一起来学习 RxJS</a>
  </h1>

  <section class="article-meta">
    <p class="article-date">September 21 2016</p>
  </section>

  <section class="article-entry">
    <p>这是一篇 RxJS 初学者教程。</p>
<h2 id="what-is-rxjs"><a class="header-anchor" href="#what-is-rxjs">#</a>What Is RxJS</h2>
<p>通过<strong>阅读<a href="http://reactivex.io/rxjs/manual/overview.html" target="_blank" rel="external">官方文档</a></strong>，不难得出：RxJS 可以很好<strong>解决异步和事件组合的问题</strong>。</p>
<p>这个时候我就有疑问了，异步问题不是用 Promise ( async/await ) 就好了吗？<br>
至于事件，配合框架 ( React, Vue, Angular2 等 ) 的话不也很容易解决吗？<img class="emoji" draggable="false" alt="😮" src="https://twemoji.maxcdn.com/2/72x72/1f62e.png"></p>
<p>不管怎样, 让我们先看个 Hello World 吧。(我要看 <a href="http://jsbin.com/suguho/edit?js,output" target="_blank" rel="external">DEMO</a> )</p>
<h3 id="rx-s-hello-world"><a class="header-anchor" href="#rx-s-hello-world">#</a>Rx’s Hello World</h3>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// auto-complete</span></div><div class="line"><span class="keyword">const</span> Observable = Rx.Observable</div><div class="line"><span class="keyword">const</span> input = <span class="built_in">document</span>.querySelector(<span class="string">'input'</span>)</div><div class="line"></div><div class="line"><span class="keyword">const</span> search$ = Observable.fromEvent(input, <span class="string">'input'</span>)</div><div class="line">  .map(e =&gt; e.target.value)</div><div class="line">  .filter(value =&gt; value.length &gt;= <span class="number">1</span>)</div><div class="line">  .throttleTime(<span class="number">100</span>)</div><div class="line">  .distinctUntilChanged()</div><div class="line">  .switchMap(term =&gt; Observable.fromPromise(wikiIt(term)))</div><div class="line">  .subscribe(</div><div class="line">    x =&gt; renderSearchResult(x),</div><div class="line">    err =&gt; <span class="built_in">console</span>.error(err)</div><div class="line">  )</div></pre></td></tr></table></figure>
<p>上面的代码做了以下事情：</p>
<ul>
<li>监听 <code>input</code> 元素的 <code>input</code> 事件</li>
<li>一旦发生，把事件对象 <code>e</code> 映射成 <code>input</code> 元素的值</li>
<li>接着过滤掉值长度小于 <code>1</code> 的</li>
<li>并且还设置了一个 <code>throttle</code> (节流器)，两次输入间隔不超过 <code>100</code> 毫秒为有效输入</li>
<li>如果该值和过去最新的值相等的话，忽略他</li>
<li>最后，拿到值便调用 Wikipedia 的一个 API</li>
<li>最后的最后，需要 <code>subscribe</code> 才能拿到 API 返回的数据</li>
</ul>
<p>是不是看起来就觉得很 cool ，好想学！<img class="emoji" draggable="false" alt="😚" src="https://twemoji.maxcdn.com/2/72x72/1f61a.png"><br>
短短几行代码就完成了一个 auto-complete 组件。</p>
<h2 id="how-it-works"><a class="header-anchor" href="#how-it-works">#</a>How It Works</h2>
<p>那上面的代码是什么意思？<br>
RxJS 到底是如何工作的？如何解决异步组合问题的？</p>
<h3 id="observable"><a class="header-anchor" href="#observable">#</a>Observable</h3>
<p>Rx 提供了一种叫 <strong>Observable</strong> 的数据类型，兼容 ECMAScript 的 <a href="https://github.com/zenparsing/es-observable" target="_blank" rel="external">Observable Spec Proposal</a> 草案标准。他是 Rx 最核心的数据类型，结合了 <a href="https://en.wikipedia.org/wiki/Observer_pattern" target="_blank" rel="external">Observer Pattern</a>，<a href="https://en.wikipedia.org/wiki/Iterator_pattern" target="_blank" rel="external">Iterator Pattern</a> 。</p>
<p>那到底什么是 Observable ？</p>
<blockquote>
<p>Observable 其实就是一个<strong>异步的数组</strong>。<em>( ===&gt; <a href="https://medium.com/@andrestaltz/2-minute-introduction-to-rx-24c8ca793877#.1q1q2mwgq" target="_blank" rel="external">2 minute introduction to rx</a> )</em></p>
</blockquote>
<p>不妨想像一下，<img class="emoji" draggable="false" alt="⭐" src="https://twemoji.maxcdn.com/2/72x72/2b50.png"> <strong>数组 + 时间轴 == Observable</strong> <img class="emoji" draggable="false" alt="⭐" src="https://twemoji.maxcdn.com/2/72x72/2b50.png"> 。</p>
<p>数组元素的值是未来某个时间点 <em>emit</em> (产生)的，但是我们并不关心这个时间点，因为利用了「观察者模式」<em>subscribe</em> (订阅)了这个数组，只要他 <em>emit</em> 了值，就会自动 <em>push</em> 给我们。</p>
<p>我们再用图来表示一下的话：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">--a---b-c--d-----e--|--&gt;</div></pre></td></tr></table></figure>
<p>这种图叫做 <a href="http://reactivex.io/rxjs/manual/overview.html#marble-diagrams" target="_blank" rel="external">marble diagram</a> 。<br>
我们可以把 ASCII 的 marble 图转成 SVG 的：<a href="https://jsbin.com/vumepol/1/edit?js,output" target="_blank" rel="external">ASCII -&gt; SVG</a> 。</p>
<p><code>-</code> 表示时间轴，<code>a</code> ~ <code>e</code> 表示 emit 的值，<code>|</code> 则表示这个 stream 已经结束了。<br>
比方说，<code>click</code> 事件用上图来表示：<code>a</code> 表示第 1 次点击，<code>b</code> 表示第 2 次点击，如此类推。</p>
<p>如果你觉得 Observable 这个名字不够形象不够 cool 的话，你可把他叫做 <a href="https://gist.github.com/staltz/868e7e9bc2a7b8c1f754#reactive-programming-is-programming-with-asynchronous-data-streams" target="_blank" rel="external">stream</a> ，因为他的 marble 图就像 steam 一样。所以啊，下面我都会把 <em>Observable</em> 称作 <em>stream</em> 。<img class="emoji" draggable="false" alt="✌️" src="https://twemoji.maxcdn.com/2/72x72/270c.png"></p>
<h3 id="operators"><a class="header-anchor" href="#operators">#</a>Operators</h3>
<p>那么，我们怎么对 stream 进行操作呢？怎么把多个 stream 组合在一起呢？</p>
<p>我们前面不是说了「 Observable 其实就是<em>异步数组</em>」吗？在 JavaScript 里的数组不是有很多内置的方法吗？比如 <code>map</code>, <code>filter</code>, <code>reduce</code> 等等。类似地，Observable 也有自己的方法，也就是所谓的 <a href="http://reactivex.io/rxjs/manual/overview.html#operators" target="_blank" rel="external">operator</a> 。比如上面 <a href="#rx-s-hello-world">Rx’s Hello World</a> 例子中的 <code>map</code>, <code>filter</code>, <code>throttleTime</code>, <code>distinctUntilChanged</code> 等等很多很有用的 operator 。</p>
<p>面对 RxJS 那么多 operator ，我们要怎么学习呢？很简单：<img class="emoji" draggable="false" alt="😀" src="https://twemoji.maxcdn.com/2/72x72/1f600.png"></p>
<blockquote>
<p><a href="http://reactivex.io/rxjs/manual/overview.html#categories-of-operators" target="_blank" rel="external">分类别</a> + <a href="http://reactivex.io/rxjs/manual/overview.html#marble-diagrams" target="_blank" rel="external">画 marble 图</a> + <a href="https://www.learnrxjs.io/operators/" target="_blank" rel="external">看例子</a> + <a href="http://reactivex.io/rxjs/manual/overview.html#choose-an-operator" target="_blank" rel="external">选</a></p>
</blockquote>
<p>现在，就让我们画出上面 Hello World 例子的 marble 图。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> search$ = Observable.fromEvent(input, <span class="string">'input'</span>)</div><div class="line">  .map(e =&gt; e.target.value)</div><div class="line">  .filter(value =&gt; value.length &gt;= <span class="number">1</span>)</div><div class="line">  .throttleTime(<span class="number">100</span>)</div><div class="line">  .distinctUntilChanged()</div><div class="line">  .switchMap(term =&gt; Observable.fromPromise(wikiIt(term)))</div><div class="line">  .subscribe(</div><div class="line">    x =&gt; renderSearchResult(x),</div><div class="line">    err =&gt; <span class="built_in">console</span>.error(err)</div><div class="line">  )</div></pre></td></tr></table></figure>
<p>假设输入了 5 次，每次输入的值一次为：<code>a</code>, <code>ab</code>, <code>c</code>, <code>d</code>, <code>c</code> ，并且第 3 次输入的 <code>c</code> 和第 4 次的 <code>d</code> 的时间间隔少于 <code>100ms</code> ：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">---i--i---i-i-----i---|--&gt; (input)</div><div class="line">        map</div><div class="line"></div><div class="line">---a--a---c-d-----c---|--&gt;</div><div class="line">      b</div><div class="line">        filter</div><div class="line"></div><div class="line">---a--a---c-d-----c---|--&gt;</div><div class="line">      b</div><div class="line">      throttleTime</div><div class="line"></div><div class="line">---a--a---c-------c---|--&gt;</div><div class="line">      b</div><div class="line">  distinctUntilChanged</div><div class="line"></div><div class="line">---a--a---c----------|--&gt;</div><div class="line">      b</div><div class="line">    switchMap</div><div class="line"></div><div class="line">---x--y---z----------|--&gt;</div></pre></td></tr></table></figure>
<p>如果我告诉你学习 <strong>RxJS 的捷径是「学会看和画 marble 图」</strong>，你信还是不信？<img class="emoji" draggable="false" alt="😱" src="https://twemoji.maxcdn.com/2/72x72/1f631.png"></p>
<h2 id="learn-by-doing"><a class="header-anchor" href="#learn-by-doing">#</a>Learn By Doing</h2>
<p>现在，就让我们结合上面的知识，来实现一个简单的 canvas 画板。</p>
<p>根据 canvas 的 <a href="http://devdocs.io/dom/canvasrenderingcontext2d/moveto" target="_blank" rel="external">API</a> ，我们需要知道两个点的坐标，这样才能画出一条线。</p>
<h3 id="step-1"><a class="header-anchor" href="#step-1">#</a>Step 1</h3>
<p><em>(我要看 <a href="https://jsfiddle.net/DrakeLeung/a7h4wwcy/" target="_blank" rel="external">DEMO</a> )</em></p>
<p>那么，现在我们需要做的是<strong>创建</strong>一个关于鼠标移动的 stream 。于是，我们<strong>去文档找对应的 operator 类别</strong>，也就是 <a href="http://jsbin.com/gakosun/edit?js,console,output" target="_blank" rel="external">Creation Operators</a> ，然后得到  <a href="http://reactivex.io/rxjs/class/es6/Observable.js~Observable.html#static-method-fromEvent" target="_blank" rel="external">fromEvent</a> 。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> canvas = <span class="built_in">document</span>.querySelector(<span class="string">'canvas'</span>)</div><div class="line"></div><div class="line"><span class="keyword">const</span> move$ = Rx.Observable.fromEvent(canvas, <span class="string">'mousemove'</span>)</div></pre></td></tr></table></figure>
<p>对应的 marble 图：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">--m1---m1-m2--m3----m4---|--&gt;  (mousemove)</div></pre></td></tr></table></figure>
<p>接着，我们需要拿到每次鼠标移动时的坐标。也就是说：需要<strong>变换</strong> stream 。<br>
对应类别的 operator 文档：<a href="http://reactivex.io/rxjs/manual/overview.html#transformation-operators" target="_blank" rel="external">Transformation Operators</a> ===&gt; <a href="http://reactivex.io/rxjs/class/es6/Observable.js~Observable.html#instance-method-map" target="_blank" rel="external">map</a> 。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> move$ = Rx.Observable.fromEvent(canvas, <span class="string">'mousemove'</span>)</div><div class="line">  .map(e =&gt; (&#123; x: e.offsetX, y: e.offsetX &#125;))</div></pre></td></tr></table></figure>
<p>此时的 marble 图：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">--m1---m2-m3--m4----m5---|--&gt;  (mousemove)</div><div class="line">        map</div><div class="line">--x1---x2-x3--x4----x5---|--&gt;  (点坐标)</div></pre></td></tr></table></figure>
<p>然后，怎么拿到两个点的坐标呢？我们需要再<strong>变换</strong>一下 stream 。<br>
对应类别的 operator 文档：<a href="http://reactivex.io/rxjs/manual/overview.html#transformation-operators" target="_blank" rel="external">Transformation Operators</a> ===&gt; <a href="http://reactivex.io/rxjs/class/es6/Observable.js~Observable.html#instance-method-bufferCount" target="_blank" rel="external">bufferCount</a> 。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> move$ = Rx.Observable.fromEvent(canvas, <span class="string">'mousemove'</span>)</div><div class="line">  .map(e =&gt; (&#123; x: e.offsetX, y: e.offsetY &#125;))</div><div class="line">  .bufferCount(<span class="number">2</span>)</div></pre></td></tr></table></figure>
<p>marble 图：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">--m1---m2-m3--m4----m5---|--&gt;  (mousemove)</div><div class="line">        map</div><div class="line"></div><div class="line">--x1---x2-x3--x4----x5---|--&gt;  (点坐标)</div><div class="line">      bufferCount(2)</div><div class="line"></div><div class="line">-------x1-----x3----x5---|---&gt; (两点坐标)</div><div class="line">       x2     x4</div></pre></td></tr></table></figure>
<p>然后你会发现，此时画出来的<a href="https://jsfiddle.net/DrakeLeung/a7h4wwcy/" target="_blank" rel="external">线段是不连续的</a>。为什么？我也不知道！！<br>
那就让我们看看别人是怎么写的吧：<a href="https://github.com/Reactive-Extensions/RxJS/blob/master/examples/canvaspaint/canvaspaint.js" target="_blank" rel="external">canvas paint</a> 。</p>
<h3 id="step-2"><a class="header-anchor" href="#step-2">#</a>Step 2</h3>
<p><em>(我要看 <a href="https://jsfiddle.net/DrakeLeung/vj368qy7/1/" target="_blank" rel="external">DEMO</a> )</em></p>
<p>换了一种思路，并没有<strong>变换</strong> stream ，而是把两个 stream <strong>组合</strong>在一起。<br>
查看文档  <a href="http://reactivex.io/rxjs/manual/overview.html#combination-operators" target="_blank" rel="external">Combination Operators</a> ===&gt; <a href="http://reactivex.io/rxjs/class/es6/Observable.js~Observable.html#static-method-zip" target="_blank" rel="external">zip</a> 。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> move$ = Rx.Observable.fromEvent(canvas, <span class="string">'mousemove'</span>)</div><div class="line">  .map(e =&gt; (&#123; x: e.offsetX, y: e.offsetY &#125;))</div><div class="line"></div><div class="line"><span class="keyword">const</span> diff$ = move$</div><div class="line">  .zip(move$.skip(<span class="number">1</span>), (first, sec) =&gt; ([ first, sec ]))</div></pre></td></tr></table></figure>
<p>此时的 marble 图：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">--x1---x2-x3--x4----x5---|--&gt;  (move$)</div><div class="line">        skip(1)</div><div class="line">-------x2-x3--x4----x5---|--&gt;  </div><div class="line"></div><div class="line"></div><div class="line">--x1---x2-x3--x4----x5---|--&gt;  (move$)</div><div class="line">-------x2-x3--x4----x5---|--&gt;  </div><div class="line">        zip</div><div class="line"></div><div class="line">-------x1-x2--x3----x4---|--&gt;  (diff$)</div><div class="line">       x2 x3  x4    x5</div></pre></td></tr></table></figure>
<p>这样一来，<code>diff$</code> emit 的值就依次为 <code>(x1, x2)</code>, <code>(x2, x3)</code>，<code>(x3, x4)</code> ……<br>
现在，鼠标移动的时候，就可以<a href="https://jsfiddle.net/DrakeLeung/vj368qy7/1/" target="_blank" rel="external">画出美丽的线条</a>。</p>
<h3 id="step-3"><a class="header-anchor" href="#step-3">#</a>Step 3</h3>
<p><em>(我要看 <a href="https://jsfiddle.net/DrakeLeung/vj368qy7/2/" target="_blank" rel="external">DEMO</a> )</em></p>
<p>就在此时我恍然大悟，终于知道前面用 <code>bufferCount</code> 为什么不行了。我们不妨来比较一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">-------x1-----x3----x5---|---&gt; (bufferCount)</div><div class="line">       x2     x4</div><div class="line"></div><div class="line">-------x1-x2--x3----x4---|--&gt;  (diff$)</div><div class="line">       x2 x3  x4    x5</div></pre></td></tr></table></figure>
<p><code>bufferCount</code> emit 的值依次为：<code>(x1, x2)</code>， <code>(x3, x4)</code> …… <code>x2</code> 和 <code>x3</code> 之间是有间隔的。这就是为什么线段会不连续的原因。</p>
<p>然后看 <a href="http://reactivex.io/rxjs/class/es6/Observable.js~Observable.html#instance-method-bufferCount" target="_blank" rel="external">bufferCount</a> 文档的话，你会发现<strong>可以使用 <code>bufferCount(2, 1)</code> 实现同样的效果</strong>。这样的话，我们就不需要使用 <code>zip</code> 来组合两个 stream 了。Cool ~ <img class="emoji" draggable="false" alt="😎" src="https://twemoji.maxcdn.com/2/72x72/1f60e.png"></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> move$ = Rx.Observable.fromEvent(canvas, <span class="string">'mousemove'</span>)</div><div class="line">  .map(e =&gt; (&#123; x: e.offsetX, y: e.offsetX &#125;))</div><div class="line">  .bufferCount(<span class="number">2</span>, <span class="number">1</span>)</div></pre></td></tr></table></figure>
<p>此时的 marble 图：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">--m1---m2-m3--m4----m5---|--&gt;  (mousemove)</div><div class="line">        map</div><div class="line"></div><div class="line">--x1---x2-x3--x4----x5---|--&gt;  (点坐标)</div><div class="line">      bufferCount(2, 1)</div><div class="line"></div><div class="line">-------x1-x2--x3----x4---|---&gt; (两点坐标)</div><div class="line">       x2 x3  x4    x5</div></pre></td></tr></table></figure>
<h2 id="step-4"><a class="header-anchor" href="#step-4">#</a>Step 4</h2>
<p><em>(我要看 <a href="https://jsfiddle.net/DrakeLeung/vj368qy7/3/" target="_blank" rel="external">DEMO</a> )</em></p>
<p>接下来，我们想实现「只有鼠标按下时，才能画画，否则不能」。<br>
首先我们需要<strong>创建</strong>两个关于鼠标动作的 stream 。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> down$ = Rx.Observable.fromEvent(canvas, <span class="string">'mousedown'</span>)</div><div class="line"><span class="keyword">const</span> up$ = Rx.Observable.fromEvent(canvas, <span class="string">'mouseup'</span>)</div></pre></td></tr></table></figure>
<p>当鼠标按下的时候，我们需要把他<strong>变换</strong>成鼠标移动的 stream ，直到鼠标放开。<br>
查看文档  <a href="http://reactivex.io/rxjs/manual/overview.html#transformation-operators" target="_blank" rel="external">Transformation Operators</a> ===&gt; <a href="http://reactivex.io/rxjs/class/es6/Observable.js~Observable.html#instance-method-switchMapTo" target="_blank" rel="external">switchMapTo</a> 。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">down$.switchMapTo(move$)</div></pre></td></tr></table></figure>
<p>此时的 marble 图：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">--d---d-d-----d---d--|--&gt;  (mousedown)</div><div class="line">      switchMapTo</div><div class="line"></div><div class="line">--m---m-m-----m---m--|--&gt;</div></pre></td></tr></table></figure>
<p>此时，鼠标放开了我们还能继续画画，这显然不是我们想要的。这个时候我们很容易会使用 <a href="http://reactivex.io/rxjs/class/es6/Observable.js~Observable.html#instance-method-takeUntil" target="_blank" rel="external">takeUntil</a> 这个 operator ，但是这是不对的，因为他会把 <em>stream</em> complete 掉。</p>
<p>还是让我们看看别人是怎么写的吧：<a href="https://github.com/Reactive-Extensions/RxJS/blob/master/examples/canvaspaint/canvaspaint.js" target="_blank" rel="external">canvas paint</a> 。</p>
<h3 id="step-5"><a class="header-anchor" href="#step-5">#</a>Step 5</h3>
<p><em>(我要看 <a href="https://jsfiddle.net/DrakeLeung/vj368qy7/4/" target="_blank" rel="external">DEMO</a> )</em></p>
<p>思路是这个样子的：</p>
<p>把 <code>up$</code> 和 <code>down$</code> <strong>组合</strong>成一个新的 stream ，但为了分辨他们，我们需要先把他们<strong>变换</strong>成新的 stream 。查看文档 <a href="http://reactivex.io/rxjs/manual/overview.html#combination-operators" target="_blank" rel="external">Combination Operators</a> ===&gt; <a href="http://reactivex.io/rxjs/class/es6/Observable.js~Observable.html#instance-method-merge" target="_blank" rel="external">merge</a> 。<br>
<a href="http://reactivex.io/rxjs/manual/overview.html#transformation-operators" target="_blank" rel="external">Transformation Operators</a> ===&gt; <a href="http://reactivex.io/rxjs/class/es6/Observable.js~Observable.html#instance-method-map" target="_blank" rel="external">map</a> 。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> down$ = Rx.Observable.fromEvent(canvas, <span class="string">'mousedown'</span>)</div><div class="line">  .map(() =&gt; <span class="string">'down'</span>)</div><div class="line"><span class="keyword">const</span> up$ = Rx.Observable.fromEvent(canvas, <span class="string">'mouseup'</span>)</div><div class="line">  .map(() =&gt; <span class="string">'up'</span>)</div><div class="line"></div><div class="line"><span class="keyword">const</span> upAndDown$ = up$.merge(down$)</div></pre></td></tr></table></figure>
<p>再来看看他们的 marble 图：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">--d--d-d----d--d---|--&gt;  (down$)</div><div class="line">----u---u-u------u-|--&gt;  (up$)</div><div class="line">      merge</div><div class="line"></div><div class="line">--d-ud-du-u-d--d-u-|--&gt;  (upAndDown$)</div></pre></td></tr></table></figure>
<p>此时，我们再<strong>变换</strong> <code>upAndDown$</code> 。如果是 <code>down</code> 的话，则变换成 <code>move$</code> ，否则变换成一个空的 stream 。</p>
<p>查看文档 <a href="http://reactivex.io/rxjs/manual/overview.html#categories-of-operators" target="_blank" rel="external">Creation Operators</a> ===&gt; <a href="http://reactivex.io/rxjs/class/es6/Observable.js~Observable.html#static-method-empty" target="_blank" rel="external">empty</a> 。<br>
<a href="http://reactivex.io/rxjs/manual/overview.html#transformation-operators" target="_blank" rel="external">Transformation Operators</a> ===&gt; <a href="http://reactivex.io/rxjs/class/es6/Observable.js~Observable.html#instance-method-switchMap" target="_blank" rel="external">switchMap</a> 。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">upAndDown$</div><div class="line">  .switchMap(action =&gt;</div><div class="line">    action === <span class="string">'down'</span> ? move$ : Rx.Observable.empty()</div><div class="line">  )</div></pre></td></tr></table></figure>
<p>你要的 marble 图：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">--d-ud-du-u-d--d-u-|--&gt;  (upAndDown$)</div><div class="line">    switchMap</div><div class="line"></div><div class="line">--m-em-me-e-m--m-e-|--&gt;</div></pre></td></tr></table></figure>
<p>其实这个 canvas 画板不用 RxJS 实现也不会很难。但是当我们把他扩展成一个「你画我猜」之后，用 RxJS 处理异步就会变得简单起来。比如，添加新的工具栏 ( 调色板，撤销…… ) ，即时通信 ( 同步画板，聊天 ) …… <img class="emoji" draggable="false" alt="😂" src="https://twemoji.maxcdn.com/2/72x72/1f602.png"></p>
<p>另外，如果你想边学习 RxJS 边实现一些小东西的话：</p>
<ul>
<li><a href="https://github.com/staltz/rxjs-training" target="_blank" rel="external">staltz - rxjs training</a></li>
<li><a href="https://gist.github.com/staltz/868e7e9bc2a7b8c1f754" target="_blank" rel="external">GitHub - Who to Follow</a></li>
<li><a href="https://github.com/Reactive-Extensions/RxJS/tree/master/examples" target="_blank" rel="external">RxJS 4.x Example</a></li>
<li><a href="https://github.com/JayKan/RxJS-Playground" target="_blank" rel="external">RxJs Playground</a></li>
<li><a href="https://github.com/channikhabra/yarr" target="_blank" rel="external">Yet Another RSS Reader</a></li>
<li><a href="https://medium.com/front-end-hacking/rx-ifying-a-chat-room-built-with-reactjs-and-socket-io-459156b7d7ab#.bw55b1xqj" target="_blank" rel="external">rx-ifying a chat room built with reactjs and socket io</a></li>
<li><a href="https://github.com/hdjirdeh/angular2-hn" target="_blank" rel="external">angular2-hacknews</a></li>
</ul>
<h2 id="production"><a class="header-anchor" href="#production">#</a>Production</h2>
<p>怎么把 RxJS 应用到实际生产的 web 应用当中呢？<br>
怎么结合到当前流行的框架当中呢？</p>
<h3 id="vue"><a class="header-anchor" href="#vue">#</a>Vue</h3>
<p>你可以直接在各种 <a href="http://vuejs.org/api/#Options-Lifecycle-Hooks" target="_blank" rel="external">Lifecycle Hooks</a> 中使用 RxJS 。</p>
<p>比如 <code>created</code> 的时候初始化一个 Observable ，<code>beforeDestroy</code> 时就取消订阅 Observable 。(查看<a href="http://jsbin.com/cafodu/edit?html,js,output" target="_blank" rel="external"> DEMO </a>)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> Vue(&#123;</div><div class="line">  el: <span class="string">'#app'</span>,</div><div class="line">  data: &#123;</div><div class="line">    time: <span class="string">''</span></div><div class="line">  &#125;,</div><div class="line">  </div><div class="line">  created () &#123;</div><div class="line">    <span class="keyword">this</span>.timer$ = Rx.Observable.interval(<span class="number">1000</span>)</div><div class="line">      .map(() =&gt; <span class="keyword">new</span> <span class="built_in">Date</span>())</div><div class="line">      .map(d =&gt; moment(d).format(<span class="string">'hh:mm:ss'</span>))</div><div class="line">      .subscribe(t =&gt; &#123;</div><div class="line">        <span class="keyword">this</span>.time = t</div><div class="line">      &#125;)</div><div class="line">  &#125;,</div><div class="line">  </div><div class="line">  beforeDestroy () &#123;</div><div class="line">    <span class="keyword">this</span>.timer$.unsubscribe()</div><div class="line">  &#125;</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>其实已经有对应的插件 <a href="https://github.com/vuejs/vue-rx" target="_blank" rel="external">vue-rx</a> 帮我们干了上面的 dirty work 。他会分别在 <code>init</code> 和 <code>beforeDestroy</code> 的时候自动地订阅和取消订阅 Observable ：<a href="https://github.com/vuejs/vue-rx/blob/master/vue-rx.js#L22-L51" target="_blank" rel="external">Vue.js + RxJS binding mixin in 20 lines</a> 。</p>
<p>因此，我们可以直接把一个 Observable 写到 <code>data</code> 中：<a href="https://github.com/vuejs/vue-rx/blob/master/example/example.html#L26-L65" target="_blank" rel="external">vue-rx/example.html</a> 。</p>
<h3 id="react"><a class="header-anchor" href="#react">#</a>React</h3>
<p>类似地，React 也可以在他组件的 <a href="https://facebook.github.io/react/docs/component-specs.html#lifecycle-methods" target="_blank" rel="external">lifecycle hooks</a> 里调用 RxJS：<a href="https://github.com/belfz/fully-reactive-react-example" target="_blank" rel="external">fully-reactive-react</a> 。<br>
也可以使用 <a href="https://github.com/christianalfoni/rxjs-react-component" target="_blank" rel="external">rxjs-react-component</a> 把 Observable 绑定到 <code>state</code> 。<br>
如果你结合 Redux 的话，可以使用这个 <a href="https://github.com/redux-observable/redux-observable" target="_blank" rel="external">redux-oservable</a> 。</p>
<h3 id="angular2"><a class="header-anchor" href="#angular2">#</a>Angular2</h3>
<p>RxJS 已经是 Angular2 的标配，不多说。<br>
更多可查看对应的文档 <a href="https://angular.io/docs/ts/latest/guide/server-communication.html#!#rxjs" target="_blank" rel="external">Angular2 - Server Communication</a> 。</p>
<p>更多关于 RxJS 的集成：<a href="https://github.com/Reactive-Extensions/RxJS/blob/master/examples/community.md" target="_blank" rel="external">RxJS community</a> 。</p>
<h2 id="you-might-not-need-rxjs"><a class="header-anchor" href="#you-might-not-need-rxjs">#</a>You Might Not Need RxJS</h2>
<p>根据 <a href="https://github.com/Reactive-Extensions/RxJS/blob/master/doc/designguidelines/readme.md#21-use-rxjs-for-orchestrating-asynchronous-and-event-based-computations" target="_blank" rel="external">When to Use RxJS</a> ，我们可以知道 RxJS 的适用场景是：</p>
<ul>
<li>多个复杂的异步或者事件组合在一起</li>
<li>处理多个数据序列（有一定顺序）</li>
</ul>
<p>我觉得，如果你没被异步问题困扰的话，那就不要使用 RxJS 吧，因为 Promise 已经能够解决简单的异步问题了。至于 Promise 和 Observable 的区别是什么？<a href="https://www.google.com.hk/search?q=promise+vs+observable" target="_blank" rel="external">Promise VS Observable</a> 。</p>
<p>讲真，<strong>RxJS 在实际生产中适用的业务场景有哪些</strong>？哪些场景是需要多个异步组合在一起的？游戏吗？即时通信？还有一些特殊的业务。是我的写的业务太少了吗？还是我平时写业务的时候，为写而写，没有把他们抽象起来。<img class="emoji" draggable="false" alt="😳" src="https://twemoji.maxcdn.com/2/72x72/1f633.png"></p>
<p>另外，我倒是对 Teambition 关于 RxJS 的思路有点感兴趣：<em><a href="https://github.com/xufei/blog/issues/36#issuecomment-246662343" target="_blank" rel="external">xufei - 数据的关联计算 -&gt; Brooooooklyn 评论</a></em> &amp; <a href="https://github.com/xufei/blog/issues/37" target="_blank" rel="external">xufei - 对当前单页应用的技术栈思考</a>。</p>
<h2 id="summary"><a class="header-anchor" href="#summary">#</a>Summary</h2>
<ul>
<li><img class="emoji" draggable="false" alt="🐳" src="https://twemoji.maxcdn.com/2/72x72/1f433.png"> RxJS 是用来解决异步和事件组合问题</li>
<li><img class="emoji" draggable="false" alt="🏊" src="https://twemoji.maxcdn.com/2/72x72/1f3ca.png"> Observable == <a href="https://medium.com/@andrestaltz/2-minute-introduction-to-rx-24c8ca793877#.1q1q2mwgq" target="_blank" rel="external">异步数组</a> == 数组 + 时间轴 == stream</li>
<li><img class="emoji" draggable="false" alt="♥️" src="https://twemoji.maxcdn.com/2/72x72/2665.png"> Operators ==  <a href="http://reactivex.io/rxjs/manual/overview.html#categories-of-operators" target="_blank" rel="external">分类别</a> + <a href="http://reactivex.io/rxjs/manual/overview.html#marble-diagrams" target="_blank" rel="external">画 marble 图</a> + <a href="https://www.learnrxjs.io/operators/" target="_blank" rel="external">看例子</a> + <a href="http://reactivex.io/rxjs/manual/overview.html#choose-an-operator" target="_blank" rel="external">选</a></li>
<li><img class="emoji" draggable="false" alt="👍" src="https://twemoji.maxcdn.com/2/72x72/1f44d.png"> <strong>更多更详细的更准确的请看<a href="http://reactivex.io/rxjs/" target="_blank" rel="external">文档</a>！</strong></li>
</ul>
<p>让我们一起来学习 RxJS 吧。</p>

  </section>
</article>

  <div class="sharing grid">
  <section class="profile grid-item grid">
    <img class="avatar" src="http://7xrcp8.com1.z0.glb.clouddn.com/avatar.png" alt="avatar" />
    <div class="grid-item">
      <p class="title"> lyyourc </p>
      <p class="subtitle"> You Are The JavaScript In My HTML </p>
    <div>
  </section>

  <section class="share-btns">
    <!-- <p> share it if you like it~ </p> -->
    <a
  class="twitter-share-button"
  data-size="large"
  data-via="DrakeLeung"
  href="https://twitter.com/intent/tweet?text=这是一篇 RxJS 初学者教程。</p>"
>
  Tweet
</a>

<script>
  window.twttr = (function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0],
    t = window.twttr || {};
  if (d.getElementById(id)) return t;
  js = d.createElement(s);
  js.id = id;
  js.src = "https://platform.twitter.com/widgets.js";
  js.async = true;
  fjs.parentNode.insertBefore(js, fjs);

  t._e = [];
  t.ready = function(f) {
    t._e.push(f);
  };

  return t;
}(document, "script", "twitter-wjs"));
</script>

  </section>
</div>


  
    
<section class="article-comment">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

<script>
  var disqus_shortname = 'drakeleung';
  
  var disqus_url = 'http://drakeleung.github.io/blog/2016/09/21/Let-Us-Learn-RxJS/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


  
</main>

</body>
</html>
